<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coding Playground</title>
<meta http-equiv="Cache-Control" content="no-store" />
<style>
/* CSS Variables for consistent theming - Purple Glassmorphism Theme */
:root {
    --text-color: #000000;
    --text-light: #000000;
    --text-muted: #000000;
    --bg-gradient-start: #667eea;
    --bg-gradient-end: #764ba2;
    --card-bg: rgba(255, 255, 255, 1);
    --card-glass: rgba(255, 255, 255, 0.15);
    --border-color: rgba(255, 255, 255, 0.2);
    --primary-color: #667eea;
    --primary-dark: #5568d3;
    --secondary-color: #764ba2;
    --secondary-hover: #613a85;
    --muted-color: #000000;
    --link-color: #667eea;
    --link-hover: #5568d3;
    --input-bg: rgba(255, 255, 255, 1);
    --input-border: #e2e8f0;
    --hover-bg: rgba(255, 255, 255, 0.25);
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
}

/* Reset and base styles */
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", Helvetica, Arial, sans-serif;
    line-height: 1.6;
    color: var(--text-color);
    background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
    min-height: 100vh;
    background-attachment: fixed;
}

/* Layout */
.container {
    max-width: 960px;
    margin: 0 auto;
    padding: 1rem;
}

.container.narrow {
    max-width: 640px;
}

.grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}

.flex-between {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

/* Cards with Glassmorphism */
.card {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--shadow-lg);
    color: var(--text-color);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
}

/* Buttons */
.btn {
    display: inline-block;
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.25rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    font-size: 0.95rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    background: var(--primary-dark);
}

.btn:active {
    transform: translateY(0);
}

.btn.secondary {
    background: rgba(255, 255, 255, 0.9);
    color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.btn.secondary:hover {
    background: rgba(255, 255, 255, 1);
    color: var(--primary-dark);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.btn.disabled {
    pointer-events: none;
    opacity: 0.5;
    transform: none !important;
}

.btn.danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
}

.btn.danger:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
    transform: translateY(-2px);
}

.btn.small {
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    border-radius: 8px;
}

/* Forms */
label {
    display: block;
    margin: 0.75rem 0 0.5rem 0;
    color: var(--text-color);
    font-weight: 600;
    font-size: 0.95rem;
}

input, textarea, select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid var(--input-border);
    border-radius: 12px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

input::placeholder, textarea::placeholder {
    color: var(--muted-color);
}

/* Typography - All text BLACK for readability */
header h1 {
    color: #000000;
    margin: 0;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(255, 255, 255, 0.5);
}

h1, h2, h3, h4, h5, h6 {
    color: #000000 !important;
    margin: 0 0 1rem 0;
    font-weight: 700;
}

h2 {
    font-size: 1.75rem;
}

h3 {
    font-size: 1.25rem;
}

p, span, div, td, th, li, label, a {
    color: #000000 !important;
}

strong {
    color: #000000 !important;
    font-weight: 700;
}

h1 {
    font-size: 2rem;
    font-weight: 700;
}

h2 {
    font-size: 1.5rem;
    font-weight: 600;
}

h3 {
    font-size: 1.25rem;
    font-weight: 600;
}

p, li, small, .muted {
    color: #000000 !important;
}

.small {
    font-size: 0.9rem;
    color: #000000 !important;
}

.muted {
    color: #000000 !important;
    opacity: 1;
}

/* Spacing */
.mt {
    margin-top: 1rem;
}

.mb {
    margin-bottom: 1rem;
}

/* Alerts */
.alert {
    background: rgba(239, 68, 68, 0.15);
    color: #000000 !important;
    border: 2px solid rgba(239, 68, 68, 0.4);
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin: 1rem 0;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-sm);
    font-weight: 600;
}

.alert.success {
    background: rgba(16, 185, 129, 0.15);
    color: #000000 !important;
    border-color: rgba(16, 185, 129, 0.4);
}

.alert.info {
    background: rgba(59, 130, 246, 0.15);
    color: #000000 !important;
    border-color: rgba(59, 130, 246, 0.4);
}

/* Code blocks */
pre.scroll {
    max-height: 300px;
    overflow: auto;
    background: #0b1228;
    border: 1px solid #1e293b;
    padding: 1rem;
    border-radius: 8px;
    color: #e2e8f0;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
}

code {
    background: #1e293b;
    color: #e2e8f0;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
}

/* Tables */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 1rem 0;
    border-radius: 12px;
    overflow: hidden;
}

th, td {
    padding: 1rem 1.25rem;
    text-align: left;
    border-bottom: 1px solid rgba(226, 232, 240, 0.3);
}

th {
    background: rgba(102, 126, 234, 0.1);
    color: var(--text-color);
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

tr:hover td {
    background: rgba(102, 126, 234, 0.05);
}

tr:hover {
    background: #0f172a;
}

/* Navigation */
nav {
    display: flex;
    gap: 1rem;
    align-items: center;
}

nav a {
    color: #94a3b8;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: all 0.2s;
}

nav a:hover {
    background: #1e293b;
    color: #e2e8f0;
}

/* Header */
header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

/* Footer */
footer {
    margin-top: 3rem;
    padding: 2rem 0;
    border-top: 1px solid #1e293b;
    text-align: center;
    color: #64748b;
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Responsive design */
@media (max-width: 768px) {
    .container {
        padding: 0.5rem;
    }
    
    .flex-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    nav {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .grid {
        grid-template-columns: 1fr;
    }
}

/* Test interface specific styles */
.test-interface {
    background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
    min-height: 100vh;
}

.test-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 2px solid #e2e8f0;
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.test-progress {
    background: #e2e8f0;
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.test-progress-bar {
    background: #2563eb;
    height: 100%;
    transition: width 0.3s ease;
}

.question-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1rem 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.difficulty-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.difficulty-easy {
    background: #064e3b;
    color: #6ee7b7;
}

.difficulty-medium {
    background: #92400e;
    color: #fbbf24;
}

.difficulty-hard {
    background: #7f1d1d;
    color: #fca5a5;
}

.difficulty-medium_plus {
    background: #581c87;
    color: #c4b5fd;
}

.code-editor {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 1rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: #1e293b;
    width: 100%;
    min-height: 200px;
    resize: vertical;
}

.output-area {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    min-height: 100px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: #1e293b;
    white-space: pre-wrap;
}

/* Role badges */
.role-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.role-classroom {
    background: #1e3a8a;
    color: #93c5fd;
}

.role-test {
    background: #7c2d12;
    color: #fed7aa;
}

.role-both {
    background: #581c87;
    color: #c4b5fd;
}

/* Password toggle */
.password-container {
    position: relative;
    display: flex;
    align-items: center;
}

.password-toggle {
    position: absolute;
    right: 0.5rem;
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    padding: 0.25rem;
}

.password-toggle:hover {
    color: #e2e8f0;
}

/* University grouping */
.university-section {
    margin: 2rem 0;
}

.university-header {
    background: #1e293b;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 8px 8px 0 0;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.university-table {
    background: #0e1630;
    border: 1px solid #1e293b;
    border-top: none;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
}

/* Countdown timer */
.countdown {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 1.2rem;
    font-weight: 600;
    color: #fbbf24;
    background: #92400e;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    display: inline-block;
}

/* Compiler specific styles */
.compiler-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
}

.compiler-header {
    background: #0e1630;
    border: 1px solid #1e293b;
    border-radius: 12px 12px 0 0;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.compiler-body {
    background: #0b1228;
    border: 1px solid #1e293b;
    border-top: none;
    border-radius: 0 0 12px 12px;
    padding: 1rem;
}

.compiler-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.compiler-output {
    background: #0b1020;
    border: 1px solid #1e293b;
    border-radius: 8px;
    padding: 1rem;
    min-height: 200px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: #e2e8f0;
    white-space: pre-wrap;
    overflow-y: auto;
    max-height: 400px;
}

/* Question Navigation Styles */
.question-navigation {
    margin-bottom: 1rem;
}

.nav-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
}

.nav-btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.nav-btn.active {
    background-color: var(--primary-color);
    color: white;
}

.question-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

/* COMPREHENSIVE TEXT VISIBILITY FIXES */

/* Force all text to be white/visible */
*, *::before, *::after {
    color: var(--text-color) !important;
}

/* Override any inherited colors */
h1, h2, h3, h4, h5, h6 {
    color: var(--text-color) !important;
}

p, span, div, td, th, li, label {
    color: var(--text-color) !important;
}

/* Table visibility fixes */
.table-container table {
    color: var(--text-color) !important;
    background-color: var(--card-bg) !important;
}

.table-container th,
.table-container td {
    color: var(--text-color) !important;
    border-color: var(--border-color) !important;
    background-color: transparent !important;
}

.table-container th {
    background-color: var(--card-bg) !important;
    font-weight: 600;
    color: var(--text-color) !important;
}

.table-container tr:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.05) !important;
}

.table-container tr:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

/* Card content visibility */
.card h2, .card h3, .card h4 {
    color: var(--text-color) !important;
}

.card p, .card span {
    color: var(--text-color) !important;
}

.card div {
    color: var(--text-color) !important;
}

/* Muted text */
.muted {
    color: var(--muted-color) !important;
}

/* Badge visibility */
.badge {
    color: white !important;
    font-weight: 600;
}

.difficulty-easy { background-color: #28a745; }
.difficulty-medium { background-color: #ffc107; color: #000 !important; }
.difficulty-hard { background-color: #dc3545; }

/* Role badge styling */
.role-badge {
    color: white !important;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
}

.role-classroom { background-color: #007bff; }
.role-test { background-color: #6f42c1; }
.role-both { background-color: #fd7e14; }

/* University section styling */
.university-section h3 {
    color: var(--text-color) !important;
    margin-bottom: 1rem;
}

/* Form elements visibility */
input, textarea, select {
    color: var(--text-color) !important;
    background-color: var(--input-bg) !important;
    border-color: var(--border-color) !important;
}

/* Links visibility */
a {
    color: var(--link-color) !important;
}

a:hover {
    color: var(--link-hover) !important;
}

/* Ensure all manage page content is visible */
.manage-page .card {
    background-color: var(--card-bg) !important;
    border-color: var(--border-color) !important;
}

.manage-page .card h2,
.manage-page .card h3,
.manage-page .card h4 {
    color: var(--text-color) !important;
}

.manage-page .card p {
    color: var(--text-color) !important;
}

/* Export button styling */
.export-btn {
    background-color: #28a745 !important;
    color: white !important;
}

.export-btn:hover {
    background-color: #218838 !important;
    color: white !important;
}

/* Pagination styling */
.pagination {
    color: var(--text-color) !important;
}

.pagination span {
    color: var(--text-color) !important;
}

/* Alert styling */
.alert {
    color: var(--text-color) !important;
    background-color: var(--error-color) !important;
}

/* Code blocks */
pre, code {
    color: var(--text-color) !important;
    background-color: var(--input-bg) !important;
}

/* Format boxes */
.format-box, .sample-box {
    color: #000000 !important;
    background-color: #f8fafc !important;
    border: 1px solid #cbd5e1 !important;
    border-radius: 6px;
    padding: 0.75rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
}

/* Password toggle styling */
.password-display {
    font-family: monospace;
    font-weight: bold;
    color: var(--text-color) !important;
}

.btn.tiny {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    margin-left: 0.5rem;
    border-radius: 4px;
}

.btn.tiny:hover {
    transform: scale(1.05);
}

/* Anti-Cheat Warning Modal */
.warning-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    animation: fadeIn 0.3s;
}

.warning-modal-content {
    position: relative;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    margin: 10% auto;
    padding: 2rem;
    border: 2px solid #fca5a5;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(220, 38, 38, 0.5);
    animation: slideIn 0.3s;
}

.warning-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    animation: pulse 1s infinite;
}

.warning-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
}

.warning-message {
    font-size: 1.1rem;
    color: #fca5a5;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.warning-counter {
    font-size: 2rem;
    font-weight: 700;
    color: #fef2f2;
    margin-bottom: 1rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.warning-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.warning-btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.warning-btn-primary {
    background: white;
    color: #dc2626;
}

.warning-btn-primary:hover {
    background: #f3f4f6;
    transform: translateY(-2px);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        transform: translateY(-50px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Warning indicator in header */
.warning-indicator {
    background: #dc2626;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    animation: pulse 2s infinite;
}

/* Inactivity warning */
.inactivity-warning {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #f59e0b;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
    z-index: 9998;
    animation: slideIn 0.3s;
    font-weight: 600;
}

.inactivity-countdown {
    font-size: 1.5rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    margin-top: 0.5rem;
}

/* HERO SECTION STYLING */
.hero-section {
    text-align: center;
    padding: 3rem 0;
    margin-bottom: 2rem;
}

.hero-content h1 {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #60a5fa, #3b82f6, #1d4ed8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-subtitle {
    font-size: 1.2rem;
    color: var(--muted-color);
    max-width: 600px;
    margin: 0 auto;
}

/* LOGIN OPTIONS STYLING */
.login-options {
    margin-top: 2rem;
}

.login-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    max-width: 900px;
    margin: 0 auto;
}

.login-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.login-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
}

.login-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    border-color: #3b82f6;
}

.card-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.login-card h2 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.login-card p {
    color: var(--muted-color);
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.card-features {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.feature {
    background: rgba(59, 130, 246, 0.1);
    color: #60a5fa;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

/* BUTTON STYLING */
.admin-btn, .user-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 12px;
    text-decoration: none;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.admin-btn {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.admin-btn:hover {
    background: linear-gradient(135deg, #1d4ed8, #1e40af);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

.user-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.user-btn:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
}

.admin-btn svg, .user-btn svg {
    transition: transform 0.3s ease;
}

.admin-btn:hover svg, .user-btn:hover svg {
    transform: translateX(3px);
}

/* Question Generator Tabs */
.qgTabBtn {
    padding: 0.5rem 1rem;
    border: none;
    background: none;
    cursor: pointer;
    color: #6b7280;
    font-weight: 500;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.qgTabBtn:hover {
    color: #667eea;
}

.qgTabBtn.active {
    color: #667eea;
    border-bottom-color: #667eea;
    font-weight: 600;
}

/* RESPONSIVE DESIGN */
@media (max-width: 768px) {
    .hero-content h1 {
        font-size: 2rem;
    }
    
    .hero-subtitle {
        font-size: 1rem;
    }
    
    .login-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .login-card {
        padding: 1.5rem;
    }
    
    .card-features {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .feature {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
}

/* ========================================
   UNIFIED LOGIN PAGE STYLES
   ======================================== */

.login-page {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	display: flex;
	align-items: center;
	justify-content: center;
	overflow-y: auto;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-background {
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	overflow: hidden;
	opacity: 0.1;
}

.login-shapes {
	position: relative;
	width: 100%;
	height: 100%;
}

.shape {
	position: absolute;
	border-radius: 50%;
	background: rgba(255, 255, 255, 0.1);
	animation: float 20s infinite ease-in-out;
}

.shape-1 {
	width: 300px;
	height: 300px;
	top: 10%;
	left: 10%;
	animation-delay: 0s;
}

.shape-2 {
	width: 200px;
	height: 200px;
	top: 60%;
	right: 10%;
	animation-delay: 5s;
}

.shape-3 {
	width: 250px;
	height: 250px;
	bottom: 10%;
	left: 40%;
	animation-delay: 10s;
}

@keyframes float {
	0%, 100% { transform: translateY(0) rotate(0deg); }
	33% { transform: translateY(-30px) rotate(120deg); }
	66% { transform: translateY(30px) rotate(240deg); }
}

.login-container {
	position: relative;
	z-index: 1;
	display: flex;
	align-items: center;
	justify-content: center;
	padding: 2rem;
	max-width: 500px;
	width: 100%;
}

.login-box {
	background: #ffffff;
	border-radius: 24px;
	padding: 3rem;
	box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
	width: 100%;
}

.login-header {
	text-align: center;
	margin-bottom: 2.5rem;
}

.login-logo {
	display: flex;
	justify-content: center;
	margin-bottom: 1.5rem;
}

.logo-icon {
	width: 80px;
	height: 80px;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	border-radius: 20px;
	display: flex;
	align-items: center;
	justify-content: center;
	box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
}

.logo-icon svg {
	stroke: #ffffff;
}

.login-title {
	font-size: 2rem;
	font-weight: 700;
	color: #1a202c;
	margin: 0 0 0.5rem 0;
}

.login-subtitle {
	font-size: 1rem;
	color: #718096;
	margin: 0;
}

.login-error {
	display: flex;
	align-items: center;
	gap: 0.75rem;
	padding: 1rem 1.25rem;
	background: #fee;
	border: 1px solid #fcc;
	border-radius: 12px;
	margin-bottom: 1.5rem;
	color: #c53030;
	font-size: 0.95rem;
}

.login-error svg {
	flex-shrink: 0;
	stroke: #c53030;
}

.login-form {
	display: flex;
	flex-direction: column;
	gap: 1.5rem;
}

.form-group {
	display: flex;
	flex-direction: column;
	gap: 0.5rem;
}

.form-label {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	font-weight: 600;
	font-size: 0.95rem;
	color: #2d3748;
}

.form-label svg {
	stroke: #667eea;
}

.form-input {
	width: 100%;
	padding: 0.875rem 1rem;
	font-size: 1rem;
	border: 2px solid #e2e8f0;
	border-radius: 12px;
	background: #f7fafc;
	color: #1a202c;
	transition: all 0.2s ease;
	font-family: inherit;
}

.form-input:focus {
	outline: none;
	border-color: #667eea;
	background: #ffffff;
	box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input::placeholder {
	color: #a0aec0;
}

.login-btn {
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 0.75rem;
	padding: 1rem;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: #ffffff;
	font-size: 1.05rem;
	font-weight: 600;
	border: none;
	border-radius: 12px;
	cursor: pointer;
	transition: all 0.3s ease;
	margin-top: 0.5rem;
	box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.login-btn:hover {
	transform: translateY(-2px);
	box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.login-btn:active {
	transform: translateY(0);
}

.login-btn svg {
	stroke: currentColor;
	transition: transform 0.3s ease;
}

.login-btn:hover svg {
	transform: translateX(4px);
}

.login-footer {
	margin-top: 2rem;
	padding-top: 1.5rem;
	border-top: 1px solid #e2e8f0;
}

.login-info {
	display: flex;
	align-items: flex-start;
	gap: 0.75rem;
	padding: 1rem;
	background: #f7fafc;
	border-radius: 12px;
	font-size: 0.875rem;
	color: #4a5568;
	line-height: 1.5;
}

.login-info svg {
	flex-shrink: 0;
	stroke: #667eea;
	margin-top: 0.125rem;
}

/* Responsive Design */
@media (max-width: 640px) {
	.login-container {
		padding: 1rem;
	}
	
	.login-box {
		padding: 2rem 1.5rem;
		border-radius: 16px;
	}
	
	.login-title {
		font-size: 1.5rem;
	}
}

/* ========================================
   GLOBAL TEXT COLOR OVERRIDE - ALL BLACK
   ======================================== */
body, body * {
    color: #000000 !important;
}

/* Except for white text on buttons */
.btn, .btn * {
    color: #ffffff !important;
}

.btn.secondary, .btn.secondary * {
    color: #667eea !important;
}

/* White text on header background for contrast */
header, header * {
    color: #000000 !important;
}

/* Code blocks can have lighter text */
pre, pre *, code {
    color: #1a202c !important;
}

/* Input placeholders */
::placeholder {
    color: #000000 !important;
    opacity: 0.6;
}

/* ========================================
   LIGHT BACKGROUNDS - BLACK TEXT EVERYWHERE
   ======================================== */
/* All interfaces now use light backgrounds, so black text is naturally readable */

/* Preserve button text colors only */
button, .btn, a.btn {
    color: #ffffff !important;
}

button.secondary, .btn.secondary, a.btn.secondary {
    color: #667eea !important;
}

/* Warning modal with light background */
.warning-modal {
    background: rgba(255, 255, 255, 0.98) !important;
    color: #000000 !important;
}

.warning-modal * {
    color: #000000 !important;
}

.warning-modal h2 {
    color: #dc2626 !important;
}
</style>
</head>
<body>
	<script>
		// App configuration
		const APP_BASE_URL = 'http://3.80.74.243:5000';
		const ADMIN_USERNAME = 'Ayushman';
		const ADMIN_PASSWORD = 'ayushman9277';
	</script>
	{% if view != 'login' %}
	<header class="container flex-between">
		<h1>Coding Playground</h1>
		<nav>
			{% if session.admin_username %}
				<a class="btn" href="/admin/dashboard">Home</a>
				<a class="btn" href="/admin/logout">Admin Logout</a>
			{% elif session.user_username %}
				<a class="btn" href="/home">Home</a>
				<a class="btn" href="/user/logout">User Logout</a>
			{% else %}
				<a class="btn" href="/">Home</a>
			{% endif %}
		</nav>
	</header>
	{% endif %}

	<main class="container">
		{# Unified Login Page #}
		{% if view == 'login' %}
			<div class="login-page">
				<div class="login-background">
					<div class="login-shapes">
						<div class="shape shape-1"></div>
						<div class="shape shape-2"></div>
						<div class="shape shape-3"></div>
				</div>
				</div>
				
				<div class="login-container">
					<div class="login-box">
						<div class="login-header">
							<div class="login-logo">
								<div class="logo-icon">
									<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M16 18l2-2 4 4-4 4-2-2m0-4H8a4 4 0 01-4-4V6"/>
										<circle cx="12" cy="12" r="3"/>
									</svg>
						</div>
							</div>
							<h1 class="login-title">Welcome Back</h1>
							<p class="login-subtitle">Sign in to your Coding Playground account</p>
						</div>
						
						{% if error %}
						<div class="login-error">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<circle cx="12" cy="12" r="10"/>
								<line x1="12" y1="8" x2="12" y2="12"/>
								<line x1="12" y1="16" x2="12.01" y2="16"/>
							</svg>
							<span>{{ error }}</span>
					</div>
						{% endif %}
						
						<form class="login-form" method="post" action="/login">
							<div class="form-group">
								<label for="username" class="form-label">
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
										<circle cx="12" cy="7" r="4"/>
									</svg>
									<span>Username</span>
								</label>
								<input 
									type="text" 
									id="username" 
									name="username" 
									class="form-input" 
									placeholder="Enter your username" 
									required 
									autofocus
									autocomplete="username"
								>
						</div>
							
							<div class="form-group">
								<label for="password" class="form-label">
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
										<path d="M7 11V7a5 5 0 0110 0v4"/>
							</svg>
									<span>Password</span>
								</label>
								<input 
									type="password" 
									id="password" 
									name="password" 
									class="form-input" 
									placeholder="Enter your password" 
									required
									autocomplete="current-password"
								>
					</div>
							
							<button type="submit" class="login-btn">
								<span>Sign In</span>
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<line x1="5" y1="12" x2="19" y2="12"/>
									<polyline points="12 5 19 12 12 19"/>
								</svg>
							</button>
				</form>
					</div>
				</div>
			</div>
		{% endif %}


		{# Admin Dashboard #}
		{% if view == 'admin_dashboard' %}
			<section class="grid">
				<div class="card">
					<h2>Stats</h2>
					<ul class="list">
						<li>Users: <strong>{{ user_count }}</strong></li>
						<li>Classrooms: <strong>{{ classroom_count }}</strong></li>
						<li>Tests: <strong>{{ test_count }}</strong></li>
					</ul>
					<div class="mt">
						<a href="/admin/users" class="btn">Manage Users</a>
						<a href="/admin/users/export" class="btn secondary">Export Users</a>
					</div>
					<div class="mt">
						<a href="/admin/activities" class="btn">Manage Activities</a>
						<a href="/admin/tests" class="btn">Manage Tests</a>
					</div>
					<div class="mt">
						<a href="/admin/submissions" class="btn">📊 View Submissions & Logs</a>
						<a href="/admin/classroom-activities" class="btn secondary">🎯 Try Activities</a>
					</div>
					<div class="mt">
						<a href="/admin/question-generator" class="btn">🧩 Question Generator</a>
						<a href="/admin/questionnaire-management" class="btn secondary">🗂️ Questionnaire Management</a>
					</div>
				</div>
				<div class="card">
					<h2>📂 Create Users via CSV Upload</h2>
					<p class="muted" style="margin-bottom: 1rem;">Upload a CSV file to create multiple users at once</p>
					
					<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #bfdbfe;">
						<p style="margin: 0 0 0.5rem 0; font-weight: 600;">📋 CSV Format Requirements:</p>
						<p style="color: #000000; margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
							<strong>Required:</strong> username, password, university<br>
							<strong>Optional:</strong> role, classroom_id, test_id
						</p>
						<p style="color: #dc2626; margin: 0.75rem 0 0 0; font-size: 0.9rem; font-weight: 600;">
							⚠️ <strong>Important:</strong> Usernames can duplicate, but passwords must be unique!
						</p>
					</div>
					
					<details style="margin-bottom: 1rem;">
						<summary style="cursor: pointer; font-weight: 600; color: #667eea; padding: 0.5rem 0;">📝 Show CSV Example</summary>
						<div style="background: #fef3c7; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border: 1px solid #fbbf24;">
							<pre style="background: #ffffff; padding: 0.75rem; border-radius: 4px; margin: 0; overflow-x: auto; font-size: 0.85rem; border: 1px solid #e2e8f0;">username,password,university,role,classroom_id,test_id
student1,unique001,MIT,,act001,
student1,unique002,MIT,,,test001
student2,unique003,Stanford,both,act002,test002</pre>
							<p style="color: #92400e; margin: 0.5rem 0 0 0; font-size: 0.85rem;">
								💡 Role auto-detected from IDs if not specified
							</p>
						</div>
					</details>
					
					<form id="dashboardBulkUploadForm" enctype="multipart/form-data">
						<label style="cursor: pointer;">
							<strong>Select CSV File</strong>
							<input type="file" id="dashboardCsvFile" name="csv_file" accept=".csv" required style="cursor: pointer;">
					</label>
						<button type="submit" class="btn" style="width: 100%;">
							<span id="dashboardUploadBtnText">📤 Upload & Create Users</span>
							<span id="dashboardUploadBtnLoading" style="display: none;">⏳ Processing...</span>
						</button>
					</form>
					
					<div id="dashboardUploadResults" style="display: none; margin-top: 1rem;"></div>
					
					<div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">
						<p style="margin: 0; font-size: 0.9rem; color: #000000;">
							📥 <a href="/user_upload_template.csv" download style="color: #3b82f6; font-weight: 600;">Download CSV Template</a>
						</p>
					</div>
				</div>
			</section>

			<section class="grid">
				<div class="card">
					<h2>Create Classroom Activity</h2>
					<p class="muted" style="margin-bottom: 0.75rem;">Generate from Local Question Bank</p>
					<form id="createClassroomForm">
						<label>University
							<select id="classroomUniversity" required></select>
						</label>
						<label>Subject
							<select id="classroomSubject" required></select>
						</label>
						<label>Module
							<select id="classroomModule" required></select>
						</label>
						<label>Number of MCQ Questions<input type="number" id="classroomMcq" min="0" max="50" value="2" required></label>
						<label>Number of Coding Questions<input type="number" id="classroomCoding" min="0" max="50" value="1" required></label>
						<label>Number of Hands-on Questions<input type="number" id="classroomHandsOn" min="0" max="50" value="0" required></label>
						<label>Classroom ID<input type="text" id="classroomId" required></label>
					<button class="btn" type="submit">Generate Activity</button>
				</form>
					<div id="classroomWarning" class="muted" style="margin-top: 0.5rem; display: none; color: #dc2626;"></div>
				</div>
				<div class="card">
					<h2>Create Test</h2>
					<p class="muted" style="margin-bottom: 0.75rem;">Generate from Local Question Bank</p>
					<form id="createTestForm">
						<label>University
							<select id="testUniversity" required></select>
						</label>
						<label>Subject
							<select id="testSubject" required></select>
						</label>
						<label>Module
							<select id="testModule" required></select>
						</label>
						<label>Number of MCQ Questions<input type="number" id="testMcq" min="0" max="50" value="2" required></label>
						<label>Number of Coding Questions<input type="number" id="testCoding" min="0" max="50" value="1" required></label>
						<label>Number of Hands-on Questions<input type="number" id="testHandsOn" min="0" max="50" value="0" required></label>
						<label>Test ID<input type="text" id="testId" required></label>
						<label>Test Start Time<input type="datetime-local" id="testStart" required></label>
						<label>Test End Time<input type="datetime-local" id="testEnd" required></label>
						<button class="btn" type="submit">Create Test</button>
					</form>
					<div id="testWarning" class="muted" style="margin-top: 0.5rem; display: none; color: #dc2626;"></div>
				</div>
			</section>

			{# Question Generator moved to its own admin tab #}

			{% if recent_users %}
			<section class="card">
				<h2>Recent Users</h2>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Role</th>
								<th>Classroom ID</th>
								<th>Test ID</th>
								<th>Created</th>
							</tr>
						</thead>
						<tbody>
							{% for user in recent_users %}
							<tr>
								<td>{{ user.username }}</td>
								<td>{{ user.role }}</td>
								<td>{{ user.classroom_id or '-' }}</td>
								<td>{{ user.test_id or '-' }}</td>
								<td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}
		{% endif %}

		{# Admin Classroom Activities View #}
		{% if view == 'admin_classroom_activities' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>🎯 Try Classroom Activities</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">View and attempt all created classroom activities</p>
			</section>

			{% if activities %}
				{% for activity in activities %}
				<section class="card">
					<div class="flex-between">
						<div>
							<h3>{{ activity.subject }}</h3>
							<p class="muted">Classroom ID: {{ activity.classroom_id }}</p>
							<p class="muted">Created: {{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else 'Unknown' }}</p>
						</div>
						<div>
							<a href="/admin/classroom-activities/{{ activity.activity_id }}" class="btn">🎯 Try Activity</a>
						</div>
					</div>
				</section>
				{% endfor %}
			{% else %}
				<section class="card">
					<h3>No Activities Found</h3>
					<p class="muted">No classroom activities have been created yet.</p>
					<a href="/admin/dashboard" class="btn">Create Activity</a>
				</section>
			{% endif %}
		{% endif %}

		{# Admin Attempt Activity View #}
		{% if view == 'admin_attempt_activity' %}
			<div class="flex-between">
				<h2>🎯 {{ activity.subject }} - Admin Preview</h2>
				<div>
					<a href="/admin/classroom-activities" class="btn secondary">← Back to Activities</a>
				<a href="/admin/dashboard" class="btn secondary">Dashboard</a>
			</div>
		</div>
		
		{% if questions %}
			{# Question Navigation #}
			{% if questions|length > 1 %}
			<section class="card">
				<div class="question-navigation">
					<h4>📋 Question Navigation:</h4>
				<div class="nav-buttons">
					{% for question in questions %}
					{% set nav_question_num = loop.index %}
					<button class="btn secondary nav-btn" data-question="{{ nav_question_num }}" onclick="showQuestion({{ nav_question_num }})">
						Question {{ nav_question_num }}
					</button>
					{% endfor %}
				</div>
				</div>
			</section>
			{% endif %}
			
		{% for question in questions %}
			{% set admin_question_num = loop.index %}
			<section class="card question-card" id="question-{{ admin_question_num }}" {% if admin_question_num > 1 %}style="display: none;"{% endif %}>
				<div class="question-header">
					<h3>Question {{ admin_question_num }}: {{ question.title }} ({{ admin_question_num }}/{{ questions|length }})</h3>
					<div class="question-controls">
						<span class="difficulty-badge difficulty-{{ question.difficulty }}">{{ question.difficulty|title }}</span>
						{% if questions|length > 1 %}
							{% if admin_question_num > 1 %}
							<button class="btn secondary" onclick="showQuestion({{ admin_question_num - 1 }})">← Previous</button>
							{% endif %}
							{% if admin_question_num < questions|length %}
							<button class="btn" onclick="showQuestion({{ admin_question_num + 1 }})">Next →</button>
							{% endif %}
						{% endif %}
					</div>
				</div>
					
				<div class="question-content">
					<p><strong>Description:</strong></p>
					<div style="white-space: pre-wrap; line-height: 1.6;">{{ question.description }}</div>
					
					{# MCQ Questions for Admin #}
					{% if question.question_type == 'mcq' and question.options %}
					<div style="margin-top: 1.5rem;">
						<p><strong>Options (Admin Preview - View Only):</strong></p>
						<div style="margin: 1rem 0;">
							{% for option in question.options %}
							<div style="padding: 0.75rem; margin: 0.5rem 0; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #3b82f6; color: #000000; border: 1px solid #bfdbfe;">
								{{ option }}
								{% if option[0] == question.correct_answer %}
								<span style="color: #10b981; font-weight: 700; margin-left: 1rem;">✓ Correct Answer</span>
								{% endif %}
							</div>
							{% endfor %}
						</div>
						{% if question.explanation %}
						<div style="margin-top: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
							<p style="color: #000000; font-weight: 600;">Explanation:</p>
							<p style="color: #000000;">{{ question.explanation }}</p>
						</div>
						{% endif %}
					</div>
					{% endif %}
					
					{# Coding Question Details #}
					{% if question.question_type == 'coding' or not question.question_type %}
					{% if question.input_format %}
					<p><strong>Input Format:</strong></p>
					<pre class="format-box">{{ question.input_format }}</pre>
					{% endif %}
					
					{% if question.output_format %}
					<p><strong>Output Format:</strong></p>
					<pre class="format-box">{{ question.output_format }}</pre>
					{% endif %}
					
					{% if question.sample_input %}
					<p><strong>Sample Input:</strong></p>
					<pre class="sample-box">{{ question.sample_input }}</pre>
					{% endif %}
					
					{% if question.sample_output %}
					<p><strong>Sample Output:</strong></p>
					<pre class="sample-box">{{ question.sample_output }}</pre>
					{% endif %}
					{% endif %}
				</div>
				
			{# Only show code editor for coding questions #}
			{% if question.question_type == 'coding' or not question.question_type %}
			<div class="compiler-section">
				<h4>🐍 Code Editor (Admin Preview)</h4>
					<div class="compiler-container">
						<div class="code-section">
							<textarea id="admin-code-{{ admin_question_num }}" class="question-code" rows="8" placeholder="# Write your solution here
# Example:
# def solution():
#     return 'Hello World'">{{ question.sample_code or '' }}</textarea>
							<div class="compiler-controls">
								<button class="btn run-admin-question-code" data-question="{{ admin_question_num }}" data-question-text="{{ question.description|e }}">▶️ Run Code</button>
								<button class="btn secondary clear-admin-question-code" data-question="{{ admin_question_num }}">🗑️ Clear</button>
							</div>
						</div>
						
						<div class="output-section">
							<label>Output:</label>
							<div id="admin-output-{{ admin_question_num }}" class="output-box">
								<p class="muted">Click "Run Code" to see the output here...</p>
							</div>
						</div>
					</div>
			</div>
			{% endif %}
			</section>
			{% endfor %}
			{% else %}
				<section class="card">
					{% if view == 'test_interface' %}
						<h2>Test Content</h2>
						<details open>
							<summary>Generated Content</summary>
							<pre class="scroll">{{ test.generated }}</pre>
						</details>
					{% else %}
					<h2>Activity Content</h2>
					<details open>
						<summary>Generated Content</summary>
						<pre class="scroll">{{ activity.generated }}</pre>
					</details>
					{% endif %}
				</section>
			{% endif %}
			</div>
		{% endif %}

		{# Admin Users Management #}
		{% if view == 'admin_users' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>User Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
						<a href="/admin/users/export" class="btn">Export All to CSV</a>
					</div>
				</div>
				<p class="muted">Total Users: {{ total_users }}</p>
			</section>

			{% for university, users in universities.items() %}
			<section class="card">
				<div class="flex-between">
					<h3>🏫 {{ university }} ({{ users|length }} users)</h3>
					<div>
						<a href="/admin/users/export/{{ university|urlencode }}" class="btn secondary small">📥 Export {{ university }} CSV</a>
					</div>
				</div>
				
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Password</th>
								<th>Role</th>
								<th>Classroom ID</th>
								<th>Test ID</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for user in users %}
							<tr>
								<td><strong>{{ user.username }}</strong></td>
								<td>
									<span class="password-display" data-password="{{ user.username }}" data-plain="{{ user.password_plain or 'N/A' }}">••••••••</span>
									<button class="btn secondary tiny" onclick="toggleUserPassword('{{ user.username }}')">👁️</button>
								</td>
								<td><span class="role-badge role-{{ user.role }}">{{ user.role|title }}</span></td>
								<td>{{ user.classroom_id or '-' }}</td>
								<td>{{ user.test_id or '-' }}</td>
								<td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
								<td>
									<button class="btn secondary small" onclick="deleteUser('{{ user.username }}')">🗑️ Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endfor %}
		{% endif %}

		{# Admin Activities Management #}
		{% if view == 'admin_activities' %}
			<section class="card">
				<div class="flex-between">
					<h2>Activities Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">Total Activities: {{ total_activities }}</p>
			</section>

			<section class="card">
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Subject</th>
								<th>Classroom ID</th>
								<th>Questions</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for activity in activities %}
							<tr>
								<td>{{ activity.subject }}</td>
								<td>{{ activity.classroom_id }}</td>
								<td>{{ activity.num_questions }}</td>
								<td>{{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else '-' }}</td>
								<td>
									<button class="btn secondary small" onclick="deleteActivity('{{ activity.activity_id }}')">Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{% if total_pages > 1 %}
				<div class="pagination">
					{% if page > 1 %}
						<a href="?page={{ page - 1 }}" class="btn secondary">Previous</a>
					{% endif %}
					<span class="muted">Page {{ page }} of {{ total_pages }}</span>
					{% if page < total_pages %}
						<a href="?page={{ page + 1 }}" class="btn secondary">Next</a>
					{% endif %}
				</div>
				{% endif %}
			</section>
			</div>
		{% endif %}

		{# Admin Tests Management #}
		{% if view == 'admin_tests' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>Tests Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">Total Tests: {{ total_tests }}</p>
			</section>

			<section class="card">
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Subject</th>
								<th>Test ID</th>
								<th>Questions</th>
								<th>Scheduled</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for test in tests %}
							<tr>
								<td>{{ test.subject }}</td>
								<td>{{ test.test_id }}</td>
								<td>{{ test.num_questions }}</td>
								<td>
									{% if test.start_time and test.end_time %}
										{{ test.start_time.strftime('%Y-%m-%d %H:%M') }} - {{ test.end_time.strftime('%Y-%m-%d %H:%M') }}
									{% elif test.scheduled_at %}
										{{ test.scheduled_at.strftime('%Y-%m-%d %H:%M') }}
									{% else %}
										-
									{% endif %}
								</td>
								<td>{{ test.created_at.strftime('%Y-%m-%d %H:%M') if test.created_at else '-' }}</td>
								<td>
									<a href="/debug/test/{{ test.test_id }}" class="btn secondary small" target="_blank">🔍 Debug</a>
									<button class="btn secondary small" onclick="deleteTest('{{ test.test_id }}')">🗑️ Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{% if total_pages > 1 %}
				<div class="pagination">
					{% if page > 1 %}
						<a href="?page={{ page - 1 }}" class="btn secondary">Previous</a>
					{% endif %}
					<span class="muted">Page {{ page }} of {{ total_pages }}</span>
					{% if page < total_pages %}
						<a href="?page={{ page + 1 }}" class="btn secondary">Next</a>
					{% endif %}
				</div>
				{% endif %}
			</section>
			</div>
		{% endif %}

		{# Admin Submissions & Logs Viewer #}
		{% if view == 'admin_submissions' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>📊 Submissions & Violation Logs</h2>
					<div>
						<a href="/admin/submissions/export?context={{ filter_context }}&test_id={{ filter_test }}&username={{ filter_user }}&university={{ filter_university }}" class="btn secondary">📥 Export CSV</a>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
			</section>

			{# Statistics Cards #}
			<section class="grid">
				<div class="card">
					<h3>📈 Total Submissions</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #3b82f6;">{{ stats.total_submissions }}</p>
					<p class="muted">All submission types</p>
				</div>
				<div class="card">
					<h3>✅ Tests Completed</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #10b981;">{{ stats.total_test_completions }}</p>
					<p class="muted">Final scores available</p>
				</div>
				<div class="card">
					<h3>⚠️ Violations</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #dc2626;">{{ stats.total_violations }}</p>
					<p class="muted">Anti-cheat warnings</p>
				</div>
				<div class="card">
					<h3>👥 Active Users</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #f59e0b;">{{ stats.unique_users }}</p>
					<p class="muted">Users with submissions</p>
				</div>
				<div class="card">
					<h3>🏛️ Universities</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">{{ stats.unique_universities }}</p>
					<p class="muted">Universities active</p>
				</div>
				<div class="card">
					<h3>🎓 Classroom MCQ</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #06b6d4;">{{ stats.total_classroom_mcq }}</p>
					<p class="muted">MCQ submissions</p>
				</div>
				<div class="card">
					<h3>💻 Classroom Coding</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #14b8a6;">{{ stats.total_classroom_coding }}</p>
					<p class="muted">Coding submissions</p>
				</div>
			</section>

			{# University Statistics #}
			{% if university_stats %}
			<section class="card">
				<h3>🏛️ Submissions by University</h3>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>University</th>
								<th>Submissions</th>
								<th>Percentage</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for stat in university_stats %}
							<tr>
								<td><strong>{{ stat._id }}</strong></td>
								<td>{{ stat.count }}</td>
								<td>{{ "%.1f"|format((stat.count / stats.total_submissions * 100) if stats.total_submissions > 0 else 0) }}%</td>
								<td>
									<a href="/admin/submissions?university={{ stat._id }}" class="btn secondary small">Filter by University</a>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}

			{# Violation Statistics #}
			{% if violation_stats %}
			<section class="card">
				<h3>🔍 Violation Breakdown</h3>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Violation Type</th>
								<th>Count</th>
								<th>Percentage</th>
							</tr>
						</thead>
						<tbody>
							{% for stat in violation_stats %}
							<tr>
								<td><strong>{{ stat._id }}</strong></td>
								<td>{{ stat.count }}</td>
								<td>{{ "%.1f"|format((stat.count / stats.total_violations * 100) if stats.total_violations > 0 else 0) }}%</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}

			{# Top Violators #}
			{% if user_violations %}
			<section class="card">
				<h3>⚠️ Users with Most Violations (Top 10)</h3>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Violation Count</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for user_stat in user_violations %}
							<tr>
								<td><strong>{{ user_stat._id }}</strong></td>
								<td><span class="role-badge role-test">{{ user_stat.count }} violations</span></td>
								<td>
									<a href="/admin/submissions?username={{ user_stat._id }}&context=test_violation" class="btn secondary small">View Details</a>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}

			{# Filters #}
			<section class="card">
				<h3>🔎 Filter Submissions</h3>
				<form method="get" action="/admin/submissions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
					<div>
						<label>Context Type</label>
						<select name="context">
							<option value="all" {% if filter_context == 'all' %}selected{% endif %}>All Types</option>
							<option value="test_complete" {% if filter_context == 'test_complete' %}selected{% endif %}>✅ Test Complete</option>
							<option value="classroom_activity_complete" {% if filter_context == 'classroom_activity_complete' %}selected{% endif %}>✅ Classroom Complete</option>
							<option value="test_violation" {% if filter_context == 'test_violation' %}selected{% endif %}>⚠️ Violations</option>
							<option value="test" {% if filter_context == 'test' %}selected{% endif %}>📝 Test Questions</option>
							<option value="classroom_mcq" {% if filter_context == 'classroom_mcq' %}selected{% endif %}>🎓 Classroom MCQ (Legacy)</option>
							<option value="classroom_coding" {% if filter_context == 'classroom_coding' %}selected{% endif %}>🎓 Classroom Coding (Legacy)</option>
							<option value="classroom" {% if filter_context == 'classroom' %}selected{% endif %}>🎓 Classroom (Old)</option>
						</select>
					</div>
					<div>
						<label>Test ID</label>
						<select name="test_id">
							<option value="all" {% if filter_test == 'all' %}selected{% endif %}>All Tests</option>
							{% for test in all_tests %}
								{% if test %}
								<option value="{{ test }}" {% if filter_test == test %}selected{% endif %}>{{ test }}</option>
								{% endif %}
							{% endfor %}
						</select>
					</div>
					<div>
						<label>Username</label>
						<select name="username">
							<option value="all" {% if filter_user == 'all' %}selected{% endif %}>All Users</option>
							{% for user in all_users %}
							<option value="{{ user }}" {% if filter_user == user %}selected{% endif %}>{{ user }}</option>
							{% endfor %}
						</select>
					</div>
					<div>
						<label>University</label>
						<select name="university">
							<option value="all" {% if filter_university == 'all' %}selected{% endif %}>All Universities</option>
							{% for uni in all_universities %}
								{% if uni and uni != 'Unknown' %}
								<option value="{{ uni }}" {% if filter_university == uni %}selected{% endif %}>{{ uni }}</option>
								{% endif %}
							{% endfor %}
						</select>
					</div>
					<div style="display: flex; align-items: flex-end;">
						<button class="btn" type="submit">Apply Filters</button>
						<a href="/admin/submissions" class="btn secondary" style="margin-left: 0.5rem;">Clear</a>
					</div>
				</form>
			</section>

			{# Submissions Table #}
			<section class="card">
				<div class="flex-between" style="margin-bottom: 1rem;">
					<h3>📋 Submissions List ({{ total_submissions }} total)</h3>
					<p class="muted">Showing {{ submissions|length }} entries</p>
				</div>
				
				{% if submissions %}
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Date/Time</th>
								<th>Username</th>
								<th>University</th>
								<th>Context</th>
								<th>Test ID</th>
								<th>Details</th>
								<th style="min-width: 200px;">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for sub in submissions %}
							<tr>
								<td>{{ sub.created_at_str }}</td>
								<td><strong>{{ sub.username }}</strong></td>
								<td><span class="muted">{{ sub.university if sub.university else '-' }}</span></td>
								<td>
									{% if sub.context == 'test_violation' %}
										<span class="role-badge" style="background: #dc2626; color: white;">⚠️ Violation</span>
									{% elif sub.context == 'test_complete' %}
										<span class="role-badge" style="background: #10b981; color: white;">✅ Test Complete</span>
									{% elif sub.context == 'classroom_activity_complete' %}
										<span class="role-badge" style="background: #8b5cf6; color: white;">✅ Classroom Complete</span>
									{% elif sub.context == 'test' %}
										<span class="role-badge role-test">📝 Test Q</span>
									{% elif sub.context == 'classroom' %}
										<span class="role-badge role-classroom">🎓 Old</span>
									{% elif sub.context == 'classroom_mcq' %}
										<span class="role-badge" style="background: #8b5cf6; color: white;">🎓 MCQ</span>
									{% elif sub.context == 'classroom_coding' %}
										<span class="role-badge" style="background: #06b6d4; color: white;">🎓 Coding</span>
									{% else %}
										<span class="role-badge">{{ sub.context }}</span>
									{% endif %}
								</td>
								<td>{{ sub.test_id if sub.test_id else '-' }}</td>
								<td>
									{% if sub.context == 'test_violation' %}
										<strong style="color: #dc2626;">{{ sub.violation_type }}</strong>
										{% if sub.warning_number %}
										<br><small class="muted">Warning {{ sub.warning_number }}/3</small>
										{% endif %}
									{% elif sub.context == 'test_complete' %}
									<strong style="color: #10b981;">Final Score: {{ sub.final_score|default(0) }}%</strong>
									{% set fs = sub.final_score|default(0)|int %}
										<br><small class="muted">Grade: 
									{% if fs >= 90 %}A
									{% elif fs >= 80 %}B
									{% elif fs >= 70 %}C
									{% elif fs >= 60 %}D
										{% else %}F
										{% endif %}
										</small>
									{% elif sub.context == 'classroom_activity_complete' %}
										<strong style="color: #8b5cf6;">Score: {{ sub.score }}</strong>
										<br><small class="muted">{{ sub.percentage }}% ({{ sub.correct_count }}/{{ sub.total_questions }} correct)</small>
									{% elif sub.context == 'test' %}
										Question {{ sub.question_index if sub.question_index is not none else 'N/A' }}
										{% if sub.question_type %}
										<br><small class="muted">Type: {{ sub.question_type }}</small>
										{% endif %}
									{% elif sub.context == 'classroom_mcq' %}
										<strong>{{ sub.question_title if sub.question_title else 'MCQ Question' }}</strong>
										<br><small class="muted">
										{% if sub.is_correct %}
											<span style="color: #10b981;">✓ Correct</span>
										{% else %}
											<span style="color: #dc2626;">✗ Incorrect</span>
										{% endif %}
										</small>
									{% elif sub.context == 'classroom_coding' %}
										<strong>{{ sub.question_title if sub.question_title else 'Coding Question' }}</strong>
										<br><small class="muted">Code submitted</small>
									{% else %}
										-
									{% endif %}
								</td>
								<td>
									<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
										<a href="/admin/submissions/{{ sub._id }}" class="btn secondary small" target="_blank">View Details</a>
										<button class="btn danger small" onclick="deleteSubmission('{{ sub._id }}', '{{ sub.username }}', '{{ sub.context }}')">🗑️ Delete</button>
									</div>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{# Pagination #}
				{% if total_pages > 1 %}
				<div class="pagination" style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center; justify-content: center;">
					{% if page > 1 %}
						<a href="?page={{ page - 1 }}&context={{ filter_context }}&test_id={{ filter_test }}&username={{ filter_user }}&university={{ filter_university }}" class="btn secondary">← Previous</a>
					{% endif %}
					<span class="muted">Page {{ page }} of {{ total_pages }}</span>
					{% if page < total_pages %}
						<a href="?page={{ page + 1 }}&context={{ filter_context }}&test_id={{ filter_test }}&username={{ filter_user }}&university={{ filter_university }}" class="btn secondary">Next →</a>
					{% endif %}
				</div>
				{% endif %}

				{% else %}
				<p class="muted">No submissions found matching the current filters.</p>
				{% endif %}
			</section>

			{# Grouped by University → Subject #}
			<section class="card" style="margin-top: 1.5rem;">
				<h3>🏛️ Grouped by University → Subject</h3>
				{% if grouped_submissions %}
					{% for uni, subj_map in grouped_submissions.items() %}
						<div style="margin-top: 1rem;">
							<h4 style="margin: 0 0 0.5rem 0;">{{ uni }}</h4>
							{% for subj, items in subj_map.items() %}
								<div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; margin: 0.5rem 0;">
									<div class="flex-between" style="align-items: center;">
										<strong>📚 {{ subj }}</strong>
										<a class="btn secondary small" href="/admin/submissions/export?university={{ uni|urlencode }}&subject={{ subj|urlencode }}">Export Subject CSV</a>
									</div>
									<div class="table-container" style="margin-top: 0.5rem;">
										<table>
											<thead>
												<tr>
													<th>Date/Time</th>
													<th>Username</th>
													<th>Context</th>
													<th>Test ID</th>
													<th style="min-width: 160px;">Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for sub in items %}
											<tr>
												<td>{{ sub.created_at_str }}</td>
												<td>{{ sub.username }}</td>
												<td>{{ sub.context }}</td>
												<td>{{ sub.test_id if sub.test_id else '-' }}</td>
												<td>
													<a href="/admin/submissions/{{ sub._id }}" class="btn secondary small">Details</a>
												</td>
											</tr>
											{% endfor %}
										</tbody>
										</table>
									</div>
								</div>
							{% endfor %}
						</div>
					{% endfor %}
				{% else %}
					<p class="muted">No submissions found to group.</p>
				{% endif %}
			</section>
			</div>
			
			<script>
			// Delete submission function with confirmation
			async function deleteSubmission(submissionId, username, context) {
				// Create a friendly context name
				const contextNames = {
					'test_violation': 'Violation',
					'test_complete': 'Test Completion',
					'test': 'Test Submission',
					'classroom': 'Classroom Submission'
				};

		// submitAllTestAnswers is defined in the shared activity/test script below
				const contextName = contextNames[context] || context;
				
				// Confirm deletion
				const confirmed = confirm(
					`⚠️ DELETE SUBMISSION?\n\n` +
					`User: ${username}\n` +
					`Type: ${contextName}\n` +
					`ID: ${submissionId}\n\n` +
					`This action cannot be undone. Continue?`
				);
				
				if (!confirmed) {
					return;
				}
				
				try {
					const response = await fetch(`/admin/submissions/delete/${submissionId}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						}
					});
					
					const result = await response.json();
					
					if (result.ok) {
						alert('✅ Submission deleted successfully!');
						// Reload the page to refresh the list
						window.location.reload();
					} else {
						alert(`❌ Error: ${result.message}`);
					}
				} catch (error) {
					console.error('Delete error:', error);
					alert(`❌ Failed to delete submission: ${error.message}`);
				}
			}
			</script>
		{% endif %}

		{# Admin Submission Detail #}
		{% if view == 'admin_submission_detail' %}
			<section class="card">
				<div class="flex-between">
					<h2>📄 Submission Details</h2>
					<a href="/admin/submissions" class="btn secondary">← Back to Submissions</a>
				</div>
			</section>

			{% if error %}
			<section class="card" style="border-left: 4px solid #dc2626;">
				<div class="alert">
					<strong>⚠️ Error Loading Submission</strong><br>
					{{ error }}
				</div>
				<p class="muted">Please check the submission ID and try again.</p>
			</section>
			{% elif submission %}
			<section class="card">
				<h3>Basic Information</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Username</p>
						<p><strong>{{ submission.username }}</strong></p>
					</div>
					<div>
						<p class="muted">Context</p>
						<p><strong>{{ submission.context }}</strong></p>
					</div>
					<div>
						<p class="muted">Test ID</p>
						<p><strong>{{ submission.test_id if submission.test_id else 'N/A' }}</strong></p>
					</div>
					<div>
						<p class="muted">Created At</p>
						<p><strong>{{ submission.created_at.strftime('%Y-%m-%d %H:%M:%S') if submission.created_at else 'N/A' }}</strong></p>
					</div>
				</div>
			</section>

			{% if submission.context == 'test_violation' %}
			<section class="card" style="border-left: 4px solid #dc2626;">
				<h3>⚠️ Violation Details</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Violation Type</p>
						<p><strong style="color: #dc2626;">{{ submission.violation_type }}</strong></p>
					</div>
					<div>
						<p class="muted">Warning Number</p>
						<p><strong>{{ submission.warning_number }}/3</strong></p>
					</div>
				</div>
			</section>
			{% endif %}

			{% if submission.context == 'test' %}
			<section class="card">
				<h3>📝 Test Submission Details</h3>
				<div style="margin-bottom: 1rem;">
					<p class="muted">Question Index</p>
					<p><strong>{{ submission.question_index if submission.question_index is not none else 'N/A' }}</strong></p>
				</div>
				
				{% if submission.user_code %}
				<div style="margin-bottom: 1rem;">
					<p class="muted">Student's Code</p>
					<pre class="scroll" style="max-height: 300px;">{{ submission.user_code }}</pre>
				</div>
				{% endif %}
				
				{% if submission.ai_grading %}
				<div>
					<p class="muted">AI Grading Result</p>
					<pre class="scroll" style="max-height: 300px;">{{ submission.ai_grading }}</pre>
				</div>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'classroom' %}
			<section class="card">
				<h3>🎓 Classroom Submission Details</h3>
				
				{% if submission.question_text %}
				<div style="margin-bottom: 1rem;">
					<p class="muted">Question</p>
					<p>{{ submission.question_text }}</p>
				</div>
				{% endif %}
				
				{% if submission.user_code %}
				<div style="margin-bottom: 1rem;">
					<p class="muted">Student's Code</p>
					<pre class="scroll" style="max-height: 300px;">{{ submission.user_code }}</pre>
				</div>
				{% endif %}
				
				{% if submission.ai_feedback %}
				<div>
					<p class="muted">AI Feedback</p>
					<pre class="scroll" style="max-height: 400px;">{{ submission.ai_feedback }}</pre>
				</div>
				{% endif %}
			</section>
			{% endif %}

				{% if submission.details %}
				<section class="card">
					<h3>📎 Uploaded Files</h3>
					<ul>
					{% for d in submission.details %}
						{% if d.question_type == 'hands_on' and d.hands_on_file and d.hands_on_file.saved %}
						<li>
							Question {{ d.question_index }}: 
							<a class="btn secondary small" href="/admin/submissions/file?sub_id={{ submission._id }}&idx={{ loop.index0 }}">Download {{ d.hands_on_file.file_name }}</a>
						</li>
						{% endif %}
					{% endfor %}
					</ul>
			</section>
			{% endif %}

			{% if submission.context == 'classroom_mcq' %}
			<section class="card">
				<h3>🎓 Classroom MCQ Submission</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Activity ID</p>
						<p><strong>{{ submission.activity_id }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Index</p>
						<p><strong>{{ submission.question_index }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Title</p>
						<p><strong>{{ submission.question_title or 'N/A' }}</strong></p>
					</div>
				</div>
				
				<div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Student's Answer</p>
						<p><strong>{{ submission.selected_answer }}</strong></p>
					</div>
					<div>
						<p class="muted">Correct Answer</p>
						<p><strong style="color: #10b981;">{{ submission.correct_answer }}</strong></p>
					</div>
					<div>
						<p class="muted">Result</p>
						<p><strong {% if submission.is_correct %}style="color: #10b981;"{% else %}style="color: #dc2626;"{% endif %}>
							{% if submission.is_correct %}✓ Correct{% else %}✗ Incorrect{% endif %}
						</strong></p>
					</div>
				</div>
				
				{% if submission.explanation %}
				<div style="margin-top: 1.5rem;">
					<p class="muted">Explanation</p>
					<div style="padding: 1rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
						<p style="color: #000000;">{{ submission.explanation }}</p>
					</div>
				</div>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'classroom_coding' %}
			<section class="card">
				<h3>🎓 Classroom Coding Submission</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Activity ID</p>
						<p><strong>{{ submission.activity_id }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Index</p>
						<p><strong>{{ submission.question_index }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Title</p>
						<p><strong>{{ submission.question_title or 'N/A' }}</strong></p>
					</div>
				</div>
				
				{% if submission.user_code %}
				<div style="margin-top: 1.5rem;">
					<p class="muted">Student's Code</p>
					<pre class="scroll" style="max-height: 400px;">{{ submission.user_code }}</pre>
				</div>
				{% endif %}
				
				{% if submission.ai_feedback %}
				<div style="margin-top: 1.5rem;">
					<p class="muted">AI Feedback</p>
					<pre class="scroll" style="max-height: 400px; white-space: pre-wrap;">{{ submission.ai_feedback }}</pre>
				</div>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'classroom_activity_complete' %}
			<section class="card" style="border-left: 4px solid #8b5cf6;">
				<h3>🎓 Classroom Activity - Final Submission</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
					<div>
						<p class="muted">Activity ID</p>
						<p><strong>{{ submission.activity_id }}</strong></p>
					</div>
					<div>
						<p class="muted">Score</p>
						<p><strong style="font-size: 1.5rem; color: #8b5cf6;">{{ submission.score }}</strong></p>
					</div>
					<div>
						<p class="muted">Percentage</p>
						<p><strong style="font-size: 1.5rem; color: #10b981;">{{ submission.percentage }}%</strong></p>
					</div>
					<div>
						<p class="muted">Correct Answers</p>
						<p><strong>{{ submission.correct_count }} / {{ submission.total_questions }}</strong></p>
					</div>
				</div>
				
				<h4>📊 Question-by-Question Breakdown</h4>
				{% if submission.details %}
				<div style="display: grid; gap: 1rem; margin-top: 1rem;">
					{% for detail in submission.details %}
					<div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 4px solid {% if detail.is_correct %}#10b981{% else %}#dc2626{% endif %};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<h5 style="margin: 0; color: #000000;">Question {{ detail.question_index }}: {{ detail.question_title }}</h5>
							<span style="font-weight: 600; color: {% if detail.is_correct %}#10b981{% else %}#dc2626{% endif %};">
								{% if detail.is_correct %}✅ Correct{% else %}❌ Incorrect{% endif %}
							</span>
						</div>
						<p style="margin: 0.5rem 0; color: #666;"><strong>Type:</strong> {{ 'Multiple Choice' if detail.question_type == 'mcq' else 'Coding' }}</p>
						
						{% if detail.question_type == 'mcq' %}
						<div style="margin-top: 1rem;">
							<p style="margin: 0.25rem 0; color: #000000;"><strong>Student's Answer:</strong> {{ detail.selected_answer or 'No answer' }}</p>
							<p style="margin: 0.25rem 0; color: #10b981;"><strong>Correct Answer:</strong> {{ detail.correct_answer }}</p>
							{% if detail.explanation %}
							<div style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 4px; border: 1px solid #bfdbfe;">
								<p style="margin: 0; color: #000000;"><strong>Explanation:</strong> {{ detail.explanation }}</p>
							</div>
							{% endif %}
						</div>
						{% elif detail.question_type == 'coding' %}
						<div style="margin-top: 1rem;">
							{% if detail.user_code %}
							<details>
								<summary style="cursor: pointer; color: #3b82f6; font-weight: 600;">View Code</summary>
								<pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 4px; overflow-x: auto; margin-top: 0.5rem;">{{ detail.user_code }}</pre>
							</details>
							{% endif %}
							{% if detail.ai_feedback %}
							<div style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 4px; border: 1px solid #bfdbfe;">
								<p style="margin: 0; color: #000000;"><strong>AI Evaluation:</strong></p>
								<pre style="white-space: pre-wrap; margin: 0.5rem 0 0 0; color: #000000;">{{ detail.ai_feedback }}</pre>
							</div>
							{% endif %}
						</div>
						{% endif %}
					</div>
					{% endfor %}
				</div>
				{% else %}
				<p class="muted">No detailed breakdown available.</p>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'test_complete' %}
			<section class="card" style="border-left: 4px solid #10b981;">
				<h3>📊 Final Test Score</h3>
				<div style="text-align: center; margin: 2rem 0;">
					<div style="font-size: 4rem; font-weight: 700; color: #10b981;">
						{{ submission.final_score|default(0) }}%
					</div>
					<p class="muted">Final Score</p>
				</div>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
					<div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe;">
						<p class="muted">Total Questions</p>
						<p style="font-size: 2rem; font-weight: 700; color: #000000;">{{ submission.total_questions|default('N/A') }}</p>
					</div>
					<div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe;">
						<p class="muted">Grade</p>
						<p style="font-size: 2rem; font-weight: 700;">
							{% set fs = submission.final_score|default(0)|int %}
							{% if fs >= 90 %}
								A
							{% elif fs >= 80 %}
								B
							{% elif fs >= 70 %}
								C
							{% elif fs >= 60 %}
								D
							{% else %}
								F
							{% endif %}
						</p>
					</div>
				</div>
				<div style="margin-top: 2rem;">
					<a href="/admin/submissions?username={{ submission.username }}&test_id={{ submission.test_id }}&context=test" class="btn">View All Answers</a>
				</div>
			</section>
			{% endif %}

			<section class="card">
				<h3>🔍 Raw Data (JSON)</h3>
				<details>
					<summary>Click to view full submission document</summary>
					<pre class="scroll" style="max-height: 500px;">{{ submission | tojson(indent=2) }}</pre>
				</details>
			</section>
			{% endif %}
		{% endif %}


		{# User Selection (for "both" role) #}
		{% if view == 'user_selection' %}
			<section class="container narrow">
				<h2>Welcome, {{ user.username }}!</h2>
				<p>You have access to both classroom activities and tests. Choose what you'd like to do:</p>
				<div class="grid">
					<div class="card">
						<h3>Classroom Activities</h3>
						<p>Work on coding exercises and get AI feedback.</p>
						<a class="btn" href="/classroom">Go to Classroom</a>
					</div>
					<div class="card">
						<h3>Take Test</h3>
						<p>Take your scheduled coding test.</p>
						<a class="btn" href="/test">Go to Test</a>
					</div>
					<div class="card">
						<h3>🐍 Python Compiler</h3>
						<p>Write and run Python code directly in your browser.</p>
						<a class="btn" href="/compiler">Open Compiler</a>
					</div>
				</div>
			</section>
		{% endif %}

		{# Classroom List #}
		{% if view == 'classroom' %}
			<div class="flex-between">
				<h2>Classroom ID: {{ classroom_id }}</h2>
				<a class="btn secondary" href="/compiler">🐍 Python Compiler</a>
			</div>
			{% if activities|length == 0 %}
				<p class="muted">No activities yet.</p>
			{% else %}
				<div class="grid">
					{% for act in activities %}
					<div class="card">
						<h3>{{ act.subject }}</h3>
						<p class="small muted">Created {{ act.created_at }}</p>
						<a class="btn" href="/activity/{{ act.activity_id }}">Open</a>
					</div>
					{% endfor %}
				</div>
			{% endif %}
		{% endif %}

		{# Activity Detail #}
		{% if view == 'activity' or view == 'test_interface' %}
			<div class="flex-between">
				{% if view == 'test_interface' %}
					<h2>{{ test.subject }} - Test</h2>
					<div style="display:flex; align-items:center; gap:0.75rem;">
						<div id="test-timer" data-end-ms="{{ end_time_ms|default('') }}" style="font-weight:700; color:#dc2626;"></div>
						<a class="btn secondary" href="/test">← Back to Test Info</a>
					</div>
				{% else %}
				<h2>{{ activity.subject }} Activity</h2>
				<a class="btn secondary" href="/classroom">← Back to Activities</a>
				{% endif %}
			</div>
			
			{% if questions %}
				{% for question in questions %}
				{% set question_num = loop.index %}
				<section class="card question-card{% if view == 'test_interface' %} test-question{% endif %}" data-index="{{ question_num }}" data-type="{{ question.question_type }}" {% if view == 'test_interface' and question_num > 1 %}style="display:none;"{% endif %}>
					<div class="question-header">
						<h3>Question {{ question_num }}: {{ question.title }}</h3>
						<!-- DEBUG: question_num = {{ question_num }}, loop.index = {{ loop.index }} -->
						<div style="display: flex; gap: 0.5rem; align-items: center;">
							<span class="difficulty-badge difficulty-{{ question.difficulty }}">
								{% if question.difficulty == 'medium_plus' %}
									Medium+ (Coding)
								{% else %}
									{{ question.difficulty|title }}
								{% endif %}
							</span>
							{% if question.question_type == 'mcq' %}
							<span class="role-badge role-classroom">📝 MCQ</span>
							{% elif question.question_type == 'coding' %}
							<span class="role-badge role-test">💻 Coding</span>
							{% endif %}
						</div>
					</div>
					
					<div class="question-content">
						<p><strong>Description:</strong></p>
						<div style="white-space: pre-wrap; line-height: 1.6;">{{ question.description }}</div>
						
						{# MCQ Questions #}
						{% if question.question_type == 'mcq' and question.options %}
						<div style="margin-top: 1.5rem;" id="mcq-question-{{ question_num }}">
							<p><strong>Select the correct answer:</strong></p>
							<!-- DEBUG: Rendering MCQ for question_num={{ question_num }}, Total options={{ question.options|length }} -->
							<div style="margin: 1rem 0;" id="mcq-options-{{ question_num }}">
								{% for option in question.options %}
							<div class="mcq-option-classroom" data-option-index="{{ loop.index0 }}" data-option-text="{{ option }}" data-question-idx="{{ question_num }}" onclick="selectClassroomMCQ(this, {{ question_num }});" style="padding: 0.75rem; margin: 0.5rem 0; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #3b82f6; cursor: pointer; transition: all 0.2s; color: #000000; border: 1px solid #bfdbfe;">
									{{ option }}
								</div>
								{% endfor %}
							</div>
							
							<div style="margin-top: 1rem;">
								<button class="btn secondary" onclick="clearClassroomMCQ({{ question_num }});">
									Clear Selection
								</button>
								<span id="mcq-status-{{ question_num }}" class="muted" style="margin-left: 1rem;"></span>
							</div>
							
							{% if question.hints %}
							<details style="margin-top: 1rem;">
								<summary style="cursor: pointer; color: #2563eb; font-weight: 600;">💡 Show Hints</summary>
								<div style="margin-top: 0.5rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe; color: #000000;">
									{% for hint in question.hints %}
									<p>• {{ hint }}</p>
									{% endfor %}
								</div>
							</details>
							{% endif %}
						</div>
						{% endif %}
						
						{# Coding Questions #}
						{% if question.question_type == 'coding' or not question.question_type %}
						{% if question.input_format %}
						<p><strong>Input Format:</strong></p>
						<pre class="format-box">{{ question.input_format }}</pre>
						{% endif %}
						
						{% if question.output_format %}
						<p><strong>Output Format:</strong></p>
						<pre class="format-box">{{ question.output_format }}</pre>
						{% endif %}
						
						{% if question.sample_input %}
						<p><strong>Sample Input:</strong></p>
						<pre class="sample-box">{{ question.sample_input }}</pre>
						{% endif %}
						
						{% if question.sample_output %}
						<p><strong>Sample Output:</strong></p>
						<pre class="sample-box">{{ question.sample_output }}</pre>
						{% endif %}
						
						{% if question.constraints %}
						<p><strong>Constraints:</strong></p>
						<p style="color: #f59e0b;">{{ question.constraints }}</p>
						{% endif %}
						{% endif %}
					</div>
					
					{# Only show code editor for coding questions #}
					{% if question.question_type == 'coding' or not question.question_type %}
					<div class="compiler-section" id="coding-question-{{ question_num }}">
						<h4>🐍 Code Editor</h4>
						<div class="compiler-container">
							<div class="code-section">
								<textarea id="code-{{ question_num }}" class="question-code" rows="8" placeholder="# Write your solution here
# Example:
# def solution():
#     return 'Hello World'">{{ question.sample_code or '' }}</textarea>
								<div class="compiler-controls">
									<button class="btn run-question-code" data-question="{{ question_num }}" data-question-text="{{ question.description|e }}">▶️ Run Code</button>
									<button class="btn secondary clear-question-code" data-question="{{ question_num }}">🗑️ Clear</button>
								</div>
							</div>
							
							<div class="output-section">
								<label>Output:</label>
								<div id="output-{{ question_num }}" class="output-box">
									<p class="muted">Click "Run Code" to see the output here...</p>
								</div>
							</div>
						</div>
						
						<div style="margin-top: 1rem;">
							<span id="coding-status-{{ question_num }}" class="muted"></span>
						</div>
					</div>
					{% endif %}

					{# Hands-on Questions #}
					{% if question.question_type == 'hands_on' %}
					<div class="handson-section" id="handson-question-{{ question_num }}" style="margin-top: 1rem;">
						<p><strong>Hands-on Upload:</strong></p>
						<input type="file" id="handson-file-{{ question_num }}" />
						<p class="muted" style="margin-top: 0.5rem;">Upload any file type as your solution.</p>
					</div>
					{% endif %}
				</section>
				{% endfor %}
			{% else %}
				<section class="card">
					<h2>Activity Content</h2>
					<details open>
						<summary>Generated Content</summary>
						<pre class="scroll">{{ activity.generated }}</pre>
					</details>
				</section>
			{% endif %}
			
			{% if questions %}
			<section class="card" style="border-left: 4px solid #10b981;">
				<h3>📝 Submit Your Answers</h3>
				<p class="muted">Review all your answers above and click Submit when ready. You can still change your answers before submitting.</p>
				<div style="margin-top: 1.5rem;">
					{% if view == 'test_interface' %}
						<!-- In test mode, the Submit button appears at the end only (see test navigator below) -->
						<button class="btn secondary" type="button" onclick="window.location.href='/test'">
							Cancel
						</button>
					{% else %}
						<button class="btn" type="button" onclick="submitAllClassroomAnswers('{{ activity.activity_id }}', {{ questions | tojson | forceescape }})" style="font-size: 1.1rem; padding: 1rem 2rem;">
						✅ Submit All Answers
					</button>
					<button class="btn secondary" onclick="window.location.href='/classroom'" style="margin-left: 1rem;">
						Cancel
					</button>
					{% endif %}
				</div>
				<div id="final-result" style="margin-top: 2rem; display: none;"></div>
			</section>
			{% if view == 'test_interface' %}
			<section class="card" id="test-nav" style="margin-top:1rem;">
				<div class="flex-between">
					<div>
						<button class="btn secondary" type="button" id="btnPrev">← Previous</button>
						<button class="btn" type="button" id="btnNext">Next →</button>
						<button class="btn" type="button" id="btnSubmit" style="display:none; margin-left: 0.5rem;">✅ Submit All Answers</button>
					</div>
					<div id="nav-error" class="muted" style="color:#dc2626 !important; font-weight:600;"></div>
				</div>
			</section>
			{% endif %}
			{% else %}
			<section class="card">
				<form method="post" action="/classroom/complete">
					<button class="btn secondary" type="submit">Complete Activity</button>
				</form>
			</section>
			{% endif %}
		{% endif %}

		{# Test View #}
		{% if view == 'test' %}
			{% if error %}
				<section class="container narrow">
					<div class="card" style="border-left: 4px solid #dc2626;">
						<h2>⚠️ Test Error</h2>
						<p style="font-size: 1.1rem; margin: 1.5rem 0;">{{ error }}</p>
						
						{% if already_completed %}
						<div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #fbbf24;">
							<h3 style="color: #92400e; margin: 0 0 0.5rem 0;">📋 Test Details</h3>
							{% if test %}
							<p style="color: #000000; margin: 0.5rem 0;"><strong>Test:</strong> {{ test.subject }}</p>
							{% endif %}
							{% if completion_time %}
							<p style="color: #000000; margin: 0.5rem 0;"><strong>Completed At:</strong> {{ completion_time.strftime('%Y-%m-%d %H:%M:%S') }}</p>
							{% endif %}
							<p style="color: #fbbf24; margin-top: 1rem;">
								⚠️ <strong>Once submitted, tests cannot be retaken.</strong>
							</p>
						</div>
						
						<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid #bfdbfe;">
							<p style="color: #000000; margin: 0;">
								Your responses have been recorded and are being evaluated by your instructor. Results will be shared at a later time.
							</p>
						</div>
						{% endif %}
						
						<div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
							<a class="btn" href="/home">Return Home</a>
							<a class="btn secondary" href="/user/logout">Logout</a>
						</div>
					</div>
				</section>
			{% elif test %}
				<div class="flex-between">
					<h2>{{ test.subject }}</h2>
					<a class="btn secondary" href="/compiler">🐍 Python Compiler</a>
				</div>
				<div class="card">
					<p class="muted">Test ID: {{ test.test_id }}</p>
					<p class="muted">Questions: {{ test.num_questions }}</p>
					
					{# Display time information based on test format #}
					{% if start_time and end_time %}
						<p class="muted">Test Window: {{ start_time.strftime('%Y-%m-%d %H:%M') }} - {{ end_time.strftime('%Y-%m-%d %H:%M') }} (Local Time)</p>
					{% elif scheduled_at %}
						<p class="muted">Scheduled for: {{ scheduled_at.strftime('%Y-%m-%d %H:%M') }} (Local Time)</p>
					{% else %}
						<p class="muted">Not scheduled</p>
					{% endif %}
					
					<p class="muted">Current time: {{ current_time.strftime('%Y-%m-%d %H:%M') if current_time else 'Unknown' }} (Local Time)</p>
					
					{# Test status display #}
					{% if test_status == 'open' %}
						<div class="alert success">
							<strong>✅ Test is now open!</strong><br>
							You can now begin the test.
							{% if start_time and end_time %}
							<div id="test-timer" class="mt">
								<p>Time remaining: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% endif %}
						</div>
						<a href="/test/start" class="btn">Attempt Test</a>
					{% elif test_status == 'not_started' %}
						<div class="alert">
							<strong>⏰ Test not yet open</strong><br>
							Please wait until the scheduled start time to begin the test.
							{% if start_time %}
							<div id="countdown" class="mt">
								<p>Time until test opens: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% elif scheduled_at %}
							<div id="countdown" class="mt">
								<p>Time until test opens: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% endif %}
						</div>
						<button class="btn disabled" id="attempt-btn" disabled onclick="showNotOpenMessage()">
							Attempt Test
						</button>
					{% elif test_status == 'expired' %}
						<div class="alert" style="background: #7f1d1d; border-color: #dc2626; color: #fca5a5;">
							<strong>❌ Test has expired</strong><br>
							The test window has closed. You can no longer attempt this test.
						</div>
						<button class="btn disabled" id="attempt-btn" disabled onclick="showExpiredMessage()">
							Attempt Test
						</button>
					{% else %}
						<div class="alert">
							<strong>⚠️ No test scheduled</strong><br>
							No test has been scheduled for you.
						</div>
					{% endif %}
			{% endif %}
					{% endif %}


		{# Admin: Question Generator #}
		{% if view == 'admin_question_generator' %}
			<section class="card">
				<div class="flex-between">
					<h2>🧩 Question Generator</h2>
					<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				<p class="muted">Create subjects with modules and questions. All data stored in MongoDB.</p>
			</section>

			<section class="card">
				<form id="localQGForm">
					<label>University
						<input type="text" id="qgUniversity" placeholder="e.g., MIT" required>
					</label>
					<label>Subject Name
						<input type="text" id="qgSubject" placeholder="e.g., Data Structures" required>
					</label>
					<div id="qgModulesContainer" style="margin-top: 1rem;"></div>
					<div style="margin-top: 1rem;">
						<button class="btn" id="qgAddModuleBtn" type="button">➕ Add Module</button>
						<button class="btn secondary" id="qgClearAllBtn" type="button">🗑️ Clear Form</button>
						</div>
						<div style="margin-top: 1rem;">
						<button class="btn" id="qgSubmitBankBtn" type="button">💾 Save to Question Bank</button>
						</div>
				</form>
			</section>
					{% endif %}
					
		{# Admin: Questionnaire Management #}
		{% if view == 'admin_questionnaire_management' %}
			<section class="card">
				<div class="flex-between">
					<h2>🗂️ Questionnaire Management</h2>
					<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
				</div>
				<p class="muted">View, edit, and manage all question banks stored in MongoDB.</p>
			</section>
			
			<section class="card">
				<div id="qmGroups"></div>
				<div id="qmDetailContainer" style="margin-top: 1.5rem; display:none;"></div>
			</section>
			{% endif %}
		

		{# JavaScript for test preview #}
		{% if view == 'test' %}
		<script>
		// Countdown timer for test opening/closing
		{% if start_time and end_time %}
		(function(){
			// Times are already in local timezone from server
			const startTime = new Date('{{ start_time.strftime('%Y-%m-%dT%H:%M:%S') }}');
			const endTime = new Date('{{ end_time.strftime('%Y-%m-%dT%H:%M:%S') }}');
			const countdownElement = document.getElementById('time-remaining');
			
			function updateCountdown() {
				const now = new Date();
				
				if (now < startTime) {
					// Test not started yet
					const timeLeft = startTime - now;
					const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
					const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
					const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
					
					let timeString = '';
					if (days > 0) timeString += days + 'd ';
					if (hours > 0) timeString += hours + 'h ';
					if (minutes > 0) timeString += minutes + 'm ';
					timeString += seconds + 's';
					
					countdownElement.textContent = timeString;
				} else if (now >= startTime && now <= endTime) {
					// Test is open - show time remaining
					const timeLeft = endTime - now;
					const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
					const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
					const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
					
					let timeString = '';
					if (days > 0) timeString += days + 'd ';
					if (hours > 0) timeString += hours + 'h ';
					if (minutes > 0) timeString += minutes + 'm ';
					timeString += seconds + 's';
					
					countdownElement.textContent = timeString;
					
					if (timeLeft <= 0) {
						location.reload(); // Reload when test expires
						return;
					}
				} else {
					// Test has expired
					countdownElement.textContent = 'Test has expired';
				}
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		})();
		{% elif scheduled_at %}
		(function(){
			// Time is already in local timezone from server
			const scheduledTime = new Date('{{ scheduled_at.strftime('%Y-%m-%dT%H:%M:%S') }}');
			const countdownElement = document.getElementById('time-remaining');
			
			function updateCountdown() {
				const now = new Date();
				const timeLeft = scheduledTime - now;
				
				if (timeLeft <= 0) {
					countdownElement.textContent = 'Test is now open!';
					location.reload(); // Reload to show the test
					return;
				}
				
				const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
				const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
				const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
				const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
				
				let timeString = '';
				if (days > 0) timeString += days + 'd ';
				if (hours > 0) timeString += hours + 'h ';
				if (minutes > 0) timeString += minutes + 'm ';
				timeString += seconds + 's';
				
				countdownElement.textContent = timeString;
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		})();
		{% endif %}
		
		// Show message when attempt button is clicked before test opens
		function showNotOpenMessage() {
			alert('Test is not yet open. Please wait until the scheduled time to begin the test.');
		}
		
		// Show message when attempt button is clicked after test expires
		function showExpiredMessage() {
			alert('Test has expired. The test window has closed and you can no longer attempt this test.');
		}
		</script>
		{% endif %}

		{# Test Result #}
		{% if view == 'test_result' %}
			<section class="container narrow">
				<div class="card" style="text-align: center;">
					<div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
					<h2>Test Submitted Successfully!</h2>
					<p class="muted" style="font-size: 1.1rem; margin: 1.5rem 0;">
						Thank you for completing the test.
					</p>
					
					{% if test %}
					<div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid #bfdbfe;">
						<p style="color: #000000;"><strong>Test:</strong> {{ test.subject }}</p>
						{% if total_questions %}
						<p style="color: #000000;"><strong>Questions Answered:</strong> {{ total_questions }}</p>
						{% endif %}
					</div>
					{% endif %}
					
					<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid #bfdbfe;">
						<p style="color: #000000;">
							<strong>📊 Results</strong><br>
							Your responses have been recorded and will be evaluated by your instructor.<br>
							Results will be shared by your instructor at a later time.
						</p>
					</div>
					
					<p class="muted" style="margin: 1.5rem 0;">
						You may now safely close this window or logout.
					</p>
					
					<div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
						<a class="btn" href="/home">Return Home</a>
						<a class="btn secondary" href="/user/logout">Logout</a>
					</div>
				</div>
			</section>
		{% endif %}

		{# Python Compiler #}
		{% if view == 'compiler' %}
			<section class="container">
				<div class="card">
					<h2>🐍 Python Compiler</h2>
					<p class="muted">Write and run Python code directly in your browser</p>
					
					<div class="compiler-container">
						<div class="code-section">
							<label for="python-code">Your Python Code:</label>
							<textarea id="python-code" rows="15" placeholder="# Write your Python code here
print('Hello, World!')
x = 5
y = 10
print(f'Sum: {x + y}')"></textarea>
							<div class="compiler-controls">
								<button id="run-code" class="btn">▶️ Run Code</button>
								<button id="clear-code" class="btn secondary">🗑️ Clear</button>
							</div>
						</div>
						
						<div class="output-section">
							<label>Output:</label>
							<div id="compiler-output" class="output-box">
								<p class="muted">Click "Run Code" to see the output here...</p>
							</div>
						</div>
					</div>
					
					<div class="compiler-info">
						<h3>Features:</h3>
						<ul>
							<li>✅ Safe code execution with timeout protection</li>
							<li>✅ Standard Python libraries available</li>
							<li>✅ Real-time output display</li>
							<li>✅ Error handling and debugging</li>
						</ul>
					</div>
				</div>
			</section>
		{% endif %}
	</main>

	<footer class="container">
		<small>&copy; <span id="year"></span> Coding Playground</small>
	</footer>
	<script>
	// Global helpers available across all views
	if (typeof window.toggleUserPassword !== 'function') {
		function toggleUserPassword(username) {
			console.log('toggleUserPassword called for:', username);
			const passwordSpan = document.querySelector(`span[data-password="${username}"]`);
			console.log('Password span found:', passwordSpan);
			if (!passwordSpan) {
				console.error('Password span not found for username:', username);
				alert('Password element not found for user: ' + username);
				return;
			}
			const button = passwordSpan.nextElementSibling;
			console.log('Button found:', button);
			const plainPassword = passwordSpan.getAttribute('data-plain');
			console.log('Plain password from data-plain:', plainPassword);
			if (passwordSpan.textContent.trim() === '••••••••') {
				passwordSpan.textContent = plainPassword || 'N/A';
				if (button) {
					button.textContent = '🙈';
					button.title = 'Click to hide password';
				}
				console.log('Password shown:', plainPassword);
			} else {
				passwordSpan.textContent = '••••••••';
				if (button) {
					button.textContent = '👁️';
					button.title = 'Click to show password';
				}
				console.log('Password hidden');
			}
		}
	}
	</script>
	{% if view == 'activity' or view == 'test_interface' %}
	<script>
	// Track selected answers for each question
	window.classroomAnswers = {}; // Store MCQ answers
	window.classroomCode = {};     // Store coding answers
	
	// DEBUG: Check what's actually rendered
	window.addEventListener('DOMContentLoaded', function() {
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		console.log('🔍 DEBUGGING: Checking rendered HTML structure');
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		
		const allMcqOptions = document.querySelectorAll('.mcq-option-classroom');
		console.log('Total MCQ options found:', allMcqOptions.length);
		
		// Group by question
		const byQuestion = {};
		allMcqOptions.forEach((opt, idx) => {
			const questionIdx = opt.getAttribute('data-question-idx');
			const optionValue = opt.getAttribute('data-option');
			
			if (!byQuestion[questionIdx]) {
				byQuestion[questionIdx] = [];
			}
			byQuestion[questionIdx].push({
				option: optionValue,
				element: opt
			});
		});
		
		console.log('Options grouped by question:');
		Object.keys(byQuestion).sort().forEach(qIdx => {
			console.log(`  Question ${qIdx}: ${byQuestion[qIdx].length} options`);
			byQuestion[qIdx].forEach((item, i) => {
				console.log(`    - Option ${i + 1}: data-option="${item.option}", data-question-idx="${item.element.getAttribute('data-question-idx')}"`);
			});
		});
		
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
	});
	
	// MCQ Selection Handler for Classroom Activities (Works for ANY question number)
	window.selectClassroomMCQ = function(element, questionIdx) {
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		console.log('🔵 SELECT MCQ - Question #' + questionIdx);
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		
		// Validate inputs
		if (!element) {
			console.error('❌ ERROR: No element provided!');
			return;
		}
		if (!questionIdx) {
			console.error('❌ ERROR: No question index provided!');
			return;
		}
		
		// Get the option value FIRST (before any DOM manipulation)
		const optionIdxStr = element.getAttribute('data-option-index');
		const optionText = element.getAttribute('data-option-text') || element.textContent.trim();
		const optionDataIdx = element.getAttribute('data-question-idx');
		const optionIdx = optionIdxStr !== null ? parseInt(optionIdxStr, 10) : NaN;
		
		console.log('📋 Element Details:');
		console.log('   - data-option-index:', optionIdxStr);
		console.log('   - data-option-text:', optionText);
		console.log('   - data-question-idx:', optionDataIdx);
		console.log('   - Passed questionIdx:', questionIdx);
		
		// Security check: Make sure data-question-idx matches questionIdx
		if (optionDataIdx != questionIdx) {
			console.error('❌ MISMATCH! Element has data-question-idx="' + optionDataIdx + '" but function received questionIdx=' + questionIdx);
			console.error('   This indicates a template bug. All options should have the same data-question-idx.');
			return;
		}
		
		// Find all options for THIS specific question
		const selector = `.mcq-option-classroom[data-question-idx="${questionIdx}"]`;
		const allOptions = document.querySelectorAll(selector);
		console.log('🔍 Selector:', selector);
		console.log('🔍 Found', allOptions.length, 'options for question', questionIdx);
		
		if (allOptions.length === 0) {
			console.error('❌ ERROR: No options found for question', questionIdx);
			console.error('   Check that data-question-idx attributes are set correctly in HTML');
			return;
		}
		
		// Log all found options for debugging
		allOptions.forEach((opt, idx) => {
			console.log(`   Option ${idx + 1}: data-option="${opt.getAttribute('data-option')}", data-question-idx="${opt.getAttribute('data-question-idx')}"`);
		});
		
		// STEP 1: Clear all selections in THIS question
		console.log('🔄 Clearing all selections for question', questionIdx);
		allOptions.forEach(opt => {
			opt.style.background = '#f0f9ff';
			opt.style.borderLeft = '3px solid #3b82f6';
			opt.style.fontWeight = 'normal';
			opt.style.border = '1px solid #bfdbfe';
		});
		
		// STEP 2: Highlight the selected option
		console.log('✨ Highlighting selected option index:', optionIdx, 'text:', optionText);
		element.style.background = '#dbeafe';
		element.style.borderLeft = '3px solid #10b981';
		element.style.fontWeight = '600';
		element.style.border = '2px solid #10b981';
		
		// STEP 3: Store in global answers object
		const previousAnswer = window.classroomAnswers[questionIdx];
		// Prefer storing numeric index for MCQ (needed for question-bank validation)
		window.classroomAnswers[questionIdx] = Number.isFinite(optionIdx) ? optionIdx : optionText;
		
		if (previousAnswer) {
			console.log('🔄 RESELECTED: Changed from', previousAnswer, 'to', Number.isFinite(optionIdx) ? optionIdx : optionText, 'for question', questionIdx);
		} else {
			console.log('✅ NEW SELECTION: Stored', Number.isFinite(optionIdx) ? optionIdx : optionText, 'for question', questionIdx);
		}
		
		// STEP 4: Display current state
		console.log('📊 Current Answers State:');
		const answerKeys = Object.keys(window.classroomAnswers).sort((a, b) => parseInt(a) - parseInt(b));
		if (answerKeys.length === 0) {
			console.log('   (empty)');
		} else {
			answerKeys.forEach(key => {
				console.log(`   Question ${key}: "${window.classroomAnswers[key]}"`);
			});
		}
		
		// STEP 5: Update visual status indicator
		const statusEl = document.getElementById(`mcq-status-${questionIdx}`);
		if (statusEl) {
			statusEl.textContent = `✓ Selected: ${optionText}`;
			statusEl.style.color = '#10b981';
			statusEl.style.fontWeight = '600';
			console.log('✅ Status updated for question', questionIdx);
		} else {
			console.warn('⚠️  Status element #mcq-status-' + questionIdx + ' not found');
		}
		
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		console.log('✅ SELECTION COMPLETE - Question #' + questionIdx + ' → Answer: "' + (Number.isFinite(optionIdx) ? optionIdx : optionText) + '"');
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
	};
	
	// Clear MCQ selection (Works for ANY question number)
	window.clearClassroomMCQ = function(questionIdx) {
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		console.log('🔴 CLEAR SELECTION - Question #' + questionIdx);
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		
		// Validate input
		if (!questionIdx) {
			console.error('❌ ERROR: No question index provided!');
			return;
		}
		
		// Check if there's currently a selection for this question
		const currentAnswer = window.classroomAnswers[questionIdx];
		if (currentAnswer) {
			console.log('📋 Currently selected answer:', currentAnswer);
		} else {
			console.log('📋 No answer currently selected for question', questionIdx);
		}
		
		// Find all options for THIS specific question
		const selector = `.mcq-option-classroom[data-question-idx="${questionIdx}"]`;
		const allOptions = document.querySelectorAll(selector);
		console.log('🔍 Selector:', selector);
		console.log('🔍 Found', allOptions.length, 'options for question', questionIdx);
		
		if (allOptions.length === 0) {
			console.error('❌ ERROR: No options found for question', questionIdx);
			console.error('   Check that data-question-idx attributes are set correctly in HTML');
			return;
		}
		
		// STEP 1: Reset all option styles to default
		console.log('🔄 Resetting all option styles for question', questionIdx);
		let clearedCount = 0;
		allOptions.forEach(opt => {
			opt.style.background = '#f0f9ff';
			opt.style.borderLeft = '3px solid #3b82f6';
			opt.style.fontWeight = 'normal';
			opt.style.border = '1px solid #bfdbfe';
			clearedCount++;
		});
		console.log('✅ Cleared', clearedCount, 'option elements');
		
		// STEP 2: Remove from stored answers
		if (window.classroomAnswers[questionIdx]) {
			const removedAnswer = window.classroomAnswers[questionIdx];
			delete window.classroomAnswers[questionIdx];
			console.log('🗑️  Removed answer "' + removedAnswer + '" from storage');
		} else {
			console.log('ℹ️  No stored answer to remove');
		}
		
		// STEP 3: Display current state
		console.log('📊 Current Answers State After Clearing:');
		const answerKeys = Object.keys(window.classroomAnswers).sort((a, b) => parseInt(a) - parseInt(b));
		if (answerKeys.length === 0) {
			console.log('   (empty - no questions answered)');
		} else {
			answerKeys.forEach(key => {
				console.log(`   Question ${key}: "${window.classroomAnswers[key]}"`);
			});
		}
		
		// STEP 4: Clear visual status indicator
		const statusEl = document.getElementById(`mcq-status-${questionIdx}`);
		if (statusEl) {
			statusEl.textContent = '';
			console.log('✅ Status indicator cleared for question', questionIdx);
		} else {
			console.warn('⚠️  Status element #mcq-status-' + questionIdx + ' not found');
		}
		
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
		console.log('✅ CLEAR COMPLETE - Question #' + questionIdx + ' is now unselected');
		console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
	};
	
	window.submitAllClassroomAnswers = async function(activityId, questions) {
		// Collect all answers
		const answers = [];
		let missingAnswers = [];
		
		let hasHandsOn = false;
		// Collect MCQ, coding, hands_on answers
		questions.forEach((question, index) => {
			const questionIdx = index + 1;
			
			if (question.question_type === 'mcq') {
				const selectedAnswer = window.classroomAnswers[questionIdx];
				const hasSelection = !(selectedAnswer === undefined || selectedAnswer === null || (typeof selectedAnswer === 'string' && selectedAnswer.trim() === ''));
				if (!hasSelection) {
					missingAnswers.push(`Question ${questionIdx} (MCQ)`);
				}
				answers.push({
					question_index: questionIdx,
					question_type: 'mcq',
					question_data: question,
					selected_answer: hasSelection ? selectedAnswer : null
				});
			} else if (question.question_type === 'coding') {
				const codeTextarea = document.getElementById(`code-${questionIdx}`);
				const code = codeTextarea ? codeTextarea.value.trim() : '';
				if (!code) {
					missingAnswers.push(`Question ${questionIdx} (Coding)`);
				}
				answers.push({
					question_index: questionIdx,
					question_type: 'coding',
					question_data: question,
					user_code: code || null
				});
			} else if (question.question_type === 'hands_on') {
				hasHandsOn = true;
				const fileInput = document.getElementById(`handson-file-${questionIdx}`);
				const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
				if (!file) {
					missingAnswers.push(`Question ${questionIdx} (Hands-on)`);
				}
				answers.push({
					question_index: questionIdx,
					question_type: 'hands_on',
					question_data: question,
					file_field: `file_q${questionIdx}`
				});
			}
		});
		
		// Warn if any answers are missing
		if (missingAnswers.length > 0) {
			if (!confirm(`⚠️ The following questions have no answers:\n\n${missingAnswers.join('\n')}\n\nDo you want to submit anyway?`)) {
				return;
			}
		}
		
		// Final confirmation
		if (!confirm(`📝 Submit all ${answers.length} answers?\n\nYou cannot change your answers after submitting.`)) {
			return;
		}
		
		try {
			// Show loading state
			const resultDiv = document.getElementById('final-result');
			resultDiv.style.display = 'block';
			resultDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><p style="color: #3b82f6; font-size: 1.2rem;">⏳ Evaluating your answers...</p><p class="muted">This may take a moment...</p></div>';
			
			// Disable all inputs
			document.querySelectorAll('.mcq-option-classroom, textarea, button, input[type=file]').forEach(el => {
				el.disabled = true;
				el.style.opacity = '0.6';
				el.style.cursor = 'not-allowed';
			});
			
			// Send to backend (FormData if hands-on present)
			let response;
			if (hasHandsOn) {
				const fd = new FormData();
				fd.append('activity_id', activityId);
				fd.append('answers', JSON.stringify(answers));
				answers.forEach(ans => {
					if (ans.question_type === 'hands_on'){
						const qi = ans.question_index;
						const fileEl = document.getElementById(`handson-file-${qi}`);
						if (fileEl && fileEl.files && fileEl.files[0]){
							fd.append(ans.file_field, fileEl.files[0]);
						}
					}
				});
				response = await fetch('/classroom/submit_all', { method: 'POST', body: fd });
			} else {
				response = await fetch('/classroom/submit_all', {
				method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ activity_id: activityId, answers })
				});
			}
			
			const result = await response.json();
			
			if (result.ok) {
				// Display final score
				displayFinalResult(result);
			} else {
				resultDiv.innerHTML = `<div style="padding: 2rem; background: #fee2e2; border-radius: 12px; border: 2px solid #dc2626;"><p style="color: #dc2626; font-size: 1.2rem;">❌ Error: ${result.error}</p></div>`;
			}
		} catch (error) {
			console.error('Submission error:', error);
			const resultDiv = document.getElementById('final-result');
			resultDiv.innerHTML = '<div style="padding: 2rem; background: #fee2e2; border-radius: 12px; border: 2px solid #dc2626;"><p style="color: #dc2626;">❌ Failed to submit answers. Please try again.</p></div>';
		}
	};

		// Ensure the same submit flow exists for the Test interface
		window.submitAllTestAnswers = async function(testId, questions) {
			const answers = [];
			let missingAnswers = [];
			let hasHandsOn = false;
			questions.forEach((question, index) => {
				const questionIdx = index + 1;
				if (question.question_type === 'mcq') {
					const selectedAnswer = window.classroomAnswers[questionIdx];
					const hasSelection = !(selectedAnswer === undefined || selectedAnswer === null || (typeof selectedAnswer === 'string' && selectedAnswer.trim() === ''));
					if (!hasSelection) missingAnswers.push(`Question ${questionIdx} (MCQ)`);
					answers.push({ question_index: questionIdx, question_type: 'mcq', question_data: question, selected_answer: hasSelection ? selectedAnswer : null });
				} else if (question.question_type === 'coding') {
					const codeTextarea = document.getElementById(`code-${questionIdx}`);
					const code = codeTextarea ? codeTextarea.value.trim() : '';
					if (!code) missingAnswers.push(`Question ${questionIdx} (Coding)`);
					answers.push({ question_index: questionIdx, question_type: 'coding', question_data: question, user_code: code || null });
				} else if (question.question_type === 'hands_on') {
					hasHandsOn = true;
					const fileInput = document.getElementById(`handson-file-${questionIdx}`);
					const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
					if (!file) missingAnswers.push(`Question ${questionIdx} (Hands-on)`);
					answers.push({ question_index: questionIdx, question_type: 'hands_on', question_data: question, file_field: `file_q${questionIdx}` });
				}
			});

			if (missingAnswers.length > 0) {
				if (!confirm(`⚠️ The following questions have no answers:\n\n${missingAnswers.join('\n')}\n\nDo you want to submit anyway?`)) return;
			}
			if (!confirm(`📝 Submit all ${answers.length} answers?\n\nYou cannot change your answers after submitting.`)) return;

			try {
				const resultDiv = document.getElementById('final-result');
				resultDiv.style.display = 'block';
				resultDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><p style="color: #3b82f6; font-size: 1.2rem;">⏳ Evaluating your answers...</p><p class="muted">This may take a moment...</p></div>';
				document.querySelectorAll('.mcq-option-classroom, textarea, button, input[type=file]').forEach(el => { el.disabled = true; el.style.opacity = '0.6'; el.style.cursor = 'not-allowed'; });
				let response;
				if (hasHandsOn) {
					const fd = new FormData();
					fd.append('test_id', testId);
					fd.append('answers', JSON.stringify(answers));
					answers.forEach(ans => {
						if (ans.question_type === 'hands_on'){
							const qi = ans.question_index;
							const fileEl = document.getElementById(`handson-file-${qi}`);
							if (fileEl && fileEl.files && fileEl.files[0]){
								fd.append(ans.file_field, fileEl.files[0]);
							}
						}
					});
					response = await fetch('/test/submit_all', { method: 'POST', body: fd });
				} else {
					response = await fetch('/test/submit_all', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ test_id: testId, answers }) });
				}
				const result = await response.json();
				if (result.ok) {
					displayFinalResult(result);
				} else {
					resultDiv.innerHTML = `<div style=\"padding: 2rem; background: #fee2e2; border-radius: 12px; border: 2px solid #dc2626;\"><p style=\"color: #dc2626; font-size: 1.2rem;\">❌ Error: ${result.error}</p></div>`;
			}
		} catch (error) {
			console.error('Submission error:', error);
			const resultDiv = document.getElementById('final-result');
			resultDiv.innerHTML = '<div style="padding: 2rem; background: #fee2e2; border-radius: 12px; border: 2px solid #dc2626;"><p style="color: #dc2626;">❌ Failed to submit answers. Please try again.</p></div>';
		}
	};
	
	// Display final results
	function displayFinalResult(result) {
		const resultDiv = document.getElementById('final-result');
		
		let html = '<div style="padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; text-align: center;">';
		html += '<h2 style="margin: 0 0 1rem 0; font-size: 2rem;">🎉 Submission Complete!</h2>';
		html += `<div style="font-size: 3rem; font-weight: 700; margin: 1rem 0;">${result.correct_count}/${result.total_questions}</div>`;
		html += `<div style="font-size: 1.5rem; margin: 0.5rem 0;">${result.percentage}%</div>`;
		html += `<p style="margin: 1rem 0 0 0; opacity: 0.9;">You answered ${result.correct_count} out of ${result.total_questions} questions correctly.</p>`;
		html += '</div>';
		
		// Detailed breakdown
		if (result.details && result.details.length > 0) {
			html += '<div style="margin-top: 2rem;">';
			html += '<h3>📊 Detailed Breakdown</h3>';
			
			result.details.forEach((detail, index) => {
				html += '<div style="padding: 1rem; margin: 1rem 0; background: #f9fafb; border-radius: 8px; border-left: 4px solid ';
				html += detail.is_correct ? '#10b981' : '#dc2626';
				html += ';">';
				html += `<h4 style="margin: 0 0 0.5rem 0; color: #000000;">Question ${detail.question_index}</h4>`;
				html += `<p style="margin: 0; color: #666;">Type: ${detail.question_type === 'mcq' ? 'Multiple Choice' : 'Coding'}</p>`;
				html += `<p style="margin: 0.5rem 0 0 0; font-weight: 600; color: ${detail.is_correct ? '#10b981' : '#dc2626'};">`;
				html += detail.is_correct ? '✅ Correct' : '❌ Incorrect';
				html += '</p>';
				html += '</div>';
			});
			
			html += '</div>';
		}

		// Initialize Test Navigator and Timer
		(function(){
			if ('{{ view }}' !== 'test_interface') return;
			const questions = Array.from(document.querySelectorAll('.test-question'));
			if (questions.length === 0) return;
			let current = 1;
			const total = questions.length;
			const btnPrev = document.getElementById('btnPrev');
			const btnNext = document.getElementById('btnNext');
			const btnSubmit = document.getElementById('btnSubmit');
			const navError = document.getElementById('nav-error');
			function show(idx){
				questions.forEach((el,i)=>{ el.style.display = (i+1) === idx ? '' : 'none'; });
				if (btnPrev) btnPrev.disabled = (idx === 1);
				if (btnNext) btnNext.style.display = (idx === total) ? 'none' : '';
				if (btnSubmit) btnSubmit.style.display = (idx === total) ? '' : 'none';
				navError.textContent='';
			}
			function isAnswered(idx){
				const el = document.querySelector(`.test-question[data-index="${idx}"]`);
				const type = el ? el.getAttribute('data-type') : '';
				if (type === 'mcq') return window.classroomAnswers[idx] !== undefined && window.classroomAnswers[idx] !== null && window.classroomAnswers[idx] !== '';
				if (type === 'coding'){
					const ta = document.getElementById(`code-${idx}`);
					return !!(ta && ta.value.trim());
				}
				if (type === 'hands_on'){
					const fi = document.getElementById(`handson-file-${idx}`);
					return !!(fi && fi.files && fi.files[0]);
				}
				return true;
			}
			if (btnPrev) btnPrev.addEventListener('click', ()=>{ if (current>1){ current--; show(current);} });
			if (btnNext) btnNext.addEventListener('click', ()=>{
				if (!isAnswered(current)) { navError.textContent = `Please answer Question ${current} before proceeding.`; return; }
				if (current < total){ current++; show(current); }
			});
			{% if view == 'test_interface' %}
			if (btnSubmit) btnSubmit.addEventListener('click', ()=>{
				if (!isAnswered(current)) { navError.textContent = `Please answer Question ${current} before proceeding.`; return; }
				try { window.submitAllTestAnswers('{{ test.test_id }}', {{ questions | tojson | forceescape }}); } catch(e) {}
			});
			{% endif %}
			show(current);
			// Timer
			try{
				const endMs = {% if view == 'test_interface' and end_time_ms is defined %}{{ end_time_ms|tojson }}{% else %}null{% endif %};
				if (endMs){
					const timerEl = document.getElementById('test-timer');
					function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
					const iv = setInterval(()=>{
						const remain = endMs - Date.now();
						if (timerEl) timerEl.textContent = fmt(remain);
						{% if view == 'test_interface' %}
						if (remain <= 0){ clearInterval(iv); try{ window.submitAllTestAnswers('{{ test.test_id }}', {{ questions | tojson | forceescape }}); }catch(e){} }
						{% endif %}
					}, 1000);
				}
			}catch(e){}
		})();
		
		html += '<div style="margin-top: 2rem; text-align: center;">';
		html += '<button class="btn" onclick="window.location.href=\'/classroom\'">Return to Classroom</button>';
		html += '</div>';
		
		resultDiv.innerHTML = html;
	}
	
	document.addEventListener('DOMContentLoaded', function() {
		// Handle question-specific code execution
		document.querySelectorAll('.run-question-code').forEach(button => {
			button.addEventListener('click', async function() {
				const questionNum = this.dataset.question;
				const questionText = this.dataset.questionText;
				const codeTextarea = document.getElementById(`code-${questionNum}`);
				const outputDiv = document.getElementById(`output-${questionNum}`);
				
				const code = codeTextarea.value.trim();
				if (!code) {
					outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
					return;
				}
				
				// Show loading state
				this.disabled = true;
				this.textContent = '⏳ Running...';
				outputDiv.innerHTML = '<p class="muted">Executing code and validating...</p>';
				
				try {
					const formData = new FormData();
					formData.append('code', code);
					formData.append('question_text', questionText);
					
					const response = await fetch('/question/execute', {
						method: 'POST',
						body: formData
					});
					
					const result = await response.json();
					
					// Display results
					if (result.success) {
						outputDiv.className = 'output-box output-success';
						let output = '';
						if (result.output) {
							output += '=== CODE OUTPUT ===\n';
							output += result.output;
						}
						if (result.error) {
							output += '\n\n=== ERRORS ===\n';
							output += result.error;
						}
						if (result.validation) {
							output += '\n\n=== AI VALIDATION ===\n';
							output += result.validation;
						}
						outputDiv.textContent = output || 'Code executed successfully (no output)';
					} else {
						outputDiv.className = 'output-box output-error';
						outputDiv.textContent = `Error: ${result.error}`;
					}
				} catch (error) {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Network error: ${error.message}`;
				} finally {
					// Reset button state
					this.disabled = false;
					this.textContent = '▶️ Run Code';
				}
			});
		});
		
		// Handle clear code buttons
		document.querySelectorAll('.clear-question-code').forEach(button => {
			button.addEventListener('click', function() {
				const questionNum = this.dataset.question;
				const codeTextarea = document.getElementById(`code-${questionNum}`);
				const outputDiv = document.getElementById(`output-${questionNum}`);
				
				codeTextarea.value = '';
				outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
				outputDiv.className = 'output-box';
			});
		});
		
		// Keyboard shortcuts for code editors
		document.querySelectorAll('.question-code').forEach(textarea => {
			textarea.addEventListener('keydown', function(e) {
				if (e.ctrlKey && e.key === 'Enter') {
					e.preventDefault();
					const questionNum = this.id.split('-')[1];
					const runButton = document.querySelector(`[data-question="${questionNum}"].run-question-code`);
					if (runButton) {
						runButton.click();
					}
				}
			});
		});
	});

	// Lightweight anti-cheat hooks for test interface
	(function(){
		if ('{{ view }}' !== 'test_interface') return;
		async function reportViolation(type){
			try {
				await fetch('/test/violation', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ type })
				});
			} catch (e) {}
		}
		// Block right-click
		document.addEventListener('contextmenu', function(e){ e.preventDefault(); reportViolation('right_click'); });
		// Block copy/paste/cut shortcuts
		document.addEventListener('keydown', function(e){
			const k = (e.key || '').toLowerCase();
			if (e.ctrlKey && (k === 'c' || k === 'v' || k === 'x' || k === 'tab')){
				e.preventDefault();
				reportViolation('ctrl+' + k);
			}
		});
		// Also block clipboard events
		document.addEventListener('copy', function(e){ e.preventDefault(); reportViolation('copy'); });
		document.addEventListener('paste', function(e){ e.preventDefault(); reportViolation('paste'); });
		document.addEventListener('cut', function(e){ e.preventDefault(); reportViolation('cut'); });
		// Detect tab/window switch
		document.addEventListener('visibilitychange', function(){ if (document.hidden) reportViolation('tab_switch'); });
		window.addEventListener('blur', function(){ reportViolation('window_blur'); });
	})();
	</script>
	{% endif %}

	{% if view == 'admin_dashboard' %}
	<script>
	// Handle CSV bulk upload from dashboard
	document.getElementById('dashboardBulkUploadForm').addEventListener('submit', async function(e) {
		e.preventDefault();
		
		const fileInput = document.getElementById('dashboardCsvFile');
		const file = fileInput.files[0];
		
		if (!file) {
			alert('Please select a CSV file');
			return;
		}
		
		// Show loading state
		document.getElementById('dashboardUploadBtnText').style.display = 'none';
		document.getElementById('dashboardUploadBtnLoading').style.display = 'inline';
		document.getElementById('dashboardUploadResults').style.display = 'none';
		
		const formData = new FormData();
		formData.append('csv_file', file);
		
		try {
			const response = await fetch('/admin/bulk_create_users', {
				method: 'POST',
				body: formData
			});
			
			const data = await response.json();
			
			// Hide loading state
			document.getElementById('dashboardUploadBtnText').style.display = 'inline';
			document.getElementById('dashboardUploadBtnLoading').style.display = 'none';
			
			// Display results
			displayDashboardUploadResults(data);
			
			// Reset form
			fileInput.value = '';
			
			// Reload page after 3 seconds if users were created
			if (data.created > 0) {
				setTimeout(() => {
					location.reload();
				}, 3000);
			}
			
		} catch (error) {
			document.getElementById('dashboardUploadBtnText').style.display = 'inline';
			document.getElementById('dashboardUploadBtnLoading').style.display = 'none';
			alert('Error uploading file: ' + error.message);
		}
	});
	
	function displayDashboardUploadResults(data) {
		const resultsDiv = document.getElementById('dashboardUploadResults');
		
		if (!data.ok) {
			resultsDiv.innerHTML = `
				<div style="background: #fecaca; padding: 1rem; border-radius: 8px; border: 2px solid #dc2626;">
					<h4 style="color: #dc2626; margin: 0 0 0.5rem 0;">❌ Upload Failed</h4>
					<p style="color: #000000; margin: 0;">${data.error}</p>
				</div>
			`;
			resultsDiv.style.display = 'block';
			return;
		}
		
		let html = `
			<div style="background: #d1fae5; padding: 1rem; border-radius: 8px; border: 2px solid #10b981; margin-bottom: 1rem;">
				<h4 style="color: #065f46; margin: 0 0 0.5rem 0;">✅ Upload Complete!</h4>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 0.75rem;">
					<div style="text-align: center;">
						<p style="font-size: 2rem; font-weight: 700; margin: 0; color: #10b981;">${data.created}</p>
						<p style="margin: 0; color: #000000; font-size: 0.9rem;">Created</p>
					</div>
					<div style="text-align: center;">
						<p style="font-size: 2rem; font-weight: 700; margin: 0; color: #f59e0b;">${data.skipped}</p>
						<p style="margin: 0; color: #000000; font-size: 0.9rem;">Skipped</p>
					</div>
					<div style="text-align: center;">
						<p style="font-size: 2rem; font-weight: 700; margin: 0; color: #dc2626;">${data.errors}</p>
						<p style="margin: 0; color: #000000; font-size: 0.9rem;">Errors</p>
					</div>
				</div>
			</div>
		`;
		
		// Show created users
		if (data.details.created_users && data.details.created_users.length > 0) {
			html += `
				<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #bfdbfe;">
					<h5 style="color: #1e40af; margin: 0 0 0.5rem 0;">✅ Created Users (${data.details.created_users.length}):</h5>
					<div style="max-height: 150px; overflow-y: auto; color: #000000;">
						${data.details.created_users.map(user => `<p style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">• ${user}</p>`).join('')}
					</div>
				</div>
			`;
		}
		
		// Show skipped users
		if (data.details.skipped_users && data.details.skipped_users.length > 0) {
			html += `
				<div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #fbbf24;">
					<h5 style="color: #92400e; margin: 0 0 0.5rem 0;">⚠️ Skipped Users (${data.details.skipped_users.length}):</h5>
					<div style="max-height: 150px; overflow-y: auto; color: #000000;">
						${data.details.skipped_users.map(user => `<p style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">• ${user}</p>`).join('')}
					</div>
				</div>
			`;
		}
		
		// Show errors
		if (data.details.errors && data.details.errors.length > 0) {
			html += `
				<div style="background: #fecaca; padding: 1rem; border-radius: 8px; border: 1px solid #dc2626;">
					<h5 style="color: #dc2626; margin: 0 0 0.5rem 0;">❌ Errors (${data.details.errors.length}):</h5>
					<div style="max-height: 200px; overflow-y: auto; color: #000000;">
						${data.details.errors.map(error => `<p style="margin: 0.25rem 0; font-size: 0.9rem;">• ${error}</p>`).join('')}
					</div>
				</div>
			`;
		}
		
		if (data.created > 0) {
			html += `<p style="margin-top: 1rem; color: #059669; font-weight: 600;">🔄 Page will reload in 3 seconds...</p>`;
		}
		
		resultsDiv.innerHTML = html;
		resultsDiv.style.display = 'block';
	}
	</script>
	{% endif %}

	{% if view == 'admin_users' %}
	<script>
	async function deleteUser(username) {
		if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/users/delete/${username}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting user');
			}
		} catch (error) {
			alert('Error deleting user: ' + error.message);
		}
	}
	
	</script>
	{% endif %}

	{% if view == 'admin_attempt_activity' %}
	<script>
	// Question navigation function
	function showQuestion(questionNum) {
		// Hide all questions
		document.querySelectorAll('.question-card').forEach(card => {
			card.style.display = 'none';
		});
		
		// Show selected question
		const selectedCard = document.getElementById(`question-${questionNum}`);
		if (selectedCard) {
			selectedCard.style.display = 'block';
		}
		
		// Update navigation buttons
		document.querySelectorAll('.nav-btn').forEach(btn => {
			btn.classList.remove('active');
		});
		const activeBtn = document.querySelector(`[data-question="${questionNum}"]`);
		if (activeBtn) {
			activeBtn.classList.add('active');
		}
	}
	
	// JavaScript for admin activity code execution
	document.addEventListener('DOMContentLoaded', function() {
		document.querySelectorAll('.run-admin-question-code').forEach(button => {
			button.addEventListener('click', async function() {
				const questionNum = this.dataset.question;
				const questionText = this.dataset.questionText;
				const codeTextarea = document.getElementById(`admin-code-${questionNum}`);
				const outputDiv = document.getElementById(`admin-output-${questionNum}`);
				
				const code = codeTextarea.value.trim();
				if (!code) {
					outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
					return;
				}
				
				this.disabled = true;
				this.textContent = '⏳ Running...';
				outputDiv.innerHTML = '<p class="muted">Executing code and validating...</p>';
				
				try {
					const formData = new FormData();
					formData.append('code', code);
					formData.append('question_text', questionText);
					
					const response = await fetch('/admin/question/execute', {
						method: 'POST',
						body: formData
					});
					
					const result = await response.json();
					
					if (result.success) {
						outputDiv.className = 'output-box output-success';
						let output = '';
						if (result.output) {
							output += '=== CODE OUTPUT ===\n';
							output += result.output;
						}
						if (result.error) {
							output += '\n\n=== ERRORS ===\n';
							output += result.error;
						}
						if (result.validation) {
							output += '\n\n=== AI VALIDATION ===\n';
							output += result.validation;
						}
						outputDiv.textContent = output || 'Code executed successfully (no output)';
					} else {
						outputDiv.className = 'output-box output-error';
						outputDiv.textContent = `Error: ${result.error}`;
					}
				} catch (error) {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Network error: ${error.message}`;
				} finally {
					this.disabled = false;
					this.textContent = '▶️ Run Code';
				}
			});
		});
		
		document.querySelectorAll('.clear-admin-question-code').forEach(button => {
			button.addEventListener('click', function() {
				const questionNum = this.dataset.question;
				const codeTextarea = document.getElementById(`admin-code-${questionNum}`);
				const outputDiv = document.getElementById(`admin-output-${questionNum}`);
				
				codeTextarea.value = '';
				outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
				outputDiv.className = 'output-box';
			});
		});
		
		document.querySelectorAll('#admin-code-\\d+').forEach(textarea => {
			textarea.addEventListener('keydown', function(e) {
				if (e.ctrlKey && e.key === 'Enter') {
					e.preventDefault();
					const questionNum = this.id.split('-')[2];
					const runButton = document.querySelector(`[data-question="${questionNum}"].run-admin-question-code`);
					if (runButton) {
						runButton.click();
					}
				}
			});
		});
	});
	</script>
	{% endif %}

	{% if view == 'admin_activities' %}
	<script>
	async function deleteActivity(activityId) {
		if (!confirm(`Are you sure you want to delete this activity?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/activities/delete/${activityId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting activity');
			}
		} catch (error) {
			alert('Error deleting activity: ' + error.message);
		}
	}
	</script>
	{% endif %}

	{% if view == 'admin_tests' %}
	<script>
	async function deleteTest(testId) {
		if (!confirm(`Are you sure you want to delete test "${testId}"?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/tests/delete/${testId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting test');
			}
		} catch (error) {
			alert('Error deleting test: ' + error.message);
		}
	}
	</script>
	{% endif %}

	{% if view == 'compiler' %}
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		const codeTextarea = document.getElementById('python-code');
		const runButton = document.getElementById('run-code');
		const clearButton = document.getElementById('clear-code');
		const outputDiv = document.getElementById('compiler-output');
		
		// Run code function
		async function runCode() {
			const code = codeTextarea.value.trim();
			if (!code) {
				outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
				return;
			}
			
			// Show loading state
			runButton.disabled = true;
			runButton.textContent = '⏳ Running...';
			outputDiv.innerHTML = '<p class="muted">Executing code...</p>';
			
			try {
				const formData = new FormData();
				formData.append('code', code);
				
				const response = await fetch('/compiler/execute', {
					method: 'POST',
					body: formData
				});
				
				const result = await response.json();
				
				// Display results
				if (result.success) {
					outputDiv.className = 'output-box output-success';
					let output = '';
					if (result.output) {
						output += result.output;
					}
					if (result.error) {
						output += '\n--- Errors ---\n' + result.error;
					}
					outputDiv.textContent = output || 'Code executed successfully (no output)';
				} else {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Error: ${result.error}`;
				}
			} catch (error) {
				outputDiv.className = 'output-box output-error';
				outputDiv.textContent = `Network error: ${error.message}`;
			} finally {
				// Reset button state
				runButton.disabled = false;
				runButton.textContent = '▶️ Run Code';
			}
		}
		
		// Clear code function
		function clearCode() {
			codeTextarea.value = '';
			outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
			outputDiv.className = 'output-box';
		}
		
		// Event listeners
		runButton.addEventListener('click', runCode);
		clearButton.addEventListener('click', clearCode);
		
		// Keyboard shortcut: Ctrl+Enter to run code
		codeTextarea.addEventListener('keydown', function(e) {
			if (e.ctrlKey && e.key === 'Enter') {
				e.preventDefault();
				runCode();
			}
		});
	});
	</script>
	{% endif %}
	<script>
		// Coding Playground - Client-side JavaScript

		// Set current year
		document.getElementById('year') && (document.getElementById('year').textContent = new Date().getFullYear());

		// Utility functions
		function showAlert(message, type = 'info') {
			const alertDiv = document.createElement('div');
			alertDiv.className = `alert ${type}`;
			alertDiv.textContent = message;
			
			// Insert at the top of the page
			const container = document.querySelector('.container');
			if (container) {
				container.insertBefore(alertDiv, container.firstChild);
				
				// Auto-remove after 5 seconds
				setTimeout(() => {
					alertDiv.remove();
				}, 5000);
			}
		}

		function togglePassword(inputId) {
			const input = document.getElementById(inputId);
			const toggle = document.querySelector(`[onclick="togglePassword('${inputId}')"]`);
			
			if (input.type === 'password') {
				input.type = 'text';
				toggle.textContent = 'Hide';
			} else {
				input.type = 'password';
				toggle.textContent = 'Show';
			}
		}

		// Form validation
		function validateForm(formId) {
			const form = document.getElementById(formId);
			if (!form) return false;
			
			const requiredFields = form.querySelectorAll('[required]');
			let isValid = true;
			
			requiredFields.forEach(field => {
				if (!field.value.trim()) {
					field.style.borderColor = '#dc2626';
					isValid = false;
				} else {
					field.style.borderColor = '#334155';
				}
			});
			
			return isValid;
		}

		// AJAX helper
		async function makeRequest(url, options = {}) {
			try {
				const response = await fetch(url, {
					headers: {
						'Content-Type': 'application/json',
						...options.headers
					},
					...options
				});
				
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				
				return await response.json();
			} catch (error) {
				console.error('Request failed:', error);
				showAlert(`Network error: ${error.message}`, 'danger');
				throw error;
			}
		}

		// Delete confirmation
		function confirmDelete(itemType, itemName) {
			return confirm(`Are you sure you want to delete this ${itemType}?\n\n${itemName}\n\nThis action cannot be undone.`);
		}

		// Countdown timer
		function startCountdown(targetTime, elementId) {
			const element = document.getElementById(elementId);
			if (!element) return;
			
			function updateCountdown() {
				const now = new Date().getTime();
				const target = new Date(targetTime).getTime();
				const distance = target - now;
				
				if (distance < 0) {
					element.innerHTML = "Time's up!";
					return;
				}
				
				const days = Math.floor(distance / (1000 * 60 * 60 * 24));
				const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
				const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
				const seconds = Math.floor((distance % (1000 * 60)) / 1000);
				
				let countdownText = "";
				if (days > 0) countdownText += days + "d ";
				if (hours > 0) countdownText += hours + "h ";
				if (minutes > 0) countdownText += minutes + "m ";
				countdownText += seconds + "s";
				
				element.innerHTML = countdownText;
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		}

		// Code execution
		async function executeCode(code, outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (!outputElement) return;
			
			outputElement.textContent = "Running code...";
			outputElement.className = "output-area";
			
			try {
				const response = await makeRequest('/compiler/execute', {
					method: 'POST',
					body: JSON.stringify({ code: code })
				});
				
				if (response.success) {
					outputElement.textContent = response.output || "No output";
					outputElement.className = "output-area";
				} else {
					outputElement.textContent = `Error: ${response.error}`;
					outputElement.className = "output-area alert";
				}
			} catch (error) {
				outputElement.textContent = `Execution failed: ${error.message}`;
				outputElement.className = "output-area alert";
			}
		}

		// Question code execution
		async function executeQuestionCode(questionId, code, outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (!outputElement) return;
			
			outputElement.textContent = "Running code...";
			outputElement.className = "output-area";
			
			try {
				const response = await makeRequest('/question/execute', {
					method: 'POST',
					body: JSON.stringify({ 
						question_id: questionId,
						code: code 
					})
				});
				
				if (response.success) {
					outputElement.textContent = response.output || "No output";
					outputElement.className = "output-area";
					
					if (response.validation) {
						const validationDiv = document.createElement('div');
						validationDiv.className = 'alert info';
						validationDiv.innerHTML = `<strong>AI Validation:</strong><br>${response.validation}`;
						outputElement.parentNode.appendChild(validationDiv);
					}
				} else {
					outputElement.textContent = `Error: ${response.error}`;
					outputElement.className = "output-area alert";
				}
			} catch (error) {
				outputElement.textContent = `Execution failed: ${error.message}`;
				outputElement.className = "output-area alert";
			}
		}

		// Admin question code execution
		async function executeAdminQuestionCode(questionId, code, outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (!outputElement) return;
			
			outputElement.textContent = "Running code...";
			outputElement.className = "output-area";
			
			try {
				const response = await makeRequest('/admin/question/execute', {
					method: 'POST',
					body: JSON.stringify({ 
						question_id: questionId,
						code: code 
					})
				});
				
				if (response.success) {
					outputElement.textContent = response.output || "No output";
					outputElement.className = "output-area";
					
					if (response.validation) {
						const validationDiv = document.createElement('div');
						validationDiv.className = 'alert info';
						validationDiv.innerHTML = `<strong>AI Validation:</strong><br>${response.validation}`;
						outputElement.parentNode.appendChild(validationDiv);
					}
				} else {
					outputElement.textContent = `Error: ${response.error}`;
					outputElement.className = "output-area alert";
				}
			} catch (error) {
				outputElement.textContent = `Execution failed: ${error.message}`;
				outputElement.className = "output-area alert";
			}
		}

		// Clear output
		function clearOutput(outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (outputElement) {
				outputElement.textContent = "";
				outputElement.className = "output-area";
			}
		}

		// Test restrictions removed - tests now display properly without restrictions

		// Auto-save form data
		function autoSaveForm(formId) {
			const form = document.getElementById(formId);
			if (!form) return;
			
			const inputs = form.querySelectorAll('input, textarea, select');
			
			inputs.forEach(input => {
			// Skip file inputs (cannot be set programmatically for security reasons)
			if (input.type === 'file') return;
			
				// Load saved data
				const saved = localStorage.getItem(`form_${formId}_${input.name}`);
				if (saved) {
					input.value = saved;
				}
				
				// Save on change
				input.addEventListener('input', () => {
					localStorage.setItem(`form_${formId}_${input.name}`, input.value);
				});
			});
		}

		// Clear auto-saved data
		function clearAutoSave(formId) {
			const form = document.getElementById(formId);
			if (!form) return;
			
			const inputs = form.querySelectorAll('input, textarea, select');
			inputs.forEach(input => {
			// Skip file inputs
			if (input.type === 'file') return;
				localStorage.removeItem(`form_${formId}_${input.name}`);
			});
		}

		// Initialize auto-save for forms
		document.addEventListener('DOMContentLoaded', () => {
			const forms = document.querySelectorAll('form[id]');
			forms.forEach(form => autoSaveForm(form.id));
		});

		// Export functions to global scope for HTML onclick handlers
		window.toggleUserPassword = toggleUserPassword;
		window.togglePassword = togglePassword;
		window.executeCode = executeCode;
		window.executeQuestionCode = executeQuestionCode;
		window.executeAdminQuestionCode = executeAdminQuestionCode;
		window.clearOutput = clearOutput;
		window.confirmDelete = confirmDelete;
		window.startCountdown = startCountdown;
		window.showAlert = showAlert;

			// ===== Question Bank & Activity/Test Generation (No OpenAI) =====
			// All data (question banks, activities, tests, submissions) are stored in MongoDB only
			
			// Export functions to global scope so they're available everywhere
			window.QuestionBankModule = window.QuestionBankModule || {};
			
			(function(){
				function uid(){ return Math.random().toString(36).slice(2,10); }

				function ensureContainers(){
					if (document.getElementById('localAttemptContainer')) return;
					const host = document.createElement('section');
					host.className = 'card';
					host.id = 'localAttemptContainer';
					host.style.display = 'none';
					host.innerHTML = `
						<h2 id="attemptTitle">Attempt</h2>
						<div id="attemptMeta" class="muted" style="margin-bottom: 0.75rem;"></div>
						<div id="attemptQuestions" style="display: grid; gap: 0.75rem;"></div>
						<div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
							<button class="btn" id="attemptSubmitBtn">Submit</button>
							<button class="btn secondary" id="attemptCancelBtn">Cancel</button>
						</div>
						<div id="attemptResult" style="margin-top: 0.75rem;"></div>
					`;
					document.body.insertBefore(host, document.body.lastElementChild);
				}

				async function renderSubjectModuleOptions(){
					const allSelectors = [
						{university: 'classroomUniversity', subject: 'classroomSubject', module: 'classroomModule'},
						{university: 'testUniversity', subject: 'testSubject', module: 'testModule'}
					];
					
					try {
						const response = await fetch('/api/question-bank/subjects');
						const result = await response.json();
						if (!result.ok) {
							console.error('Failed to fetch subjects:', result.error);
							return;
						}
						const grouped = result.grouped || {};
						allSelectors.forEach(({university: uniId, subject: subjId, module: modId})=>{
							const uniSel = document.getElementById(uniId);
							const subjSel = document.getElementById(subjId);
							const modSel = document.getElementById(modId);
							if (!uniSel || !subjSel || !modSel) return;
							// Fill universities
							uniSel.innerHTML = '';
							Object.keys(grouped).sort().forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; uniSel.appendChild(o); });
							// When university changes, populate subjects
							function updateSubjects(){
								subjSel.innerHTML=''; modSel.innerHTML='';
								const u = uniSel.value;
								const subs = (grouped[u]||[]).map(x=>x.subject).filter(Boolean);
								const uniqSubs = Array.from(new Set(subs));
								if (uniqSubs.length === 0){ subjSel.innerHTML='<option value="">No subjects</option>'; modSel.innerHTML='<option value="">-</option>'; return; }
								uniqSubs.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; subjSel.appendChild(o); });
								updateModules();
							}
							async function updateModules(){
								modSel.innerHTML='';
								const u = uniSel.value; const s = subjSel.value;
								if (!u || !s){ modSel.innerHTML='<option value="">-</option>'; return; }
								try{
									const modResponse = await fetch(`/api/question-bank/modules?university=${encodeURIComponent(u)}&subject=${encodeURIComponent(s)}`);
									const modResult = await modResponse.json();
									const modules = modResult.modules || [];
									if (modules.length === 0){ modSel.innerHTML = '<option value="">No modules</option>'; return; }
									modules.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; modSel.appendChild(o); });
								}catch(err){
									console.error('Failed to fetch modules:', err);
									modSel.innerHTML = '<option value="">Error loading modules</option>';
								}
							}
							uniSel.onchange = updateSubjects;
							subjSel.onchange = updateModules;
							// Initialize
							updateSubjects();
						});
					} catch(err) {
						console.error('Failed to fetch subjects:', err);
					}
				}

				function addModuleField(){
					const c = document.getElementById('qgModulesContainer');
					const idx = c.children.length + 1;
					const wrap = document.createElement('div');
					wrap.style.marginTop = '1rem';
					wrap.style.border = '1px solid #e5e7eb';
					wrap.style.borderRadius = '8px';
					wrap.style.padding = '1rem';
					wrap.style.background = '#f9fafb';
					const moduleId = `module_${idx}_${Date.now()}`;
					wrap.innerHTML = `
						<label style="display: block; margin-bottom: 0.5rem;"><strong>Module Name #${idx}</strong>
							<input type="text" class="qgModuleName" placeholder="e.g., Arrays" required style="margin-top: 0.25rem;">
						</label>
						<div style="margin-top: 0.75rem;">
							<div style="display: flex; gap: 0.5rem; border-bottom: 2px solid #e5e7eb; margin-bottom: 0.5rem;">
								<button type="button" class="qgTabBtn active" data-tab="plain" data-module="${moduleId}" style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid #667eea; margin-bottom: -2px;">📝 Plain Text</button>
								<button type="button" class="qgTabBtn" data-tab="json" data-module="${moduleId}" style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">🔧 JSON</button>
							</div>
							<div id="${moduleId}_plain" class="qgTabContent" style="display: block;">
								<label style="display: block; margin-bottom: 0.5rem;"><strong>Paste Questions in Plain Text Format</strong>
									<textarea class="qgModulePlainText" rows="12" placeholder='Example formats:
Q: What is your name?
A: YELLOW
B: NORM
C: AYUSHMAN
D: YASH
Correct: C

Q: What is 2+2?
A) 3
B) 4
C) 5
D) 6
Answer: B

Q: Reverse a string
Description: Write code to reverse a string
Answer: function reverseString(s){return s.split("").reverse().join("")}

---
You can paste multiple questions. Separate them with blank lines or Q1, Q2, etc.' style="margin-top: 0.25rem;"></textarea>
								</label>
								<button type="button" class="btn secondary qgConvertBtn" data-module="${moduleId}" style="margin-top: 0.5rem;">🔄 Convert to JSON</button>
								<div class="qgConvertStatus" data-module="${moduleId}" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
							</div>
							<div id="${moduleId}_json" class="qgTabContent" style="display: none;">
								<label style="display: block; margin-bottom: 0.5rem;"><strong>Questions JSON for this module</strong>
									<textarea class="qgModuleQuestions" rows="12" placeholder='Paste JSON array of questions' required style="margin-top: 0.25rem;"></textarea>
								</label>
							</div>
						</div>
					`;
					c.appendChild(wrap);
					
					// Wire up tab switching
					wrap.querySelectorAll('.qgTabBtn').forEach(btn => {
						btn.addEventListener('click', function(){
							const module = this.dataset.module;
							const tab = this.dataset.tab;
							wrap.querySelectorAll('.qgTabBtn').forEach(b => b.classList.remove('active'));
							wrap.querySelectorAll(`[id^="${module}_"]`).forEach(d => d.style.display = 'none');
							this.classList.add('active');
							document.getElementById(`${module}_${tab}`).style.display = 'block';
						});
					});
					
					// Wire up convert button
					const convertBtn = wrap.querySelector('.qgConvertBtn');
					if (convertBtn) {
						convertBtn.addEventListener('click', function(){
							const module = this.dataset.module;
							const plainText = wrap.querySelector('.qgModulePlainText')?.value || '';
							const jsonTextarea = wrap.querySelector('.qgModuleQuestions');
							const statusDiv = wrap.querySelector('.qgConvertStatus');
							
							try {
								const parsed = parsePlainTextQuestions(plainText);
								if (parsed.length === 0) {
									statusDiv.innerHTML = '<span style="color: #dc2626;">❌ No questions found. Check the format.</span>';
									return;
								}
								jsonTextarea.value = JSON.stringify(parsed, null, 2);
								statusDiv.innerHTML = `<span style="color: #10b981;">✅ Converted ${parsed.length} question(s) successfully!</span>`;
								// Switch to JSON tab to show result
								wrap.querySelector('.qgTabBtn[data-tab="json"]').click();
							} catch(err) {
								statusDiv.innerHTML = `<span style="color: #dc2626;">❌ Error: ${err.message}</span>`;
							}
						});
					}
				}
				
				function parsePlainTextQuestions(text){
					if (!text || !text.trim()) return [];
					// Normalize odd unicode spaces (EM/EN/NBSP) to simple space
					const normalizeSpaces = (s) => s.replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000]/g, ' ');
					const softTrim = (s) => normalizeSpaces(s || '').replace(/[\t ]+/g, ' ').trim();
					
					const questions = [];
					const rawLines = text.split('\n'); // keep blanks for code blocks
					
					let currentQ = null;
					let currentOptions = [];
					let descriptionLines = [];
					let inAnswerCode = false;
					
					const isQuestionStart = (line) => {
						const l = softTrim(line);
						return /^(?:Q(?:uestion)?\s*\d*|\d+)\s*[.:)]\s*/i.test(l);
					};
					const extractQuestionTitle = (line) => {
						const l = softTrim(line);
						const m = l.match(/^(?:Q(?:uestion)?\s*\d*|\d+)\s*[.:)]\s*(.+)$/i);
						return m ? m[1] : l.replace(/^Q\s*[:.-]?\s*/i,'');
					};
					const mapLabelToIndex = (label) => {
						if (!label) return -1;
						const s = String(label).trim();
						if (/^\d+$/.test(s)) return parseInt(s,10) - 1;
						const ch = s[0].toUpperCase();
						if (/[A-Z]/.test(ch)) return ch.charCodeAt(0) - 65;
						return -1;
					};
					const parseInlineOptions = (line) => {
						// Robust scanner: only treat label markers (a) a. a: 1) 1. 1:) as option starts
						// when preceded by start/space/comma/semicolon/pipe/dash (to avoid matching '3)' in 'np.eye(3)')
						const l = softTrim(line);
						const starts = [];
						for (let i = 0; i < l.length - 1; i++) {
							const ch = l[i];
							const next = l[i+1];
							const prev = i === 0 ? '' : l[i-1];
							const afterSep = l[i+2] || '';
							// Treat as an option label only when the separator is immediately followed by space
							if (/^[A-Za-z\d]$/.test(ch) && /[)\.:]/.test(next) && /\s/.test(afterSep)) {
								if (i === 0 || /[\s,;\|\-–—·•]/.test(prev)) {
									starts.push({ label: ch, idx: i });
								}
							}
						}
						if (starts.length < 2) return null;
						const out = [];
						for (let i = 0; i < starts.length; i++) {
							const start = starts[i].idx + 2; // skip label and separator
							const end = i + 1 < starts.length ? starts[i+1].idx : l.length;
							let text = l.slice(start, end);
							// Trim common trailing delimiters
							text = softTrim(text.replace(/[\s,;]+$/g, ''));
							const slot = mapLabelToIndex(starts[i].label);
							if (slot >= 0 && text) out[slot] = text;
						}
						return out.filter(Boolean).length ? out : null;
					};
					
					for (let i=0; i<rawLines.length; i++){
						const raw = rawLines[i];
						const line = softTrim(raw);
						
						// New question starts
						if (isQuestionStart(line)){
							// finalize previous
							if (currentQ){
								currentQ.description = softTrim(descriptionLines.join(' ')) || currentQ.title;
								if (currentOptions.length) currentQ.options = currentOptions.slice();
								questions.push(currentQ);
							}
							currentQ = { type: 'mcq', title: extractQuestionTitle(line), description: '', options: [], correctOption: undefined };
							currentOptions = [];
							descriptionLines = [];
							inAnswerCode = false;
							continue;
						}
						
						if (!currentQ) continue; // ignore preamble
						
						// Inline options on a single line
						const inlineOpts = parseInlineOptions(line);
						if (inlineOpts){
							for (let k=0;k<inlineOpts.length;k++){
								if (inlineOpts[k]) currentOptions[k] = inlineOpts[k];
							}
							continue;
						}
						
						// Standard one-per-line option
						const mOpt = line.match(/^([A-Za-z\d])[:\).]\s*(.+)$/i);
						if (mOpt){
							const idx = mapLabelToIndex(mOpt[1]);
							if (idx >= 0) currentOptions[idx] = softTrim(mOpt[2]);
							continue;
						}
						
						// Answer line (either MCQ letter or coding answer start)
						const mAns = raw.match(/^(?:Answer|Correct|Right)\s*[:\. ]\s*(.*)$/i);
						if (mAns){
							const rest = mAns[1] || '';
							// Try letter/number first
							const mLetter = rest.match(/^\s*([A-Za-z\d])\)/) || rest.match(/^\s*([A-Za-z\d])\b/);
							if (mLetter){
								const idx = mapLabelToIndex(mLetter[1]);
								if (idx >= 0) currentQ.correctOption = idx;
								else {
									// maybe textual answer; try to match an option text
									const txt = softTrim(rest.replace(/^\s*([A-Za-z\d])\)?\s*/, ''));
									const found = (currentOptions || []).findIndex(o => softTrim(o).toLowerCase() === txt.toLowerCase());
									if (found >= 0) currentQ.correctOption = found;
								}
								continue;
							}
							// Treat as coding answer (multi-line)
							currentQ.type = 'coding';
							inAnswerCode = true;
							const after = raw.split(/^(?:Answer|Correct|Right)\s*[:\. ]/i)[1] || '';
							currentQ.answer = (currentQ.answer || '') + (after ? after + '\n' : '');
							continue;
						}
						
						// Keep collecting code lines when inAnswerCode
						if (inAnswerCode){
							currentQ.answer = (currentQ.answer || '') + raw + '\n';
							continue;
						}
						
						// Description fall-through
						if (line){
							descriptionLines.push(line);
							// Heuristic: if no options appear at all, assume coding
							if (!currentOptions.length && /code|function|write|implement|solve|algorithm|program|create/i.test(line)){
								currentQ.type = 'coding';
							}
						}
					}
					
					// finalize trailing question
					if (currentQ){
						currentQ.description = softTrim(descriptionLines.join(' ')) || currentQ.title;
						if (currentOptions.length) currentQ.options = currentOptions.slice();
						questions.push(currentQ);
					}
					
					// Normalize output
					return questions.map(q => {
						const normalized = {
							type: q.type || (q.options && q.options.length ? 'mcq' : 'coding'),
							title: q.title || 'Untitled',
							description: q.description || q.title || '',
							options: q.options && q.options.length > 0 ? q.options.map(softTrim).filter(Boolean) : undefined,
							correctOption: Number.isInteger(q.correctOption) ? q.correctOption : undefined,
							answer: q.answer ? q.answer.replace(/\n+$/, '') : undefined,
							answerRegex: q.answerRegex || undefined
						};
						// If MCQ but still no correctOption and answer text exists, match by text
						if (normalized.type === 'mcq' && normalized.options && normalized.correctOption == null && normalized.answer){
							const txt = softTrim(normalized.answer);
							const found = normalized.options.findIndex(o => softTrim(o).toLowerCase() === txt.toLowerCase());
							if (found >= 0) normalized.correctOption = found;
							delete normalized.answer;
						}
						// If coding, remove MCQ fields
						if (normalized.type === 'coding'){
							delete normalized.options;
							delete normalized.correctOption;
						}
						return normalized;
					});
				}

				function clearQGForm(){
					document.getElementById('localQGForm').reset();
					document.getElementById('qgModulesContainer').innerHTML='';
				}

				async function onSaveSubject(e){
					e.preventDefault();
					const university = (document.getElementById('qgUniversity')?.value||'').trim();
					const subject = (document.getElementById('qgSubject')?.value||'').trim();
					if (!university){ alert('University is required'); return; }
					if (!subject){ alert('Subject is required'); return; }
					const moduleNames = Array.from(document.querySelectorAll('.qgModuleName')).map(i=>i.value.trim());
					const moduleJsons = Array.from(document.querySelectorAll('.qgModuleQuestions')).map(t=>t.value.trim());
					const modulePlainTexts = Array.from(document.querySelectorAll('.qgModulePlainText')).map(t=>t.value.trim());
					if (moduleNames.length === 0){ alert('Add at least one module'); return; }
					const modules = {};
					for (let i=0;i<moduleNames.length;i++){
						const name = moduleNames[i];
						if (!name){ alert(`Module #${i+1} name is required`); return; }
						let qs;
						// Prefer JSON textarea; if empty, try parsing the plain text textarea directly
						if (moduleJsons[i] && moduleJsons[i].length > 0) {
							try { qs = JSON.parse(moduleJsons[i]); } catch(err){ alert(`Module "${name}" has invalid JSON`); return; }
						} else if (modulePlainTexts[i] && modulePlainTexts[i].length > 0) {
							qs = parsePlainTextQuestions(modulePlainTexts[i]);
						} else {
							qs = [];
						}
						if (!Array.isArray(qs)){ alert(`Module "${name}" questions must be an array`); return; }
						const normalized = qs.map(q=>({
							id: q.id || uid(),
							type: q.type === 'mcq' ? 'mcq' : 'coding',
							title: q.title || 'Untitled',
							description: q.description || '',
							options: Array.isArray(q.options) ? q.options : undefined,
							correctOption: Number.isInteger(q.correctOption) ? q.correctOption : undefined,
							answer: typeof q.answer === 'string' ? q.answer : undefined,
							answerRegex: typeof q.answerRegex === 'string' ? q.answerRegex : undefined
						}));
						modules[name] = normalized;
					}
					
					// Save to MongoDB
					try {
						const response = await fetch('/api/question-bank/save', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({ university, subject, modules })
						});
						const result = await response.json();
						if (result.ok) {
						alert('✅ Saved to Question Bank (MongoDB)');
						// Keep admin on the same page; refresh subject/module selects
						try { renderSubjectModuleOptions(); } catch(_) {}
						// Optionally clear the form so admin can add another subject quickly
						try { clearQGForm(); addModuleField(); } catch(_) {}
						} else {
							alert(`❌ Error: ${result.error}`);
						}
					} catch(err) {
						alert(`❌ Failed to save: ${err.message}`);
					}
				}

				function buildAttemptView({mode, subject, moduleName, questions}){
					ensureContainers();
					const host = document.getElementById('localAttemptContainer');
					const list = document.getElementById('attemptQuestions');
					list.innerHTML = '';
					document.getElementById('attemptTitle').textContent = mode === 'classroom' ? 'Classroom Activity' : 'Test';
					document.getElementById('attemptMeta').textContent = `${subject} • ${moduleName} • ${questions.length} questions`;
					document.getElementById('attemptResult').innerHTML='';
					host.style.display = '';
					window.scrollTo({ top: host.offsetTop - 24, behavior: 'smooth' });

					questions.forEach((q, idx)=>{
						const card = document.createElement('div');
						card.className = 'card';
						card.innerHTML = `
							<h3 style="margin: 0 0 0.5rem 0;">Q${idx+1}. ${q.title}</h3>
							<p class="muted" style="margin: 0 0 0.5rem 0;">${q.description||''}</p>
							<div data-question-id="${q.id}">
								${q.type==='mcq' && Array.isArray(q.options) ? q.options.map((opt,i)=>`<label style='display:block; margin: 0.25rem 0;'><input type='radio' name='q_${q.id}' value='${i}'> ${opt}</label>`).join('') : `<textarea rows='6' style='width:100%;' name='q_${q.id}' placeholder='Write your answer here...'></textarea>`}
							</div>
						`;
						list.appendChild(card);
					});

					const cancelBtn = document.getElementById('attemptCancelBtn');
					// Note: Attempt submission removed - all submissions go through server-side endpoints
					// which store to MongoDB and validate against stored answers
					if (cancelBtn) cancelBtn.onclick = () => { document.getElementById('localAttemptContainer').style.display='none'; };
				}

				function normalize(s){ return (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase(); }
				
				// Note: Question generation is now handled server-side via MongoDB API endpoints
				// /api/question-bank/generate-activity and /api/question-bank/generate-test

				async function onCreateClassroom(e){
					e.preventDefault();
					const warning = document.getElementById('classroomWarning');
					warning.style.display='none'; warning.textContent='';
					const university = document.getElementById('classroomUniversity')?.value;
					const subject = document.getElementById('classroomSubject')?.value;
					const moduleName = document.getElementById('classroomModule')?.value;
					const numMcq = Math.max(0, parseInt(document.getElementById('classroomMcq')?.value||'0',10));
					const numCoding = Math.max(0, parseInt(document.getElementById('classroomCoding')?.value||'0',10));
					const numHandsOn = Math.max(0, parseInt(document.getElementById('classroomHandsOn')?.value||'0',10));
					const classroomId = (document.getElementById('classroomId')?.value||'').trim();
					
					if (!subject || !moduleName){ warning.style.display=''; warning.textContent='Please choose a subject and module.'; return; }
					if (numMcq === 0 && numCoding === 0){ warning.style.display=''; warning.textContent='At least one question type must be selected.'; return; }
					if (!classroomId){ warning.style.display=''; warning.textContent='Classroom ID is required.'; return; }
					
					try {
						const response = await fetch('/api/question-bank/generate-activity', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ university, subject, module: moduleName, num_mcq: numMcq, num_coding: numCoding, num_hands_on: numHandsOn, classroom_id: classroomId })
						});
						const result = await response.json();
						if (result.ok) {
							alert(`✅ Classroom Activity created!\nActivity ID: ${result.activity_id}\nClassroom ID: ${classroomId}\nQuestions: ${result.total}`);
							document.getElementById('createClassroomForm').reset();
							renderSubjectModuleOptions();
						} else {
							warning.style.display=''; warning.textContent=result.error || 'Failed to create activity';
						}
					} catch(err) {
						warning.style.display=''; warning.textContent=`Error: ${err.message}`;
					}
				}

				async function onCreateTest(e){
					e.preventDefault();
					const warning = document.getElementById('testWarning');
					warning.style.display='none'; warning.textContent='';
					const university = document.getElementById('testUniversity')?.value;
					const subject = document.getElementById('testSubject')?.value;
					const moduleName = document.getElementById('testModule')?.value;
					const numMcq = Math.max(0, parseInt(document.getElementById('testMcq')?.value||'0',10));
					const numCoding = Math.max(0, parseInt(document.getElementById('testCoding')?.value||'0',10));
					const numHandsOn = Math.max(0, parseInt(document.getElementById('testHandsOn')?.value||'0',10));
					const testId = (document.getElementById('testId')?.value||'').trim();
					const startTime = document.getElementById('testStart')?.value;
					const endTime = document.getElementById('testEnd')?.value;
					
					if (!subject || !moduleName){ warning.style.display=''; warning.textContent='Please choose a subject and module.'; return; }
					if (numMcq === 0 && numCoding === 0){ warning.style.display=''; warning.textContent='At least one question type must be selected.'; return; }
					if (!testId){ warning.style.display=''; warning.textContent='Test ID is required.'; return; }
					if (!startTime || !endTime){ warning.style.display=''; warning.textContent='Start and end times are required.'; return; }
					
					try {
						const response = await fetch('/api/question-bank/generate-test', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ university, subject, module: moduleName, num_mcq: numMcq, num_coding: numCoding, num_hands_on: numHandsOn, test_id: testId, start_time: startTime, end_time: endTime })
						});
						const result = await response.json();
						if (result.ok) {
							alert(`✅ Test created!\nTest ID: ${testId}\nQuestions: ${result.total}`);
							document.getElementById('createTestForm').reset();
							renderSubjectModuleOptions();
						} else {
							warning.style.display=''; warning.textContent=result.error || 'Failed to create test';
						}
					} catch(err) {
						warning.style.display=''; warning.textContent=`Error: ${err.message}`;
					}
				}

				function escapeCSV(s){
					const str = (s==null ? '' : String(s));
					if (/[,"\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
					return str;
				}

				function escapeHTML(s){
					return (s==null?'' : String(s)).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
				}

				function exportActivityCSV(activity){
					const rows = [['university','subject','module','type','title','description','options','correctOption','answer','answerRegex']];
					const university = activity.university || 'Unknown';
					Object.keys(activity.modules||{}).forEach(moduleName=>{
						(activity.modules[moduleName]||[]).forEach(q=>{
							rows.push([
								university,
								activity.subject,
								moduleName,
								q.type || 'unknown',
								q.title || '',
								q.description || '',
								Array.isArray(q.options) ? q.options.join(' | ') : '',
								Number.isInteger(q.correctOption) ? q.correctOption : '',
								q.answer || '',
								q.answerRegex || ''
							]);
						});
					});
					const csv = rows.map(r=>r.map(escapeCSV).join(',')).join('\n');
					const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url; a.download = `${university}_${activity.subject}_questions.csv`;
					document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
				}

				async function renderQMGroups(){
					const el = document.getElementById('qmGroups'); if (!el) return;
					
					try {
						const response = await fetch('/api/question-bank/all');
						const result = await response.json();
						if (!result.ok) {
							el.innerHTML = '<p class="muted">Error loading question banks.</p>';
							return;
						}
						
						const grouped = result.grouped || {};
						el.innerHTML = '';
						const universities = Object.keys(grouped).sort();
						if (!universities.length){ el.innerHTML = '<p class="muted">No question banks found.</p>'; return; }
						
						universities.forEach(u=>{
							const wrap = document.createElement('div');
							wrap.style.margin = '0.5rem 0';
							wrap.innerHTML = `<h3 style='margin:0 0 0.25rem 0;'>${u}</h3>`;
							const list = document.createElement('div'); list.style.display='grid'; list.style.gap='0.5rem';
							(grouped[u]||[]).forEach(a=>{
								// Ensure university is set
								a.university = u;
								const row = document.createElement('div');
								row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between';
								row.style.border='1px solid #e5e7eb'; row.style.borderRadius='6px'; row.style.padding='0.5rem';
								const createdAt = a.created_at ? new Date(a.created_at).toLocaleString() : 'Unknown';
								const left = document.createElement('div'); left.innerHTML = `<strong>${a.subject}</strong><div class='muted' style='font-size:0.85rem;'>Modules: ${Object.keys(a.modules||{}).length} • Created: ${createdAt}</div>`;
								const right = document.createElement('div'); right.style.display='flex'; right.style.gap='0.5rem';
								const bDetail = document.createElement('button'); bDetail.className='btn secondary'; bDetail.textContent='Details'; bDetail.onclick = ()=> renderQMDetail(a.id, a);
								const bEdit = document.createElement('button'); bEdit.className='btn secondary'; bEdit.textContent='Edit'; bEdit.onclick = ()=> prefillQGForEdit(a);
								const bExport = document.createElement('button'); bExport.className='btn secondary'; bExport.textContent='Export CSV'; bExport.onclick = ()=> exportActivityCSV(a);
								const bDelete = document.createElement('button'); bDelete.className='btn secondary'; bDelete.textContent='Delete'; bDelete.onclick = ()=> deleteActivity(a.subject, a);
								right.append(bDetail,bEdit,bExport,bDelete);
								row.append(left,right); list.appendChild(row);
							});
							wrap.appendChild(list); el.appendChild(wrap);
						});
					} catch(err) {
						el.innerHTML = '<p class="muted">Error loading question banks.</p>';
						console.error(err);
					}
				}

				function renderQMDetail(activityId, activityData){
					const container = document.getElementById('qmDetailContainer'); if (!container) return;
					const a = activityData;
					if (!a){ container.style.display='none'; container.innerHTML=''; return; }
					container.style.display='';
					// Extract university from grouped data or use 'Unknown'
					const university = a.university || 'Unknown';
					let html = `<div class='card'><h3 style='margin:0 0 0.5rem 0;'>${university} • ${a.subject}</h3>`;
					Object.keys(a.modules||{}).forEach(m=>{
						html += `<h4 style='margin:0.5rem 0;'>Module: ${m}</h4>`;
						(a.modules[m]||[]).forEach((q,idx)=>{
							html += `<div style='border:1px solid #e5e7eb; border-radius:6px; padding:0.5rem; margin:0.25rem 0;'>`+
								`<div><strong>Q${idx+1} (${q.type?.toUpperCase() || 'UNKNOWN'})</strong>: ${escapeHTML(q.title || 'Untitled')}</div>`+
								`<div class='muted' style='font-size:0.9rem;'>${escapeHTML(q.description||'')}</div>`+
								`${q.type==='mcq' && Array.isArray(q.options) ? `<div style='margin-top:0.25rem;'>Options: ${q.options.map((o,i)=> i===q.correctOption?`<strong>${escapeHTML(o)}</strong>`:escapeHTML(o)).join(' | ')}</div>` : ''}`+
								`${q.type!=='mcq' && (q.answer||q.answerRegex) ? `<div style='margin-top:0.25rem;'>Answer: <code>${escapeHTML(q.answer||q.answerRegex)}</code></div>` : ''}`+
								`</div>`;
						});
					});
					html += `</div>`;
					container.innerHTML = html;
				}

				function prefillQGForEdit(activityData){
					const a = activityData;
					if (!a) return;
					window.scrollTo({ top: 0, behavior: 'smooth' });
					const uni = document.getElementById('qgUniversity'); 
					const subj = document.getElementById('qgSubject');
					const university = a.university || 'Unknown';
					if (uni) uni.value = university; 
					if (subj) subj.value = a.subject;
					document.getElementById('qgModulesContainer').innerHTML='';
					Object.keys(a.modules||{}).forEach((m)=>{
						addModuleField();
						const wraps = document.querySelectorAll('#qgModulesContainer > div');
						const current = wraps[wraps.length-1];
						current.querySelector('.qgModuleName').value = m;
						current.querySelector('.qgModuleQuestions').value = JSON.stringify(a.modules[m], null, 2);
					});
					let delBtn = document.getElementById('qgDeleteActivityBtn');
					if (!delBtn){
						delBtn = document.createElement('button'); delBtn.id='qgDeleteActivityBtn'; delBtn.className='btn secondary'; delBtn.type='button'; delBtn.textContent='Delete This Question Bank';
						document.getElementById('qgSubmitBankBtn')?.parentElement?.appendChild(delBtn);
					}
					delBtn.onclick = async function(){ 
						await deleteActivity(a.subject, a); 
					};
				}

				async function deleteActivity(subject, activityData){
					if (!confirm('Delete this question bank?')) return;
					const university = activityData.university || 'Unknown';
					try {
						const response = await fetch('/api/question-bank/delete', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({ university, subject })
						});
						const result = await response.json();
						if (result.ok) {
							alert('✅ Question bank deleted successfully');
							renderSubjectModuleOptions();
							renderQMGroups();
							document.getElementById('qmDetailContainer').style.display='none';
						} else {
							alert(`❌ Error: ${result.error}`);
						}
					} catch(err) {
						alert(`❌ Failed to delete: ${err.message}`);
					}
				}

				// renderLogs removed from this page; view submissions/logs available in dedicated admin pages

				// Export all functions to global scope for use in views
				window.QuestionBankModule = {
					addModuleField,
					clearQGForm,
					onSaveSubject,
					renderSubjectModuleOptions,
					onCreateClassroom,
					onCreateTest,
					renderQMGroups,
					deleteActivity,
					exportActivityCSV
				};

				// Initialize on every page load
				function initQuestionBankUI(){
					// Wire Question Generator form
					const addModuleBtn = document.getElementById('qgAddModuleBtn');
					if (addModuleBtn){ 
						addModuleBtn.addEventListener('click', function(e){ 
							e.preventDefault(); 
							addModuleField(); 
						}); 
					}
					const clearBtn = document.getElementById('qgClearAllBtn');
					if (clearBtn){ clearBtn.addEventListener('click', function(){ clearQGForm(); }); }
					const saveBtn = document.getElementById('qgSubmitBankBtn');
					if (saveBtn){ saveBtn.addEventListener('click', onSaveSubject); }
					const modulesContainer = document.getElementById('qgModulesContainer');
					if (modulesContainer && modulesContainer.children.length === 0) {
						addModuleField();
					}

					// Wire Create Classroom/Test forms
					const classroomForm = document.getElementById('createClassroomForm');
					if (classroomForm){ classroomForm.addEventListener('submit', onCreateClassroom); }
					const testForm = document.getElementById('createTestForm');
					if (testForm){ testForm.addEventListener('submit', onCreateTest); }

					renderSubjectModuleOptions();
					// If on Questionnaire Management page, render groups
					if (document.getElementById('qmGroups')) {
						renderQMGroups();
					}
				}

				// Run on DOMContentLoaded
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initQuestionBankUI);
				} else {
					// DOM already loaded (in case this script runs after page load)
					initQuestionBankUI();
				}
			})();
	</script>
	<script>
	// Fallback initializers for test interface (ensures global handlers exist)
	(function(){
		if (typeof window.selectClassroomMCQ !== 'function'){
			window.classroomAnswers = window.classroomAnswers || {};
			window.selectClassroomMCQ = function(element, questionIdx){
				if (!element || !questionIdx) return;
				const optionIdxStr = element.getAttribute('data-option-index');
				const optionText = element.getAttribute('data-option-text') || element.textContent.trim();
				const selector = '.mcq-option-classroom[data-question-idx="'+questionIdx+'"]';
				const all = document.querySelectorAll(selector);
				all.forEach(opt=>{ opt.style.background='#f0f9ff'; opt.style.fontWeight='normal'; opt.style.border='1px solid #bfdbfe'; opt.style.borderLeft='3px solid #3b82f6'; });
				element.style.background='#dbeafe'; element.style.fontWeight='600'; element.style.border='2px solid #10b981'; element.style.borderLeft='3px solid #10b981';
				const idx = optionIdxStr!==null ? parseInt(optionIdxStr,10) : NaN;
				window.classroomAnswers[questionIdx] = Number.isFinite(idx) ? idx : optionText;
				const statusEl = document.getElementById('mcq-status-'+questionIdx);
				if (statusEl){ statusEl.textContent = '✓ Selected: ' + optionText; statusEl.style.color = '#10b981'; statusEl.style.fontWeight = '600'; }
			};
			window.clearClassroomMCQ = function(questionIdx){
				const selector = '.mcq-option-classroom[data-question-idx="'+questionIdx+'"]';
				document.querySelectorAll(selector).forEach(opt=>{ opt.style.background='#f0f9ff'; opt.style.fontWeight='normal'; opt.style.border='1px solid #bfdbfe'; opt.style.borderLeft='3px solid #3b82f6'; });
				delete window.classroomAnswers[questionIdx];
				const statusEl = document.getElementById('mcq-status-'+questionIdx);
				if (statusEl){ statusEl.textContent = ''; }
			};
		}
		// Navigator wiring
		if (document.querySelector('.test-question')){
			const qs = Array.from(document.querySelectorAll('.test-question'));
			let current = 1; const total = qs.length;
			const btnPrev = document.getElementById('btnPrev');
			const btnNext = document.getElementById('btnNext');
			const btnSubmit = document.getElementById('btnSubmit');
			const navError = document.getElementById('nav-error') || { textContent: '' };
			function show(i){ qs.forEach((el,idx)=>{ el.style.display = (idx+1)===i ? '' : 'none'; }); if (btnPrev) btnPrev.disabled = (i===1); if (btnNext) btnNext.style.display = (i===total)?'none':''; if (btnSubmit) btnSubmit.style.display=(i===total)?'':''; navError.textContent=''; }
			function isAnswered(i){ const el = document.querySelector('.test-question[data-index="'+i+'"]'); const t = el? el.getAttribute('data-type'):''; if (t==='mcq') return window.classroomAnswers[i]!==undefined && window.classroomAnswers[i]!==null && window.classroomAnswers[i]!==''; if (t==='coding'){ const ta=document.getElementById('code-'+i); return !!(ta && ta.value.trim()); } if (t==='hands_on'){ const fi=document.getElementById('handson-file-'+i); return !!(fi && fi.files && fi.files[0]); } return true; }
			if (btnPrev && !btnPrev.dataset.wired){ btnPrev.dataset.wired='1'; btnPrev.addEventListener('click', ()=>{ if (current>1){ current--; show(current);} }); }
			if (btnNext && !btnNext.dataset.wired){ btnNext.dataset.wired='1'; btnNext.addEventListener('click', ()=>{ if (!isAnswered(current)){ navError.textContent='Please answer Question '+current+' before proceeding.'; return; } if (current<total){ current++; show(current);} }); }
			if (btnSubmit && !btnSubmit.dataset.wired){ btnSubmit.dataset.wired='1'; btnSubmit.addEventListener('click', ()=>{ if (!isAnswered(current)){ navError.textContent='Please answer Question '+current+' before proceeding.'; return; } if (window.submitAllTestAnswers){ try{ window.submitAllTestAnswers('{{ test.test_id if test else '' }}', {{ questions | tojson | forceescape if questions else '[]' }}); }catch(e){} } }); }
			show(current);
		}
		// Minimal submit fallback
		if (typeof window.submitAllTestAnswers !== 'function'){
			window.submitAllTestAnswers = async function(testId, questions){
				try{
					const answers = [];
					let hasHands=false;
					(questions||[]).forEach((q,idx)=>{
						const qi = idx+1;
						if (q.question_type==='mcq'){
							answers.push({ question_index: qi, question_type:'mcq', question_data:q, selected_answer: window.classroomAnswers[qi] });
						}else if(q.question_type==='coding'){
							const ta=document.getElementById('code-'+qi); answers.push({ question_index: qi, question_type:'coding', question_data:q, user_code: ta? ta.value.trim():'' });
						}else if(q.question_type==='hands_on'){
							hasHands=true; answers.push({ question_index: qi, question_type:'hands_on', question_data:q, file_field: 'file_q'+qi });
						}
					});
					let resp;
					if (hasHands){
						const fd=new FormData(); fd.append('test_id', testId); fd.append('answers', JSON.stringify(answers)); answers.forEach(a=>{ if(a.question_type==='hands_on'){ const f=document.getElementById('handson-file-'+a.question_index); if(f && f.files && f.files[0]) fd.append(a.file_field, f.files[0]); }});
						resp = await fetch('/test/submit_all',{ method:'POST', body: fd });
					}else{
						resp = await fetch('/test/submit_all',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ test_id: testId, answers }) });
					}
					const data = await resp.json();
					if (data.ok){ window.location.href = '/user/home'; } else { alert('Submission failed: '+(data.error||'Unknown error')); }
				}catch(err){ alert('Submission error: '+err.message); }
			};
		}
		// Timer fallback
		(function(){ const t = document.getElementById('test-timer'); if (!t || t.dataset.timerWired) return; const endAttr = parseInt(t.getAttribute('data-end-ms')); if (!endAttr || Number.isNaN(endAttr)) return; t.dataset.timerWired='1'; function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const ss=(s%60).toString().padStart(2,'0'); return m+':'+ss; } const iv=setInterval(()=>{ const remain = endAttr - Date.now(); t.textContent = fmt(remain); if (remain<=0){ clearInterval(iv); if (window.submitAllTestAnswers){ try{ window.submitAllTestAnswers('{{ test.test_id if test else '' }}', {{ questions | tojson | forceescape if questions else '[]' }}); }catch(e){} } } },1000); })();
		// Anti-cheat fallback
		if (!window.__antiCheatWired && document.querySelector('.test-question')){ window.__antiCheatWired=true; function report(type){ try{ fetch('/test/violation',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type}) }); }catch(e){} } document.addEventListener('contextmenu', function(e){ e.preventDefault(); report('right_click'); }); document.addEventListener('keydown', function(e){ const k=(e.key||'').toLowerCase(); if (e.ctrlKey && (k==='c'||k==='v'||k==='x'||k==='tab')){ e.preventDefault(); report('ctrl+'+k); } }); document.addEventListener('copy', function(e){ e.preventDefault(); report('copy'); }); document.addEventListener('paste', function(e){ e.preventDefault(); report('paste'); }); document.addEventListener('cut', function(e){ e.preventDefault(); report('cut'); }); document.addEventListener('visibilitychange', function(){ if (document.hidden) report('tab_switch'); }); window.addEventListener('blur', function(){ report('window_blur'); }); }
	})();
	</script>
</body>
</html>
