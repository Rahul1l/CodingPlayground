<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coding Playground</title>
<link rel="stylesheet" href="/static/main.css">
<meta http-equiv="Cache-Control" content="no-store" />
</head>
<body>
	<header class="container flex-between">
		<h1>Coding Playground</h1>
		<nav>
			<a class="btn" href="/">Home</a>
			{% if session.admin_username %}<a class="btn" href="/admin/logout">Admin Logout</a>{% endif %}
			{% if session.user_username %}<a class="btn" href="/user/logout">User Logout</a>{% endif %}
		</nav>
	</header>

	<main class="container">
		{# Home View #}
		{% if view == 'home' %}
			<section class="grid">
				<div class="card">
					<h2>Admin</h2>
					<p>Manage users, classroom activities, and tests.</p>
					<a class="btn" href="/admin/login">Admin Login</a>
				</div>
				<div class="card">
					<h2>User</h2>
					<p>Access your classroom activities or scheduled tests.</p>
					<a class="btn" href="/user/login">User Login</a>
				</div>
			</section>
		{% endif %}

		{# Admin Login #}
		{% if view == 'admin_login' %}
			<section class="container narrow">
				<h2>Admin Login</h2>
				{% if error %}<div class="alert">{{ error }}</div>{% endif %}
				<form method="post">
					<label>Username<input type="text" name="username" required></label>
					<label>Password<input type="password" name="password" required></label>
					<button class="btn" type="submit">Log in</button>
				</form>
				<section class="muted small mt">
					<p>If no admin exists yet, <a href="/admin/bootstrap" class="btn secondary">Create First Admin</a></p>
				</section>
			</section>
		{% endif %}

		{# Admin Bootstrap #}
		{% if view == 'admin_bootstrap' %}
			<section class="container narrow">
				<h2>Create First Admin</h2>
				<p class="muted">This will only work if no admin exists yet.</p>
				<form method="post" action="/admin/bootstrap">
					<label>Username<input type="text" name="username" required></label>
					<label>Password<input type="password" name="password" required></label>
					<button class="btn" type="submit">Create Admin</button>
				</form>
				<a href="/admin/login" class="btn secondary mt">Back to Login</a>
			</section>
		{% endif %}

		{# Admin Dashboard #}
		{% if view == 'admin_dashboard' %}
			<section class="grid">
				<div class="card">
					<h2>Stats</h2>
					<ul class="list">
						<li>Users: <strong>{{ user_count }}</strong></li>
						<li>Classrooms: <strong>{{ classroom_count }}</strong></li>
						<li>Tests: <strong>{{ test_count }}</strong></li>
					</ul>
					<div class="mt">
						<a href="/admin/users" class="btn">Manage Users</a>
						<a href="/admin/users/export" class="btn secondary">Export Users</a>
					</div>
					<div class="mt">
						<a href="/admin/activities" class="btn">Manage Activities</a>
						<a href="/admin/tests" class="btn">Manage Tests</a>
					</div>
					<div class="mt">
						<a href="/admin/classroom-activities" class="btn secondary">üéØ Try Activities</a>
					</div>
				</div>
				<div class="card">
					<h2>Create User</h2>
					<form method="post" action="/admin/create_user">
						<label>Username<input type="text" name="username" required></label>
						<label>Password<input type="password" name="password" required></label>
						<label>University Name<input type="text" name="university" required placeholder="e.g., MIT, Stanford, etc."></label>
					<label>Role
						<select name="role" required>
							<option value="classroom">Classroom</option>
							<option value="test">Test</option>
							<option value="both">Both</option>
						</select>
					</label>
						<label>Classroom ID (for Classroom role)<input type="text" name="classroom_id"></label>
						<label>Test ID (for Test role)<input type="text" name="test_id"></label>
						<button class="btn" type="submit">Create User</button>
					</form>
				</div>
			</section>

			<section class="grid">
				<div class="card">
					<h2>Create Classroom Activity</h2>
					<form method="post" action="/admin/create_classroom_activity">
						<label>Subject<input type="text" name="subject" required></label>
						<label>ToC<textarea name="toc" rows="3" placeholder="Table of Contents"></textarea></label>
						<label>Number of Questions<input type="number" min="1" max="20" value="3" name="num_questions"></label>
						<label>Classroom ID<input type="text" name="classroom_id" required></label>
						<button class="btn" type="submit">Generate Activity</button>
					</form>
				</div>
				<div class="card">
					<h2>Create Test</h2>
					<form method="post" action="/admin/create_test">
						<label>Subject<input type="text" name="subject" required></label>
						<label>ToC<textarea name="toc" rows="3" placeholder="Table of Contents"></textarea></label>
						<label>Number of Questions<input type="number" min="1" max="20" value="3" name="num_questions"></label>
						<label>Test ID<input type="text" name="test_id" required></label>
						<label>Test Start Time<input type="datetime-local" name="start_datetime" required></label>
						<label>Test End Time<input type="datetime-local" name="end_datetime" required></label>
						<button class="btn" type="submit">Create Test</button>
					</form>
				</div>
			</section>

			{% if recent_users %}
			<section class="card">
				<h2>Recent Users</h2>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Role</th>
								<th>Classroom ID</th>
								<th>Test ID</th>
								<th>Created</th>
							</tr>
						</thead>
						<tbody>
							{% for user in recent_users %}
							<tr>
								<td>{{ user.username }}</td>
								<td>{{ user.role }}</td>
								<td>{{ user.classroom_id or '-' }}</td>
								<td>{{ user.test_id or '-' }}</td>
								<td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}
		{% endif %}

		{# Admin Classroom Activities View #}
		{% if view == 'admin_classroom_activities' %}
			<section class="card">
				<div class="flex-between">
					<h2>üéØ Try Classroom Activities</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">View and attempt all created classroom activities</p>
			</section>

			{% if activities %}
				{% for activity in activities %}
				<section class="card">
					<div class="flex-between">
						<div>
							<h3>{{ activity.subject }}</h3>
							<p class="muted">Classroom ID: {{ activity.classroom_id }}</p>
							<p class="muted">Created: {{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else 'Unknown' }}</p>
						</div>
						<div>
							<a href="/admin/classroom-activities/{{ activity.activity_id }}" class="btn">üéØ Try Activity</a>
						</div>
					</div>
				</section>
				{% endfor %}
			{% else %}
				<section class="card">
					<h3>No Activities Found</h3>
					<p class="muted">No classroom activities have been created yet.</p>
					<a href="/admin/dashboard" class="btn">Create Activity</a>
				</section>
			{% endif %}
		{% endif %}

		{# Admin Attempt Activity View #}
		{% if view == 'admin_attempt_activity' %}
			<div class="flex-between">
				<h2>üéØ {{ activity.subject }} - Admin Preview</h2>
				<div>
					<a href="/admin/classroom-activities" class="btn secondary">‚Üê Back to Activities</a>
					<a href="/admin/dashboard" class="btn secondary">Dashboard</a>
				</div>
			</div>
			
			{% if questions %}
				{% for question in questions %}
				<section class="card question-card">
					<div class="question-header">
						<h3>Question {{ loop.index }}: {{ question.title }}</h3>
						<span class="difficulty-badge difficulty-{{ question.difficulty }}">{{ question.difficulty|title }}</span>
					</div>
					
					<div class="question-content">
						<p><strong>Description:</strong></p>
						<p>{{ question.description }}</p>
						
						{% if question.input_format %}
						<p><strong>Input Format:</strong></p>
						<pre class="format-box">{{ question.input_format }}</pre>
						{% endif %}
						
						{% if question.output_format %}
						<p><strong>Output Format:</strong></p>
						<pre class="format-box">{{ question.output_format }}</pre>
						{% endif %}
						
						{% if question.sample_input %}
						<p><strong>Sample Input:</strong></p>
						<pre class="sample-box">{{ question.sample_input }}</pre>
						{% endif %}
						
						{% if question.sample_output %}
						<p><strong>Sample Output:</strong></p>
						<pre class="sample-box">{{ question.sample_output }}</pre>
						{% endif %}
					</div>
					
					<div class="compiler-section">
						<h4>üêç Code Editor (Admin Preview)</h4>
						<div class="compiler-container">
							<div class="code-section">
								<textarea id="admin-code-{{ loop.index }}" class="question-code" rows="8" placeholder="# Write your solution here
# Example:
# def solution():
#     return 'Hello World'">{{ question.sample_code or '' }}</textarea>
								<div class="compiler-controls">
									<button class="btn run-admin-question-code" data-question="{{ loop.index }}" data-question-text="{{ question.description|e }}">‚ñ∂Ô∏è Run Code</button>
									<button class="btn secondary clear-admin-question-code" data-question="{{ loop.index }}">üóëÔ∏è Clear</button>
								</div>
							</div>
							
							<div class="output-section">
								<label>Output:</label>
								<div id="admin-output-{{ loop.index }}" class="output-box">
									<p class="muted">Click "Run Code" to see the output here...</p>
								</div>
							</div>
						</div>
					</div>
				</section>
				{% endfor %}
			{% else %}
				<section class="card">
					<h2>Activity Content</h2>
					<details open>
						<summary>Generated Content</summary>
						<pre class="scroll">{{ activity.generated }}</pre>
					</details>
				</section>
			{% endif %}
		{% endif %}

		{# Admin Users Management #}
		{% if view == 'admin_users' %}
			<section class="card">
				<div class="flex-between">
					<h2>User Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
						<a href="/admin/users/export" class="btn">Export All to Excel</a>
					</div>
				</div>
				<p class="muted">Total Users: {{ total_users }}</p>
			</section>

			{% for university, users in universities.items() %}
			<section class="card">
				<div class="flex-between">
					<h3>üè´ {{ university }} ({{ users|length }} users)</h3>
					<div>
						<a href="/admin/users/export/{{ university|urlencode }}" class="btn secondary small">üì• Export {{ university }}</a>
					</div>
				</div>
				
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Password</th>
								<th>Role</th>
								<th>Classroom ID</th>
								<th>Test ID</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for user in users %}
							<tr>
								<td><strong>{{ user.username }}</strong></td>
								<td>
									<span class="password-display" data-password="{{ user.username }}" data-plain="{{ user.password_plain or 'N/A' }}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
									<button class="btn secondary tiny" onclick="togglePassword('{{ user.username }}')">üëÅÔ∏è</button>
								</td>
								<td><span class="role-badge role-{{ user.role }}">{{ user.role|title }}</span></td>
								<td>{{ user.classroom_id or '-' }}</td>
								<td>{{ user.test_id or '-' }}</td>
								<td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
								<td>
									<button class="btn secondary small" onclick="deleteUser('{{ user.username }}')">üóëÔ∏è Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endfor %}
		{% endif %}

		{# Admin Activities Management #}
		{% if view == 'admin_activities' %}
			<section class="card">
				<div class="flex-between">
					<h2>Activities Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">Total Activities: {{ total_activities }}</p>
			</section>

			<section class="card">
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Subject</th>
								<th>Classroom ID</th>
								<th>Questions</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for activity in activities %}
							<tr>
								<td>{{ activity.subject }}</td>
								<td>{{ activity.classroom_id }}</td>
								<td>{{ activity.num_questions }}</td>
								<td>{{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else '-' }}</td>
								<td>
									<button class="btn secondary small" onclick="deleteActivity('{{ activity.activity_id }}')">Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{% if total_pages > 1 %}
				<div class="pagination">
					{% if page > 1 %}
						<a href="?page={{ page - 1 }}" class="btn secondary">Previous</a>
					{% endif %}
					<span class="muted">Page {{ page }} of {{ total_pages }}</span>
					{% if page < total_pages %}
						<a href="?page={{ page + 1 }}" class="btn secondary">Next</a>
					{% endif %}
				</div>
				{% endif %}
			</section>
		{% endif %}

		{# Admin Tests Management #}
		{% if view == 'admin_tests' %}
			<section class="card">
				<div class="flex-between">
					<h2>Tests Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">Total Tests: {{ total_tests }}</p>
			</section>

			<section class="card">
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Subject</th>
								<th>Test ID</th>
								<th>Questions</th>
								<th>Scheduled</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for test in tests %}
							<tr>
								<td>{{ test.subject }}</td>
								<td>{{ test.test_id }}</td>
								<td>{{ test.num_questions }}</td>
								<td>{{ test.scheduled_at.strftime('%Y-%m-%d %H:%M') if test.scheduled_at else '-' }}</td>
								<td>{{ test.created_at.strftime('%Y-%m-%d %H:%M') if test.created_at else '-' }}</td>
								<td>
									<button class="btn secondary small" onclick="deleteTest('{{ test.test_id }}')">Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{% if total_pages > 1 %}
				<div class="pagination">
					{% if page > 1 %}
						<a href="?page={{ page - 1 }}" class="btn secondary">Previous</a>
					{% endif %}
					<span class="muted">Page {{ page }} of {{ total_pages }}</span>
					{% if page < total_pages %}
						<a href="?page={{ page + 1 }}" class="btn secondary">Next</a>
					{% endif %}
				</div>
				{% endif %}
			</section>
		{% endif %}

		{# User Login #}
		{% if view == 'user_login' %}
			<section class="container narrow">
				<h2>User Login</h2>
				{% if error %}<div class="alert">{{ error }}</div>{% endif %}
				<form method="post">
					<label>Username<input type="text" name="username" required></label>
					<label>Password<input type="password" name="password" required></label>
					<button class="btn" type="submit">Log in</button>
				</form>
			</section>
		{% endif %}

		{# User Selection (for "both" role) #}
		{% if view == 'user_selection' %}
			<section class="container narrow">
				<h2>Welcome, {{ user.username }}!</h2>
				<p>You have access to both classroom activities and tests. Choose what you'd like to do:</p>
				<div class="grid">
					<div class="card">
						<h3>Classroom Activities</h3>
						<p>Work on coding exercises and get AI feedback.</p>
						<a class="btn" href="/classroom">Go to Classroom</a>
					</div>
					<div class="card">
						<h3>Take Test</h3>
						<p>Take your scheduled coding test.</p>
						<a class="btn" href="/test">Go to Test</a>
					</div>
					<div class="card">
						<h3>üêç Python Compiler</h3>
						<p>Write and run Python code directly in your browser.</p>
						<a class="btn" href="/compiler">Open Compiler</a>
					</div>
				</div>
			</section>
		{% endif %}

		{# Classroom List #}
		{% if view == 'classroom' %}
			<div class="flex-between">
				<h2>Classroom ID: {{ classroom_id }}</h2>
				<a class="btn secondary" href="/compiler">üêç Python Compiler</a>
			</div>
			{% if activities|length == 0 %}
				<p class="muted">No activities yet.</p>
			{% else %}
				<div class="grid">
					{% for act in activities %}
					<div class="card">
						<h3>{{ act.subject }}</h3>
						<p class="small muted">Created {{ act.created_at }}</p>
						<a class="btn" href="/activity/{{ act.activity_id }}">Open</a>
					</div>
					{% endfor %}
				</div>
			{% endif %}
		{% endif %}

		{# Activity Detail #}
		{% if view == 'activity' %}
			<div class="flex-between">
				<h2>{{ activity.subject }} Activity</h2>
				<a class="btn secondary" href="/classroom">‚Üê Back to Activities</a>
			</div>
			
			{% if questions %}
				{% for question in questions %}
				<section class="card question-card">
					<div class="question-header">
						<h3>Question {{ loop.index }}: {{ question.title }}</h3>
						<span class="difficulty-badge difficulty-{{ question.difficulty }}">{{ question.difficulty|title }}</span>
					</div>
					
					<div class="question-content">
						<p><strong>Description:</strong></p>
						<p>{{ question.description }}</p>
						
						{% if question.input_format %}
						<p><strong>Input Format:</strong></p>
						<pre class="format-box">{{ question.input_format }}</pre>
						{% endif %}
						
						{% if question.output_format %}
						<p><strong>Output Format:</strong></p>
						<pre class="format-box">{{ question.output_format }}</pre>
						{% endif %}
						
						{% if question.sample_input %}
						<p><strong>Sample Input:</strong></p>
						<pre class="sample-box">{{ question.sample_input }}</pre>
						{% endif %}
						
						{% if question.sample_output %}
						<p><strong>Sample Output:</strong></p>
						<pre class="sample-box">{{ question.sample_output }}</pre>
						{% endif %}
					</div>
					
					<div class="compiler-section">
						<h4>üêç Code Editor</h4>
						<div class="compiler-container">
							<div class="code-section">
								<textarea id="code-{{ loop.index }}" class="question-code" rows="8" placeholder="# Write your solution here
# Example:
# def solution():
#     return 'Hello World'">{{ question.sample_code or '' }}</textarea>
								<div class="compiler-controls">
									<button class="btn run-question-code" data-question="{{ loop.index }}" data-question-text="{{ question.description|e }}">‚ñ∂Ô∏è Run Code</button>
									<button class="btn secondary clear-question-code" data-question="{{ loop.index }}">üóëÔ∏è Clear</button>
								</div>
							</div>
							
							<div class="output-section">
								<label>Output:</label>
								<div id="output-{{ loop.index }}" class="output-box">
									<p class="muted">Click "Run Code" to see the output here...</p>
								</div>
							</div>
						</div>
					</div>
				</section>
				{% endfor %}
			{% else %}
				<section class="card">
					<h2>Activity Content</h2>
					<details open>
						<summary>Generated Content</summary>
						<pre class="scroll">{{ activity.generated }}</pre>
					</details>
				</section>
			{% endif %}
			
			<section class="card">
				<form method="post" action="/classroom/complete">
					<button class="btn secondary" type="submit">Complete Activity</button>
				</form>
			</section>
		{% endif %}

		{# Test View #}
		{% if view == 'test' %}
			{% if error %}
				<div class="alert">{{ error }}</div>
			{% elif test %}
				<div class="flex-between">
					<h2>{{ test.subject }}</h2>
					<a class="btn secondary" href="/compiler">üêç Python Compiler</a>
				</div>
				<div class="card">
					<p class="muted">Test ID: {{ test.test_id }}</p>
					<p class="muted">Questions: {{ test.num_questions }}</p>
					
					{# Display time information based on test format #}
					{% if start_time and end_time %}
						<p class="muted">Test Window: {{ start_time.strftime('%Y-%m-%d %H:%M UTC') }} - {{ end_time.strftime('%Y-%m-%d %H:%M UTC') }}</p>
					{% elif scheduled_at %}
						<p class="muted">Scheduled for: {{ scheduled_at.strftime('%Y-%m-%d %H:%M UTC') }}</p>
					{% else %}
						<p class="muted">Not scheduled</p>
					{% endif %}
					
					<p class="muted">Current time: {{ current_time.strftime('%Y-%m-%d %H:%M UTC') if current_time else 'Unknown' }}</p>
					
					{# Test status display #}
					{% if test_status == 'open' %}
						<div class="alert success">
							<strong>‚úÖ Test is now open!</strong><br>
							You can now begin the test.
							{% if start_time and end_time %}
							<div id="test-timer" class="mt">
								<p>Time remaining: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% endif %}
						</div>
						<a href="/test/start" class="btn">Attempt Test</a>
					{% elif test_status == 'not_started' %}
						<div class="alert">
							<strong>‚è∞ Test not yet open</strong><br>
							Please wait until the scheduled start time to begin the test.
							{% if start_time %}
							<div id="countdown" class="mt">
								<p>Time until test opens: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% elif scheduled_at %}
							<div id="countdown" class="mt">
								<p>Time until test opens: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% endif %}
						</div>
						<button class="btn disabled" id="attempt-btn" disabled onclick="showNotOpenMessage()">
							Attempt Test
						</button>
					{% elif test_status == 'expired' %}
						<div class="alert" style="background: #7f1d1d; border-color: #dc2626; color: #fca5a5;">
							<strong>‚ùå Test has expired</strong><br>
							The test window has closed. You can no longer attempt this test.
						</div>
						<button class="btn disabled" id="attempt-btn" disabled onclick="showExpiredMessage()">
							Attempt Test
						</button>
					{% else %}
						<div class="alert">
							<strong>‚ö†Ô∏è No test scheduled</strong><br>
							No test has been scheduled for you.
						</div>
					{% endif %}
				</div>
				
				<div class="card">
					<h3>Test Preview</h3>
					<details>
						<summary>Test Content (structure)</summary>
						<pre class="scroll">{{ test.generated }}</pre>
					</details>
				</div>
			{% endif %}

		{# Test Interface (when test is actually open) #}
		{% if view == 'test_interface' %}
			<div class="flex-between">
				<h2>{{ test.subject }} - Test</h2>
				<div class="test-progress">
					<span class="progress-badge">Question {{ progress + 1 }} of {{ test.num_questions }}</span>
				</div>
			</div>
			
			{% if current_question %}
			<section class="card question-card">
				<div class="question-header">
					<h3>{{ current_question.title }}</h3>
					<span class="difficulty-badge difficulty-{{ current_question.difficulty }}">{{ current_question.difficulty|title }}</span>
				</div>
				
				<div class="question-content">
					<p><strong>Description:</strong></p>
					<p>{{ current_question.description }}</p>
					
					{% if current_question.input_format %}
					<p><strong>Input Format:</strong></p>
					<pre class="format-box">{{ current_question.input_format }}</pre>
					{% endif %}
					
					{% if current_question.output_format %}
					<p><strong>Output Format:</strong></p>
					<pre class="format-box">{{ current_question.output_format }}</pre>
					{% endif %}
					
					{% if current_question.sample_input %}
					<p><strong>Sample Input:</strong></p>
					<pre class="sample-box">{{ current_question.sample_input }}</pre>
					{% endif %}
					
					{% if current_question.sample_output %}
					<p><strong>Sample Output:</strong></p>
					<pre class="sample-box">{{ current_question.sample_output }}</pre>
					{% endif %}
				</div>
				
				<div class="compiler-section">
					<h4>üêç Code Editor</h4>
					<div class="compiler-container">
						<div class="code-section">
							<textarea id="test-code" class="question-code" rows="10" placeholder="# Write your solution here
# Example:
# def solution():
#     return 'Hello World'"></textarea>
							<div class="compiler-controls">
								<button id="run-test-code" class="btn">‚ñ∂Ô∏è Run Code</button>
								<button id="clear-test-code" class="btn secondary">üóëÔ∏è Clear</button>
							</div>
						</div>
						
						<div class="output-section">
							<label>Output:</label>
							<div id="test-output" class="output-box">
								<p class="muted">Click "Run Code" to see the output here...</p>
							</div>
						</div>
					</div>
				</div>
			</section>
			
			<form id="testForm" method="post" action="/test/submit" class="mt">
				<input type="hidden" name="user_code" id="hidden_user_code">
				<button class="btn" type="submit">Submit Answer</button>
			</form>
			{% else %}
			<section class="card">
				<h2>Test Content</h2>
				<details open>
					<summary>Test Content (structure)</summary>
					<pre class="scroll">{{ test.generated }}</pre>
				</details>
				<form id="testForm" method="post" action="/test/submit">
					<label>Your Code<textarea name="user_code" rows="12" placeholder="# Write your solution here"></textarea></label>
					<button class="btn" type="submit">Submit</button>
				</form>
			</section>
			{% endif %}
			<script>
			(function(){
				document.addEventListener('contextmenu', e => e.preventDefault());
				document.addEventListener('copy', e => e.preventDefault());
				document.addEventListener('cut', e => e.preventDefault());
				document.addEventListener('paste', e => e.preventDefault());
				document.addEventListener('keydown', e => {
					const blocked = (
						e.ctrlKey && (e.key === 'c' || e.key === 'x' || e.key === 'v' || e.key === 's')
						|| e.key === 'PrintScreen'
						|| (e.ctrlKey && e.shiftKey && (e.key.toLowerCase() === 'i' || e.key.toLowerCase() === 'j'))
					);
					if (blocked) { e.preventDefault(); }
				});
				history.pushState(null, document.title, location.href);
				window.addEventListener('popstate', function () {
					history.pushState(null, document.title, location.href);
				});
			})();
			
			// Test interface compiler functionality
			document.addEventListener('DOMContentLoaded', function() {
				const codeTextarea = document.getElementById('test-code');
				const runButton = document.getElementById('run-test-code');
				const clearButton = document.getElementById('clear-test-code');
				const outputDiv = document.getElementById('test-output');
				const testForm = document.getElementById('testForm');
				const hiddenUserCode = document.getElementById('hidden_user_code');
				
				if (codeTextarea && runButton && outputDiv) {
					// Run code function
					async function runCode() {
						const code = codeTextarea.value.trim();
						if (!code) {
							outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
							return;
						}
						
						// Show loading state
						runButton.disabled = true;
						runButton.textContent = '‚è≥ Running...';
						outputDiv.innerHTML = '<p class="muted">Executing code...</p>';
						
						try {
							const formData = new FormData();
							formData.append('code', code);
							
							const response = await fetch('/compiler/execute', {
								method: 'POST',
								body: formData
							});
							
							const result = await response.json();
							
							// Display results
							if (result.success) {
								outputDiv.className = 'output-box output-success';
								let output = '';
								if (result.output) {
									output += result.output;
								}
								if (result.error) {
									output += '\n--- Errors ---\n' + result.error;
								}
								outputDiv.textContent = output || 'Code executed successfully (no output)';
							} else {
								outputDiv.className = 'output-box output-error';
								outputDiv.textContent = `Error: ${result.error}`;
							}
						} catch (error) {
							outputDiv.className = 'output-box output-error';
							outputDiv.textContent = `Network error: ${error.message}`;
						} finally {
							// Reset button state
							runButton.disabled = false;
							runButton.textContent = '‚ñ∂Ô∏è Run Code';
						}
					}
					
					// Clear code function
					function clearCode() {
						codeTextarea.value = '';
						outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
						outputDiv.className = 'output-box';
					}
					
					// Event listeners
					runButton.addEventListener('click', runCode);
					clearButton.addEventListener('click', clearCode);
					
					// Keyboard shortcut: Ctrl+Enter to run code
					codeTextarea.addEventListener('keydown', function(e) {
						if (e.ctrlKey && e.key === 'Enter') {
							e.preventDefault();
							runCode();
						}
					});
					
					// Update hidden field when form is submitted
					if (testForm && hiddenUserCode) {
						testForm.addEventListener('submit', function() {
							hiddenUserCode.value = codeTextarea.value;
						});
					}
				}
			});
			</script>
		{% endif %}

		{# JavaScript for test preview #}
		{% if view == 'test' %}
		<script>
		// Countdown timer for test opening/closing
		{% if start_time and end_time %}
		(function(){
			const startTime = new Date('{{ start_time.isoformat() }}');
			const endTime = new Date('{{ end_time.isoformat() }}');
			const countdownElement = document.getElementById('time-remaining');
			
			function updateCountdown() {
				const now = new Date();
				
				if (now < startTime) {
					// Test not started yet
					const timeLeft = startTime - now;
					const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
					const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
					const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
					
					let timeString = '';
					if (days > 0) timeString += days + 'd ';
					if (hours > 0) timeString += hours + 'h ';
					if (minutes > 0) timeString += minutes + 'm ';
					timeString += seconds + 's';
					
					countdownElement.textContent = timeString;
				} else if (now >= startTime && now <= endTime) {
					// Test is open - show time remaining
					const timeLeft = endTime - now;
					const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
					const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
					const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
					
					let timeString = '';
					if (days > 0) timeString += days + 'd ';
					if (hours > 0) timeString += hours + 'h ';
					if (minutes > 0) timeString += minutes + 'm ';
					timeString += seconds + 's';
					
					countdownElement.textContent = timeString;
					
					if (timeLeft <= 0) {
						location.reload(); // Reload when test expires
						return;
					}
				} else {
					// Test has expired
					countdownElement.textContent = 'Test has expired';
				}
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		})();
		{% elif scheduled_at %}
		(function(){
			const scheduledTime = new Date('{{ scheduled_at.isoformat() }}');
			const countdownElement = document.getElementById('time-remaining');
			
			function updateCountdown() {
				const now = new Date();
				const timeLeft = scheduledTime - now;
				
				if (timeLeft <= 0) {
					countdownElement.textContent = 'Test is now open!';
					location.reload(); // Reload to show the test
					return;
				}
				
				const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
				const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
				const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
				const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
				
				let timeString = '';
				if (days > 0) timeString += days + 'd ';
				if (hours > 0) timeString += hours + 'h ';
				if (minutes > 0) timeString += minutes + 'm ';
				timeString += seconds + 's';
				
				countdownElement.textContent = timeString;
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		})();
		{% endif %}
		
		// Show message when attempt button is clicked before test opens
		function showNotOpenMessage() {
			alert('Test is not yet open. Please wait until the scheduled time to begin the test.');
		}
		
		// Show message when attempt button is clicked after test expires
		function showExpiredMessage() {
			alert('Test has expired. The test window has closed and you can no longer attempt this test.');
		}
		</script>
		{% endif %}
		{% endif %}

		{# Test Result #}
		{% if view == 'test_result' %}
			<section class="container narrow">
				<h2>Test Completed</h2>
				<p>Your final score: <strong>{{ score }}%</strong></p>
				<p>Questions graded: <strong>{{ total }}</strong></p>
				<a class="btn" href="/user/logout">Logout</a>
			</section>
		{% endif %}

		{# Python Compiler #}
		{% if view == 'compiler' %}
			<section class="container">
				<div class="card">
					<h2>üêç Python Compiler</h2>
					<p class="muted">Write and run Python code directly in your browser</p>
					
					<div class="compiler-container">
						<div class="code-section">
							<label for="python-code">Your Python Code:</label>
							<textarea id="python-code" rows="15" placeholder="# Write your Python code here
print('Hello, World!')
x = 5
y = 10
print(f'Sum: {x + y}')"></textarea>
							<div class="compiler-controls">
								<button id="run-code" class="btn">‚ñ∂Ô∏è Run Code</button>
								<button id="clear-code" class="btn secondary">üóëÔ∏è Clear</button>
							</div>
						</div>
						
						<div class="output-section">
							<label>Output:</label>
							<div id="compiler-output" class="output-box">
								<p class="muted">Click "Run Code" to see the output here...</p>
							</div>
						</div>
					</div>
					
					<div class="compiler-info">
						<h3>Features:</h3>
						<ul>
							<li>‚úÖ Safe code execution with timeout protection</li>
							<li>‚úÖ Standard Python libraries available</li>
							<li>‚úÖ Real-time output display</li>
							<li>‚úÖ Error handling and debugging</li>
						</ul>
					</div>
				</div>
			</section>
		{% endif %}
	</main>

	<footer class="container">
		<small>&copy; <span id="year"></span> Coding Playground</small>
	</footer>
	<script src="/static/app.js"></script>
	{% if view == 'activity' %}
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		// Handle question-specific code execution
		document.querySelectorAll('.run-question-code').forEach(button => {
			button.addEventListener('click', async function() {
				const questionNum = this.dataset.question;
				const questionText = this.dataset.questionText;
				const codeTextarea = document.getElementById(`code-${questionNum}`);
				const outputDiv = document.getElementById(`output-${questionNum}`);
				
				const code = codeTextarea.value.trim();
				if (!code) {
					outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
					return;
				}
				
				// Show loading state
				this.disabled = true;
				this.textContent = '‚è≥ Running...';
				outputDiv.innerHTML = '<p class="muted">Executing code and validating...</p>';
				
				try {
					const formData = new FormData();
					formData.append('code', code);
					formData.append('question_text', questionText);
					
					const response = await fetch('/question/execute', {
						method: 'POST',
						body: formData
					});
					
					const result = await response.json();
					
					// Display results
					if (result.success) {
						outputDiv.className = 'output-box output-success';
						let output = '';
						if (result.output) {
							output += '=== CODE OUTPUT ===\n';
							output += result.output;
						}
						if (result.error) {
							output += '\n\n=== ERRORS ===\n';
							output += result.error;
						}
						if (result.validation) {
							output += '\n\n=== AI VALIDATION ===\n';
							output += result.validation;
						}
						outputDiv.textContent = output || 'Code executed successfully (no output)';
					} else {
						outputDiv.className = 'output-box output-error';
						outputDiv.textContent = `Error: ${result.error}`;
					}
				} catch (error) {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Network error: ${error.message}`;
				} finally {
					// Reset button state
					this.disabled = false;
					this.textContent = '‚ñ∂Ô∏è Run Code';
				}
			});
		});
		
		// Handle clear code buttons
		document.querySelectorAll('.clear-question-code').forEach(button => {
			button.addEventListener('click', function() {
				const questionNum = this.dataset.question;
				const codeTextarea = document.getElementById(`code-${questionNum}`);
				const outputDiv = document.getElementById(`output-${questionNum}`);
				
				codeTextarea.value = '';
				outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
				outputDiv.className = 'output-box';
			});
		});
		
		// Keyboard shortcuts for code editors
		document.querySelectorAll('.question-code').forEach(textarea => {
			textarea.addEventListener('keydown', function(e) {
				if (e.ctrlKey && e.key === 'Enter') {
					e.preventDefault();
					const questionNum = this.id.split('-')[1];
					const runButton = document.querySelector(`[data-question="${questionNum}"].run-question-code`);
					if (runButton) {
						runButton.click();
					}
				}
			});
		});
	});
	</script>
	{% endif %}

	{% if view == 'admin_users' %}
	<script>
	async function deleteUser(username) {
		if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/users/delete/${username}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting user');
			}
		} catch (error) {
			alert('Error deleting user: ' + error.message);
		}
	}
	
	function togglePassword(username) {
		const passwordSpan = document.querySelector(`[data-password="${username}"]`);
		const button = passwordSpan.nextElementSibling;
		const plainPassword = passwordSpan.getAttribute('data-plain');
		
		if (passwordSpan.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
			// Show password
			passwordSpan.textContent = plainPassword || 'N/A';
			button.textContent = 'üôà';
			button.title = 'Click to hide password';
		} else {
			// Hide password
			passwordSpan.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
			button.textContent = 'üëÅÔ∏è';
			button.title = 'Click to reveal password';
		}
	}
	</script>
	{% endif %}

	{% if view == 'admin_attempt_activity' %}
	<script>
	// JavaScript for admin activity code execution
	document.addEventListener('DOMContentLoaded', function() {
		document.querySelectorAll('.run-admin-question-code').forEach(button => {
			button.addEventListener('click', async function() {
				const questionNum = this.dataset.question;
				const questionText = this.dataset.questionText;
				const codeTextarea = document.getElementById(`admin-code-${questionNum}`);
				const outputDiv = document.getElementById(`admin-output-${questionNum}`);
				
				const code = codeTextarea.value.trim();
				if (!code) {
					outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
					return;
				}
				
				this.disabled = true;
				this.textContent = '‚è≥ Running...';
				outputDiv.innerHTML = '<p class="muted">Executing code and validating...</p>';
				
				try {
					const formData = new FormData();
					formData.append('code', code);
					formData.append('question_text', questionText);
					
					const response = await fetch('/admin/question/execute', {
						method: 'POST',
						body: formData
					});
					
					const result = await response.json();
					
					if (result.success) {
						outputDiv.className = 'output-box output-success';
						let output = '';
						if (result.output) {
							output += '=== CODE OUTPUT ===\n';
							output += result.output;
						}
						if (result.error) {
							output += '\n\n=== ERRORS ===\n';
							output += result.error;
						}
						if (result.validation) {
							output += '\n\n=== AI VALIDATION ===\n';
							output += result.validation;
						}
						outputDiv.textContent = output || 'Code executed successfully (no output)';
					} else {
						outputDiv.className = 'output-box output-error';
						outputDiv.textContent = `Error: ${result.error}`;
					}
				} catch (error) {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Network error: ${error.message}`;
				} finally {
					this.disabled = false;
					this.textContent = '‚ñ∂Ô∏è Run Code';
				}
			});
		});
		
		document.querySelectorAll('.clear-admin-question-code').forEach(button => {
			button.addEventListener('click', function() {
				const questionNum = this.dataset.question;
				const codeTextarea = document.getElementById(`admin-code-${questionNum}`);
				const outputDiv = document.getElementById(`admin-output-${questionNum}`);
				
				codeTextarea.value = '';
				outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
				outputDiv.className = 'output-box';
			});
		});
		
		document.querySelectorAll('#admin-code-\\d+').forEach(textarea => {
			textarea.addEventListener('keydown', function(e) {
				if (e.ctrlKey && e.key === 'Enter') {
					e.preventDefault();
					const questionNum = this.id.split('-')[2];
					const runButton = document.querySelector(`[data-question="${questionNum}"].run-admin-question-code`);
					if (runButton) {
						runButton.click();
					}
				}
			});
		});
	});
	</script>
	{% endif %}

	{% if view == 'admin_activities' %}
	<script>
	async function deleteActivity(activityId) {
		if (!confirm(`Are you sure you want to delete this activity?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/activities/delete/${activityId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting activity');
			}
		} catch (error) {
			alert('Error deleting activity: ' + error.message);
		}
	}
	</script>
	{% endif %}

	{% if view == 'admin_tests' %}
	<script>
	async function deleteTest(testId) {
		if (!confirm(`Are you sure you want to delete test "${testId}"?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/tests/delete/${testId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting test');
			}
		} catch (error) {
			alert('Error deleting test: ' + error.message);
		}
	}
	</script>
	{% endif %}

	{% if view == 'compiler' %}
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		const codeTextarea = document.getElementById('python-code');
		const runButton = document.getElementById('run-code');
		const clearButton = document.getElementById('clear-code');
		const outputDiv = document.getElementById('compiler-output');
		
		// Run code function
		async function runCode() {
			const code = codeTextarea.value.trim();
			if (!code) {
				outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
				return;
			}
			
			// Show loading state
			runButton.disabled = true;
			runButton.textContent = '‚è≥ Running...';
			outputDiv.innerHTML = '<p class="muted">Executing code...</p>';
			
			try {
				const formData = new FormData();
				formData.append('code', code);
				
				const response = await fetch('/compiler/execute', {
					method: 'POST',
					body: formData
				});
				
				const result = await response.json();
				
				// Display results
				if (result.success) {
					outputDiv.className = 'output-box output-success';
					let output = '';
					if (result.output) {
						output += result.output;
					}
					if (result.error) {
						output += '\n--- Errors ---\n' + result.error;
					}
					outputDiv.textContent = output || 'Code executed successfully (no output)';
				} else {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Error: ${result.error}`;
				}
			} catch (error) {
				outputDiv.className = 'output-box output-error';
				outputDiv.textContent = `Network error: ${error.message}`;
			} finally {
				// Reset button state
				runButton.disabled = false;
				runButton.textContent = '‚ñ∂Ô∏è Run Code';
			}
		}
		
		// Clear code function
		function clearCode() {
			codeTextarea.value = '';
			outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
			outputDiv.className = 'output-box';
		}
		
		// Event listeners
		runButton.addEventListener('click', runCode);
		clearButton.addEventListener('click', clearCode);
		
		// Keyboard shortcut: Ctrl+Enter to run code
		codeTextarea.addEventListener('keydown', function(e) {
			if (e.ctrlKey && e.key === 'Enter') {
				e.preventDefault();
				runCode();
			}
		});
	});
	</script>
	{% endif %}
</body>
</html>
