<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coding Playground</title>
<meta http-equiv="Cache-Control" content="no-store" />
<style>
/* CSS Variables for consistent theming - Purple Glassmorphism Theme */
:root {
    --text-color: #000000;
    --text-light: #000000;
    --text-muted: #000000;
    --bg-gradient-start: #667eea;
    --bg-gradient-end: #764ba2;
    --card-bg: rgba(255, 255, 255, 1);
    --card-glass: rgba(255, 255, 255, 0.15);
    --border-color: rgba(255, 255, 255, 0.2);
    --primary-color: #667eea;
    --primary-dark: #5568d3;
    --secondary-color: #764ba2;
    --secondary-hover: #613a85;
    --muted-color: #000000;
    --link-color: #667eea;
    --link-hover: #5568d3;
    --input-bg: rgba(255, 255, 255, 1);
    --input-border: #e2e8f0;
    --hover-bg: rgba(255, 255, 255, 0.25);
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
}

/* Reset and base styles */
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", Helvetica, Arial, sans-serif;
    line-height: 1.6;
    color: var(--text-color);
    background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
    min-height: 100vh;
    background-attachment: fixed;
}

/* Layout */
.container {
    max-width: 960px;
    margin: 0 auto;
    padding: 1rem;
}

.container.narrow {
    max-width: 640px;
}

.grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}

.flex-between {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

/* Cards with Glassmorphism */
.card {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--shadow-lg);
    color: var(--text-color);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
}

/* Buttons */
.btn {
    display: inline-block;
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.25rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    font-size: 0.95rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    background: var(--primary-dark);
}

.btn:active {
    transform: translateY(0);
}

.btn.secondary {
    background: rgba(255, 255, 255, 0.9);
    color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.btn.secondary:hover {
    background: rgba(255, 255, 255, 1);
    color: var(--primary-dark);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.btn.disabled {
    pointer-events: none;
    opacity: 0.5;
    transform: none !important;
}

.btn.danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
}

.btn.danger:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
    transform: translateY(-2px);
}

.btn.small {
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    border-radius: 8px;
}

/* Forms */
label {
    display: block;
    margin: 0.75rem 0 0.5rem 0;
    color: var(--text-color);
    font-weight: 600;
    font-size: 0.95rem;
}

input, textarea, select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid var(--input-border);
    border-radius: 12px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

input::placeholder, textarea::placeholder {
    color: var(--muted-color);
}

/* Typography - All text BLACK for readability */
header h1 {
    color: #000000;
    margin: 0;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(255, 255, 255, 0.5);
}

h1, h2, h3, h4, h5, h6 {
    color: #000000 !important;
    margin: 0 0 1rem 0;
    font-weight: 700;
}

h2 {
    font-size: 1.75rem;
}

h3 {
    font-size: 1.25rem;
}

p, span, div, td, th, li, label, a {
    color: #000000 !important;
}

strong {
    color: #000000 !important;
    font-weight: 700;
}

h1 {
    font-size: 2rem;
    font-weight: 700;
}

h2 {
    font-size: 1.5rem;
    font-weight: 600;
}

h3 {
    font-size: 1.25rem;
    font-weight: 600;
}

p, li, small, .muted {
    color: #000000 !important;
}

.small {
    font-size: 0.9rem;
    color: #000000 !important;
}

.muted {
    color: #000000 !important;
    opacity: 1;
}

/* Spacing */
.mt {
    margin-top: 1rem;
}

.mb {
    margin-bottom: 1rem;
}

/* Alerts */
.alert {
    background: rgba(239, 68, 68, 0.15);
    color: #000000 !important;
    border: 2px solid rgba(239, 68, 68, 0.4);
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin: 1rem 0;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-sm);
    font-weight: 600;
}

.alert.success {
    background: rgba(16, 185, 129, 0.15);
    color: #000000 !important;
    border-color: rgba(16, 185, 129, 0.4);
}

.alert.info {
    background: rgba(59, 130, 246, 0.15);
    color: #000000 !important;
    border-color: rgba(59, 130, 246, 0.4);
}

/* Code blocks */
pre.scroll {
    max-height: 300px;
    overflow: auto;
    background: #0b1228;
    border: 1px solid #1e293b;
    padding: 1rem;
    border-radius: 8px;
    color: #e2e8f0;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
}

code {
    background: #1e293b;
    color: #e2e8f0;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
}

/* Tables */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 1rem 0;
    border-radius: 12px;
    overflow: hidden;
}

th, td {
    padding: 1rem 1.25rem;
    text-align: left;
    border-bottom: 1px solid rgba(226, 232, 240, 0.3);
}

th {
    background: rgba(102, 126, 234, 0.1);
    color: var(--text-color);
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

tr:hover td {
    background: rgba(102, 126, 234, 0.05);
}

tr:hover {
    background: #0f172a;
}

/* Navigation */
nav {
    display: flex;
    gap: 1rem;
    align-items: center;
}

nav a {
    color: #94a3b8;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: all 0.2s;
}

nav a:hover {
    background: #1e293b;
    color: #e2e8f0;
}

/* Header */
header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

/* Footer */
footer {
    margin-top: 3rem;
    padding: 2rem 0;
    border-top: 1px solid #1e293b;
    text-align: center;
    color: #64748b;
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Responsive design */
@media (max-width: 768px) {
    .container {
        padding: 0.5rem;
    }
    
    .flex-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    nav {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .grid {
        grid-template-columns: 1fr;
    }
}

/* Test interface specific styles */
.test-interface {
    background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
    min-height: 100vh;
}

.test-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 2px solid #e2e8f0;
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.test-progress {
    background: #e2e8f0;
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.test-progress-bar {
    background: #2563eb;
    height: 100%;
    transition: width 0.3s ease;
}

.question-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1rem 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.difficulty-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.difficulty-easy {
    background: #064e3b;
    color: #6ee7b7;
}

.difficulty-medium {
    background: #92400e;
    color: #fbbf24;
}

.difficulty-hard {
    background: #7f1d1d;
    color: #fca5a5;
}

.difficulty-medium_plus {
    background: #581c87;
    color: #c4b5fd;
}

.code-editor {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 1rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: #1e293b;
    width: 100%;
    min-height: 200px;
    resize: vertical;
}

.output-area {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    min-height: 100px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: #1e293b;
    white-space: pre-wrap;
}

/* Role badges */
.role-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.role-classroom {
    background: #1e3a8a;
    color: #93c5fd;
}

.role-test {
    background: #7c2d12;
    color: #fed7aa;
}

.role-both {
    background: #581c87;
    color: #c4b5fd;
}

/* Password toggle */
.password-container {
    position: relative;
    display: flex;
    align-items: center;
}

.password-toggle {
    position: absolute;
    right: 0.5rem;
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    padding: 0.25rem;
}

.password-toggle:hover {
    color: #e2e8f0;
}

/* University grouping */
.university-section {
    margin: 2rem 0;
}

.university-header {
    background: #1e293b;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 8px 8px 0 0;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.university-table {
    background: #0e1630;
    border: 1px solid #1e293b;
    border-top: none;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
}

/* Countdown timer */
.countdown {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 1.2rem;
    font-weight: 600;
    color: #fbbf24;
    background: #92400e;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    display: inline-block;
}

/* Compiler specific styles */
.compiler-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
}

.compiler-header {
    background: #0e1630;
    border: 1px solid #1e293b;
    border-radius: 12px 12px 0 0;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.compiler-body {
    background: #0b1228;
    border: 1px solid #1e293b;
    border-top: none;
    border-radius: 0 0 12px 12px;
    padding: 1rem;
}

.compiler-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.compiler-output {
    background: #0b1020;
    border: 1px solid #1e293b;
    border-radius: 8px;
    padding: 1rem;
    min-height: 200px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: #e2e8f0;
    white-space: pre-wrap;
    overflow-y: auto;
    max-height: 400px;
}

/* Question Navigation Styles */
.question-navigation {
    margin-bottom: 1rem;
}

.nav-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
}

.nav-btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.nav-btn.active {
    background-color: var(--primary-color);
    color: white;
}

.question-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

/* COMPREHENSIVE TEXT VISIBILITY FIXES */

/* Force all text to be white/visible */
*, *::before, *::after {
    color: var(--text-color) !important;
}

/* Override any inherited colors */
h1, h2, h3, h4, h5, h6 {
    color: var(--text-color) !important;
}

p, span, div, td, th, li, label {
    color: var(--text-color) !important;
}

/* Table visibility fixes */
.table-container table {
    color: var(--text-color) !important;
    background-color: var(--card-bg) !important;
}

.table-container th,
.table-container td {
    color: var(--text-color) !important;
    border-color: var(--border-color) !important;
    background-color: transparent !important;
}

.table-container th {
    background-color: var(--card-bg) !important;
    font-weight: 600;
    color: var(--text-color) !important;
}

.table-container tr:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.05) !important;
}

.table-container tr:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

/* Card content visibility */
.card h2, .card h3, .card h4 {
    color: var(--text-color) !important;
}

.card p, .card span {
    color: var(--text-color) !important;
}

.card div {
    color: var(--text-color) !important;
}

/* Muted text */
.muted {
    color: var(--muted-color) !important;
}

/* Badge visibility */
.badge {
    color: white !important;
    font-weight: 600;
}

.difficulty-easy { background-color: #28a745; }
.difficulty-medium { background-color: #ffc107; color: #000 !important; }
.difficulty-hard { background-color: #dc3545; }

/* Role badge styling */
.role-badge {
    color: white !important;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
}

.role-classroom { background-color: #007bff; }
.role-test { background-color: #6f42c1; }
.role-both { background-color: #fd7e14; }

/* University section styling */
.university-section h3 {
    color: var(--text-color) !important;
    margin-bottom: 1rem;
}

/* Form elements visibility */
input, textarea, select {
    color: var(--text-color) !important;
    background-color: var(--input-bg) !important;
    border-color: var(--border-color) !important;
}

/* Links visibility */
a {
    color: var(--link-color) !important;
}

a:hover {
    color: var(--link-hover) !important;
}

/* Ensure all manage page content is visible */
.manage-page .card {
    background-color: var(--card-bg) !important;
    border-color: var(--border-color) !important;
}

.manage-page .card h2,
.manage-page .card h3,
.manage-page .card h4 {
    color: var(--text-color) !important;
}

.manage-page .card p {
    color: var(--text-color) !important;
}

/* Export button styling */
.export-btn {
    background-color: #28a745 !important;
    color: white !important;
}

.export-btn:hover {
    background-color: #218838 !important;
    color: white !important;
}

/* Pagination styling */
.pagination {
    color: var(--text-color) !important;
}

.pagination span {
    color: var(--text-color) !important;
}

/* Alert styling */
.alert {
    color: var(--text-color) !important;
    background-color: var(--error-color) !important;
}

/* Code blocks */
pre, code {
    color: var(--text-color) !important;
    background-color: var(--input-bg) !important;
}

/* Format boxes */
.format-box, .sample-box {
    color: #000000 !important;
    background-color: #f8fafc !important;
    border: 1px solid #cbd5e1 !important;
    border-radius: 6px;
    padding: 0.75rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
}

/* Password toggle styling */
.password-display {
    font-family: monospace;
    font-weight: bold;
    color: var(--text-color) !important;
}

.btn.tiny {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    margin-left: 0.5rem;
    border-radius: 4px;
}

.btn.tiny:hover {
    transform: scale(1.05);
}

/* Anti-Cheat Warning Modal */
.warning-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    animation: fadeIn 0.3s;
}

.warning-modal-content {
    position: relative;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    margin: 10% auto;
    padding: 2rem;
    border: 2px solid #fca5a5;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(220, 38, 38, 0.5);
    animation: slideIn 0.3s;
}

.warning-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    animation: pulse 1s infinite;
}

.warning-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
}

.warning-message {
    font-size: 1.1rem;
    color: #fca5a5;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.warning-counter {
    font-size: 2rem;
    font-weight: 700;
    color: #fef2f2;
    margin-bottom: 1rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.warning-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.warning-btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.warning-btn-primary {
    background: white;
    color: #dc2626;
}

.warning-btn-primary:hover {
    background: #f3f4f6;
    transform: translateY(-2px);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        transform: translateY(-50px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Warning indicator in header */
.warning-indicator {
    background: #dc2626;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    animation: pulse 2s infinite;
}

/* Inactivity warning */
.inactivity-warning {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #f59e0b;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
    z-index: 9998;
    animation: slideIn 0.3s;
    font-weight: 600;
}

.inactivity-countdown {
    font-size: 1.5rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    margin-top: 0.5rem;
}

/* HERO SECTION STYLING */
.hero-section {
    text-align: center;
    padding: 3rem 0;
    margin-bottom: 2rem;
}

.hero-content h1 {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #60a5fa, #3b82f6, #1d4ed8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-subtitle {
    font-size: 1.2rem;
    color: var(--muted-color);
    max-width: 600px;
    margin: 0 auto;
}

/* LOGIN OPTIONS STYLING */
.login-options {
    margin-top: 2rem;
}

.login-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    max-width: 900px;
    margin: 0 auto;
}

.login-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.login-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
}

.login-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    border-color: #3b82f6;
}

.card-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.login-card h2 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.login-card p {
    color: var(--muted-color);
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.card-features {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.feature {
    background: rgba(59, 130, 246, 0.1);
    color: #60a5fa;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

/* BUTTON STYLING */
.admin-btn, .user-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 12px;
    text-decoration: none;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.admin-btn {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.admin-btn:hover {
    background: linear-gradient(135deg, #1d4ed8, #1e40af);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

.user-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.user-btn:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
}

/* Question Generator Tabs */
.qgTabBtn {
    padding: 0.5rem 1rem;
    border: none;
    background: none;
    cursor: pointer;
    color: #6b7280;
    font-weight: 500;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.qgTabBtn:hover {
    color: #667eea;
}

.qgTabBtn.active {
    color: #667eea;
    border-bottom-color: #667eea;
    font-weight: 600;
}

/* RESPONSIVE DESIGN */
@media (max-width: 768px) {
    .hero-content h1 {
        font-size: 2rem;
    }
    
    .hero-subtitle {
        font-size: 1rem;
    }
    
    .login-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .login-card {
        padding: 1.5rem;
    }
    
    .card-features {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .feature {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
}

/* ========================================
   UNIFIED LOGIN PAGE STYLES
   ======================================== */

.login-page {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	display: flex;
	align-items: center;
	justify-content: center;
	overflow-y: auto;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-background {
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	overflow: hidden;
	opacity: 0.1;
}

.login-shapes {
	position: relative;
	width: 100%;
	height: 100%;
}

.shape {
	position: absolute;
	border-radius: 50%;
	background: rgba(255, 255, 255, 0.1);
	animation: float 20s infinite ease-in-out;
}

.shape-1 {
	width: 300px;
	height: 300px;
	top: 10%;
	left: 10%;
	animation-delay: 0s;
}

.shape-2 {
	width: 200px;
	height: 200px;
	top: 60%;
	right: 10%;
	animation-delay: 5s;
}

.shape-3 {
	width: 250px;
	height: 250px;
	bottom: 10%;
	left: 40%;
	animation-delay: 10s;
}

@keyframes float {
	0%, 100% { transform: translateY(0) rotate(0deg); }
	33% { transform: translateY(-30px) rotate(120deg); }
	66% { transform: translateY(30px) rotate(240deg); }
}

.login-container {
	position: relative;
	z-index: 1;
	display: flex;
	align-items: center;
	justify-content: center;
	padding: 2rem;
	max-width: 500px;
	width: 100%;
}

.login-box {
	background: #ffffff;
	border-radius: 24px;
	padding: 3rem;
	box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
	width: 100%;
}

.login-header {
	text-align: center;
	margin-bottom: 2.5rem;
}

.login-logo {
	display: flex;
	justify-content: center;
	margin-bottom: 1.5rem;
}

.logo-icon {
	width: 80px;
	height: 80px;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	border-radius: 20px;
	display: flex;
	align-items: center;
	justify-content: center;
	box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
}

.logo-text {
	font-size: 2rem;
	font-weight: 700;
	color: #ffffff;
	letter-spacing: 1px;
}

.login-title {
	font-size: 2rem;
	font-weight: 700;
	color: #1a202c;
	margin: 0 0 0.5rem 0;
}

.login-subtitle {
	font-size: 1rem;
	color: #718096;
	margin: 0;
}

.login-error {
	display: flex;
	align-items: center;
	gap: 0.75rem;
	padding: 1rem 1.25rem;
	background: #fee;
	border: 1px solid #fcc;
	border-radius: 12px;
	margin-bottom: 1.5rem;
	color: #c53030;
	font-size: 0.95rem;
}

.login-form {
	display: flex;
	flex-direction: column;
	gap: 1.5rem;
}

.form-group {
	display: flex;
	flex-direction: column;
	gap: 0.5rem;
}

.form-label {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	font-weight: 600;
	font-size: 0.95rem;
	color: #2d3748;
}

.form-label-icon,
.login-error-icon,
.login-btn-icon {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	width: 24px;
	height: 24px;
	border-radius: 6px;
	background: #667eea;
	color: #ffffff;
	font-size: 0.85rem;
	font-weight: 700;
	margin-right: 0.4rem;
}

.login-error-icon {
	background: #dc2626;
}

.login-btn-icon {
	margin-left: 0.5rem;
	background: rgba(255, 255, 255, 0.2);
	width: 28px;
	height: 28px;
	border-radius: 999px;
}

.form-input {
	width: 100%;
	padding: 0.875rem 1rem;
	font-size: 1rem;
	border: 2px solid #e2e8f0;
	border-radius: 12px;
	background: #f7fafc;
	color: #1a202c;
	transition: all 0.2s ease;
	font-family: inherit;
}

.form-input:focus {
	outline: none;
	border-color: #667eea;
	background: #ffffff;
	box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input::placeholder {
	color: #a0aec0;
}

.login-btn {
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 0.75rem;
	padding: 1rem;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: #ffffff;
	font-size: 1.05rem;
	font-weight: 600;
	border: none;
	border-radius: 12px;
	cursor: pointer;
	transition: all 0.3s ease;
	margin-top: 0.5rem;
	box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.login-btn:hover {
	transform: translateY(-2px);
	box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.login-btn:active {
	transform: translateY(0);
}

.login-footer {
	margin-top: 2rem;
	padding-top: 1.5rem;
	border-top: 1px solid #e2e8f0;
}

.login-info {
	display: flex;
	align-items: flex-start;
	gap: 0.75rem;
	padding: 1rem;
	background: #f7fafc;
	border-radius: 12px;
	font-size: 0.875rem;
	color: #4a5568;
	line-height: 1.5;
}

/* Responsive Design */
@media (max-width: 640px) {
	.login-container {
		padding: 1rem;
	}
	
	.login-box {
		padding: 2rem 1.5rem;
		border-radius: 16px;
	}
	
	.login-title {
		font-size: 1.5rem;
	}
}

/* ========================================
   GLOBAL TEXT COLOR OVERRIDE - ALL BLACK
   ======================================== */
body, body * {
    color: #000000 !important;
}

/* Except for white text on buttons */
.btn, .btn * {
    color: #ffffff !important;
}

.btn.secondary, .btn.secondary * {
    color: #667eea !important;
}

/* White text on header background for contrast */
header, header * {
    color: #000000 !important;
}

/* Code blocks can have lighter text */
pre, pre *, code {
    color: #1a202c !important;
}

/* Input placeholders */
::placeholder {
    color: #000000 !important;
    opacity: 0.6;
}

/* ========================================
   LIGHT BACKGROUNDS - BLACK TEXT EVERYWHERE
   ======================================== */
/* All interfaces now use light backgrounds, so black text is naturally readable */

/* Preserve button text colors only */
button, .btn, a.btn {
    color: #ffffff !important;
}

button.secondary, .btn.secondary, a.btn.secondary {
    color: #667eea !important;
}

/* Warning modal with light background */
.warning-modal {
    background: rgba(255, 255, 255, 0.98) !important;
    color: #000000 !important;
}

.warning-modal * {
    color: #000000 !important;
}

.warning-modal h2 {
    color: #dc2626 !important;
}
</style>
</head>
<body data-view="{{ view }}">
	<script>
		window.APP_CONTEXT = {{ {
			"view": view,
			"isAdmin": session.admin_username is not none,
			"isUser": session.user_username is not none,
			"testId": (test.test_id if (test is defined and test) else None),
			"activityId": (activity.activity_id if (activity is defined and activity) else None),
			"questions": questions if questions else [],
			"endTimeMs": end_time_ms if end_time_ms is defined else None
		} | tojson | safe }};
	</script>
	<script>
		// App configuration
		const APP_BASE_URL = 'http://3.80.74.243:5000';
		const ADMIN_USERNAME = 'Ayushman';
		const ADMIN_PASSWORD = 'ayushman9277';
	</script>
	
	<!-- CRITICAL: Global handlers must be defined BEFORE any HTML that references them -->
	<script>
		// Initialize global answer storage
		window.classroomAnswers = window.classroomAnswers || {};
		window.classroomCode = window.classroomCode || {};
		
		// MCQ Selection Handler - Called from inline onclick attributes
		window.selectClassroomMCQ = function(element, questionIdx) {
			if (!element || !questionIdx) return;
			
			const optionIdxStr = element.getAttribute('data-option-index');
			const optionText = element.getAttribute('data-option-text') || element.textContent.trim();
			const optionDataIdx = element.getAttribute('data-question-idx');
			const optionIdx = optionIdxStr !== null ? parseInt(optionIdxStr, 10) : NaN;
			
			if (optionDataIdx != questionIdx) return;
			
			const selector = '.mcq-option-classroom[data-question-idx="' + questionIdx + '"]';
			const allOptions = document.querySelectorAll(selector);
			
			if (allOptions.length === 0) return;
			
			// Clear all selections
			allOptions.forEach(function(opt) {
				opt.style.background = '#f0f9ff';
				opt.style.borderLeft = '3px solid #3b82f6';
				opt.style.fontWeight = 'normal';
				opt.style.border = '1px solid #bfdbfe';
			});
			
			// Highlight selected
			element.style.background = '#dbeafe';
			element.style.borderLeft = '3px solid #10b981';
			element.style.fontWeight = '600';
			element.style.border = '2px solid #10b981';
			
			// Store answer
			window.classroomAnswers[questionIdx] = Number.isFinite(optionIdx) ? optionIdx : optionText;
			
			// Update status
			const statusEl = document.getElementById('mcq-status-' + questionIdx);
			if (statusEl) {
				statusEl.textContent = '‚úì Selected: ' + optionText;
				statusEl.style.color = '#10b981';
				statusEl.style.fontWeight = '600';
			}
		};
		
		// Clear MCQ Selection
		window.clearClassroomMCQ = function(questionIdx) {
			if (!questionIdx) return;
			
			const selector = '.mcq-option-classroom[data-question-idx="' + questionIdx + '"]';
			const allOptions = document.querySelectorAll(selector);
			
			if (allOptions.length === 0) return;
			
			allOptions.forEach(function(opt) {
				opt.style.background = '#f0f9ff';
				opt.style.borderLeft = '3px solid #3b82f6';
				opt.style.fontWeight = 'normal';
				opt.style.border = '1px solid #bfdbfe';
			});
			
			delete window.classroomAnswers[questionIdx];
			
			const statusEl = document.getElementById('mcq-status-' + questionIdx);
			if (statusEl) {
				statusEl.textContent = '';
			}
		};
		
		// Toggle password visibility
		window.toggleUserPassword = function(username) {
			const passwordSpan = document.querySelector('span[data-password="' + username + '"]');
			if (!passwordSpan) return;
			const button = passwordSpan.nextElementSibling;
			const plainPassword = passwordSpan.getAttribute('data-plain');
			if (passwordSpan.textContent.trim() === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
				passwordSpan.textContent = plainPassword || 'N/A';
				if (button) {
					button.textContent = 'üôà';
					button.title = 'Click to hide password';
				}
			} else {
				passwordSpan.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
				if (button) {
					button.textContent = 'üëÅÔ∏è';
					button.title = 'Click to show password';
				}
			}
		};
		
	const APP = window.APP_CONTEXT || {};
	window.__testSubmitted = window.__testSubmitted || false;
	window.__testTimerInterval = window.__testTimerInterval || null;

	function formatCountdownFromMs(ms){
		const totalSeconds = Math.max(0, Math.ceil(ms / 1000));
		const minutes = Math.floor(totalSeconds / 60);
		const seconds = totalSeconds % 60;
		return String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
	}
	
	function collectTestAnswers(questions) {
		const answers = [];
		const missing = [];
		let hasHandsOn = false;
		questions.forEach((question, index) => {
			const questionIdx = index + 1;
			if (question.question_type === 'mcq') {
				const selected = window.classroomAnswers[questionIdx];
				const hasSelection = !(selected === undefined || selected === null || (typeof selected === 'string' && selected.trim() === ''));
				if (!hasSelection) missing.push(`Question ${questionIdx} (MCQ)`);
				answers.push({
					question_index: questionIdx,
					question_type: 'mcq',
					question_data: question,
					selected_answer: hasSelection ? selected : null,
				});
			} else if (question.question_type === 'coding') {
				const textarea = document.getElementById(`code-${questionIdx}`);
				const code = textarea ? textarea.value.trim() : '';
				if (!code) missing.push(`Question ${questionIdx} (Coding)`);
				answers.push({
					question_index: questionIdx,
					question_type: 'coding',
					question_data: question,
					user_code: code || null,
				});
			} else if (question.question_type === 'hands_on') {
				hasHandsOn = true;
				const fileInput = document.getElementById(`handson-file-${questionIdx}`);
				const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
				if (!file) missing.push(`Question ${questionIdx} (Hands-on)`);
				answers.push({
					question_index: questionIdx,
					question_type: 'hands_on',
					question_data: question,
					file_field: `file_q${questionIdx}`,
				});
			}
		});
		return { answers, missing, hasHandsOn };
	}
	
	// Submit Test Answers - Global function for test interface
	window.submitAllTestAnswers = async function(testIdOverride, questionsOverride, options = {}) {
		if (window.__testSubmitted) {
			alert('This test has already been submitted.');
			return;
		}
		const testId = testIdOverride || APP.testId;
		const questions = (Array.isArray(questionsOverride) && questionsOverride.length) ? questionsOverride : (Array.isArray(APP.questions) ? APP.questions : []);
		if (!testId || !questions.length) {
			alert('Test data is unavailable. Please reload the page.');
			return;
		}
		const autoSubmit = !!options.autoSubmit;
		const { answers, missing, hasHandsOn } = collectTestAnswers(questions);
		if (!autoSubmit && missing.length > 0) {
			const proceed = confirm(`‚ö†Ô∏è The following questions have no answers:\n\n${missing.join('\n')}\n\nDo you want to submit anyway?`);
			if (!proceed) {
				return;
			}
		}
		if (!autoSubmit) {
			const confirmSubmit = confirm(`üìù Submit all ${answers.length} answers?\n\nYou cannot change your answers after submitting.`);
			if (!confirmSubmit) {
				return;
			}
		}
		const interactiveElements = Array.from(document.querySelectorAll('.test-question input, .test-question textarea, .test-question button'));
		interactiveElements.forEach(el => { el.disabled = true; el.dataset.disabledBySubmit = '1'; });
		const submitBtn = document.getElementById('btnSubmit');
		if (submitBtn) submitBtn.disabled = true;
		document.body.style.cursor = 'wait';
		try {
			let response;
			if (hasHandsOn) {
				const fd = new FormData();
				fd.append('test_id', testId);
				fd.append('answers', JSON.stringify(answers));
				answers.forEach(ans => {
					if (ans.question_type === 'hands_on') {
						const fileEl = document.getElementById(`handson-file-${ans.question_index}`);
						if (fileEl && fileEl.files && fileEl.files[0]) {
							fd.append(ans.file_field, fileEl.files[0]);
						}
					}
				});
				response = await fetch('/test/submit_all', { method: 'POST', body: fd });
			} else {
				response = await fetch('/test/submit_all', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ test_id: testId, answers })
				});
			}
			const result = await response.json();
			if (!result.ok) {
				throw new Error(result.error || 'Failed to submit test');
			}
			showTestSubmissionSuccess(result, autoSubmit);
		} catch (error) {
			console.error('Test submission error:', error);
			alert(`Failed to submit test: ${error.message || error}`);
			interactiveElements.forEach(el => {
				if (el.dataset.disabledBySubmit === '1') {
					el.disabled = false;
					delete el.dataset.disabledBySubmit;
				}
			});
			if (submitBtn) submitBtn.disabled = false;
		} finally {
			document.body.style.cursor = 'default';
		}
	};

	function showTestSubmissionSuccess(result, autoSubmit) {
		window.__testSubmitted = true;
		if (window.__testTimerInterval) {
			clearInterval(window.__testTimerInterval);
			window.__testTimerInterval = null;
		}
		const questionBlocks = document.querySelectorAll('.test-question');
		questionBlocks.forEach(el => { el.style.display = 'none'; });
		const nav = document.getElementById('test-nav');
		if (nav) nav.style.display = 'none';
	const navError = document.getElementById('nav-error');
	if (navError) {
		navError.style.color = '#10b981';
		navError.textContent = autoSubmit
			? 'Time is up! Your responses were submitted.'
			: 'Test successfully submitted!';
	}
		const timerContainer = document.getElementById('test-timer');
		if (timerContainer) timerContainer.style.display = 'none';
	const finalResult = document.getElementById('final-result');
	if (finalResult) finalResult.style.display = 'none';
	const successCard = document.getElementById('test-success-message');
	if (!successCard) {
		window.location.href = '/test';
		return;
	}
	const successText = document.getElementById('test-success-text');
	if (successText) {
		successText.textContent = autoSubmit
			? 'Time is up! Your test was submitted automatically. Your instructor will review your responses.'
			: 'Test successfully submitted! Your instructor will review your responses.';
	}
	const violationContainer = document.getElementById('test-success-violations');
	const violationCountEl = document.getElementById('test-success-violation-count');
	const violationCount = Number((result && (result.violation_count ?? result.warning_count ?? 0)) || 0);
	if (violationContainer && violationCountEl) {
		if (violationCount > 0) {
			violationContainer.style.display = '';
			violationCountEl.textContent = violationCount;
		} else {
			violationContainer.style.display = 'none';
		}
	}
	successCard.style.display = 'block';
	const returnBtn = document.getElementById('btnReturnHome');
	if (returnBtn && !returnBtn.dataset.bound) {
		returnBtn.dataset.bound = '1';
		returnBtn.addEventListener('click', () => { window.location.href = '/test'; });
		}
		const logoutBtn = document.getElementById('btnLogoutAfterTest');
		if (logoutBtn && !logoutBtn.dataset.bound) {
			logoutBtn.dataset.bound = '1';
			logoutBtn.addEventListener('click', () => { window.location.href = '/user/logout'; });
		}
		window.scrollTo({ top: successCard.offsetTop - 24, behavior: 'smooth' });
	}
		
		// Initialize test interface features when DOM is ready
		document.addEventListener('DOMContentLoaded', function() {
			// Check if we're on the test interface
			const testQuestions = document.querySelectorAll('.test-question');
			if (testQuestions.length === 0) return;
			window.classroomAnswers = {};
			
			// Get test data from hidden spans
			const testIdEl = document.querySelector('[data-test-id]');
			const questionsDataEl = document.querySelector('[data-questions-json]');
			let testId = null;
			let questionsData = [];
			
			if (testIdEl && questionsDataEl) {
				testId = testIdEl.getAttribute('data-test-id');
				try {
					const jsonStr = questionsDataEl.getAttribute('data-questions-json');
					questionsData = JSON.parse(jsonStr);
				} catch(e) {
					console.error('Failed to parse questions JSON:', e);
				}
			}
			
			// Test Navigation: One question at a time
			let currentQuestion = 1;
			const totalQuestions = testQuestions.length;
			const btnPrev = document.getElementById('btnPrev');
			const btnNext = document.getElementById('btnNext');
			const btnSubmit = document.getElementById('btnSubmit');
			const navError = document.getElementById('nav-error');
			
			function showQuestion(index) {
				testQuestions.forEach(function(el, i) {
					el.style.display = (i + 1) === index ? 'block' : 'none';
				});
				if (btnPrev) btnPrev.disabled = (index === 1);
				if (btnNext) btnNext.style.display = (index === totalQuestions) ? 'none' : 'inline-block';
				if (btnSubmit) btnSubmit.style.display = (index === totalQuestions) ? 'inline-block' : 'none';
				if (navError) navError.textContent = '';
			}
			
			function isQuestionAnswered(index) {
				const questionEl = document.querySelector('.test-question[data-index="' + index + '"]');
				if (!questionEl) return true;
				const questionType = questionEl.getAttribute('data-type');
				
				if (questionType === 'mcq') {
					return window.classroomAnswers[index] !== undefined && window.classroomAnswers[index] !== null;
				} else if (questionType === 'coding') {
					const codeArea = document.getElementById('code-' + index);
					return codeArea && codeArea.value.trim().length > 0;
				} else if (questionType === 'hands_on') {
					const fileInput = document.getElementById('handson-file-' + index);
					return fileInput && fileInput.files && fileInput.files.length > 0;
				}
				return true;
			}
			
			if (btnPrev) {
				btnPrev.addEventListener('click', function() {
					if (currentQuestion > 1) {
						currentQuestion--;
						showQuestion(currentQuestion);
					}
				});
			}
			
			if (btnNext) {
				btnNext.addEventListener('click', function() {
					if (!isQuestionAnswered(currentQuestion)) {
						if (navError) navError.textContent = 'Please answer Question ' + currentQuestion + ' before proceeding.';
						return;
					}
					if (currentQuestion < totalQuestions) {
						currentQuestion++;
						showQuestion(currentQuestion);
					}
				});
			}
			
			if (btnSubmit && testId && questionsData.length > 0) {
				btnSubmit.addEventListener('click', function() {
					if (!isQuestionAnswered(currentQuestion)) {
						if (navError) navError.textContent = 'Please answer Question ' + currentQuestion + ' before proceeding.';
						return;
					}
					window.submitAllTestAnswers(testId, questionsData);
				});
			}
			
			// Initialize
			showQuestion(currentQuestion);
			
			// Timer
			const timerEl = document.getElementById('test-timer');
			if (timerEl && timerEl.getAttribute('data-end-ms')) {
				const endMs = parseInt(timerEl.getAttribute('data-end-ms'));
				if (endMs && !isNaN(endMs)) {
					const updateTimer = () => {
						if (window.__testSubmitted) {
							if (window.__testTimerInterval) {
								clearInterval(window.__testTimerInterval);
								window.__testTimerInterval = null;
							}
							return;
						}
						const remaining = endMs - Date.now();
						timerEl.textContent = formatCountdownFromMs(remaining);
						if (remaining <= 0) {
							if (window.__testTimerInterval) {
								clearInterval(window.__testTimerInterval);
								window.__testTimerInterval = null;
							}
							try {
								window.submitAllTestAnswers(testId, questionsData, { autoSubmit: true });
							} catch (err) {
								console.error('Auto-submit failed:', err);
							}
						}
					};
					updateTimer();
					window.__testTimerInterval = setInterval(updateTimer, 1000);
				}
			}
			
			// Anti-cheat for test interface
			if (testQuestions.length > 0) {
				function reportViolation(type) {
					fetch('/test/violation', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ type: type })
					}).catch(function() {});
				}
				
				// Block right-click
				document.addEventListener('contextmenu', function(e) {
					e.preventDefault();
					reportViolation('right_click');
				});
				
				// Block copy/paste/cut
				document.addEventListener('keydown', function(e) {
					const key = (e.key || '').toLowerCase();
					if (e.ctrlKey && (key === 'c' || key === 'v' || key === 'x' || key === 'tab')) {
						e.preventDefault();
						reportViolation('ctrl+' + key);
					}
				});
				
				document.addEventListener('copy', function(e) {
					e.preventDefault();
					reportViolation('copy');
				});
				
				document.addEventListener('paste', function(e) {
					e.preventDefault();
					reportViolation('paste');
				});
				
				document.addEventListener('cut', function(e) {
					e.preventDefault();
					reportViolation('cut');
				});
				
				// Detect tab switching
				document.addEventListener('visibilitychange', function() {
					if (document.hidden) {
						reportViolation('tab_switch');
					}
				});
				
				window.addEventListener('blur', function() {
					reportViolation('window_blur');
				});
			}
		});
	</script>
	{% if view != 'login' %}
	<header class="container flex-between">
		<h1>Coding Playground</h1>
		<nav>
			{% if session.admin_username %}
				<a class="btn" href="/admin/dashboard">Home</a>
				<a class="btn" href="/admin/logout">Admin Logout</a>
			{% elif session.user_username %}
				<a class="btn" href="/home">Home</a>
				<a class="btn" href="/user/logout">User Logout</a>
			{% else %}
				<a class="btn" href="/">Home</a>
			{% endif %}
		</nav>
	</header>
	{% endif %}

	<main class="container">
		{# Unified Login Page #}
		{% if view == 'login' %}
			<div class="login-page">
				<div class="login-background">
					<div class="login-shapes">
						<div class="shape shape-1"></div>
						<div class="shape shape-2"></div>
						<div class="shape shape-3"></div>
				</div>
				</div>
				
				<div class="login-container">
					<div class="login-box">
						<div class="login-header">
							<div class="login-logo">
						<div class="logo-icon" aria-hidden="true">
							<span class="logo-text">CP</span>
						</div>
							</div>
							<h1 class="login-title">Welcome Back</h1>
							<p class="login-subtitle">Sign in to your Coding Playground account</p>
						</div>
						
						{% if error %}
						<div class="login-error">
					<span class="login-error-icon" aria-hidden="true">!</span>
							<span>{{ error }}</span>
					</div>
						{% endif %}
						
						<form class="login-form" method="post" action="/login">
							<div class="form-group">
								<label for="username" class="form-label">
							<span class="form-label-icon" aria-hidden="true">U</span>
									<span>Username</span>
								</label>
								<input 
									type="text" 
									id="username" 
									name="username" 
									class="form-input" 
									placeholder="Enter your username" 
									required 
									autofocus
									autocomplete="username"
								>
						</div>
							
							<div class="form-group">
								<label for="password" class="form-label">
							<span class="form-label-icon" aria-hidden="true">P</span>
									<span>Password</span>
								</label>
								<input 
									type="password" 
									id="password" 
									name="password" 
									class="form-input" 
									placeholder="Enter your password" 
									required
									autocomplete="current-password"
								>
					</div>
							
							<button type="submit" class="login-btn">
								<span>Sign In</span>
						<span class="login-btn-icon" aria-hidden="true">‚Üí</span>
							</button>
				</form>
					</div>
				</div>
			</div>
		{% endif %}


		{# Admin Dashboard #}
		{% if view == 'admin_dashboard' %}
			<section class="grid">
				<div class="card">
					<h2>Stats</h2>
					<ul class="list">
						<li>Users: <strong>{{ user_count }}</strong></li>
						<li>Classrooms: <strong>{{ classroom_count }}</strong></li>
						<li>Tests: <strong>{{ test_count }}</strong></li>
					</ul>
					<div class="mt">
						<a href="/admin/users" class="btn">Manage Users</a>
						<a href="/admin/users/export" class="btn secondary">Export Users</a>
					</div>
					<div class="mt">
						<a href="/admin/activities" class="btn">Manage Activities</a>
						<a href="/admin/tests" class="btn">Manage Tests</a>
					</div>
					<div class="mt">
						<a href="/admin/submissions" class="btn">üìä View Submissions & Logs</a>
						<a href="/admin/classroom-activities" class="btn secondary">üéØ Try Activities</a>
					</div>
					<div class="mt">
						<a href="/admin/question-generator" class="btn">üß© Question Generator</a>
						<a href="/admin/questionnaire-management" class="btn secondary">üóÇÔ∏è Questionnaire Management</a>
					</div>
				</div>
				<div class="card">
					<h2>üìÇ Create Users via CSV Upload</h2>
					<p class="muted" style="margin-bottom: 1rem;">Upload a CSV file to create multiple users at once</p>
					
					<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #bfdbfe;">
						<p style="margin: 0 0 0.5rem 0; font-weight: 600;">üìã CSV Format Requirements:</p>
						<p style="color: #000000; margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
							<strong>Required:</strong> username, password, university<br>
							<strong>Optional:</strong> role, classroom_id, test_id
						</p>
						<p style="color: #dc2626; margin: 0.75rem 0 0 0; font-size: 0.9rem; font-weight: 600;">
							‚ö†Ô∏è <strong>Important:</strong> Usernames can duplicate, but passwords must be unique!
						</p>
					</div>
					
					<details style="margin-bottom: 1rem;">
						<summary style="cursor: pointer; font-weight: 600; color: #667eea; padding: 0.5rem 0;">üìù Show CSV Example</summary>
						<div style="background: #fef3c7; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; border: 1px solid #fbbf24;">
							<pre style="background: #ffffff; padding: 0.75rem; border-radius: 4px; margin: 0; overflow-x: auto; font-size: 0.85rem; border: 1px solid #e2e8f0;">username,password,university,role,classroom_id,test_id
student1,unique001,MIT,,act001,
student1,unique002,MIT,,,test001
student2,unique003,Stanford,both,act002,test002</pre>
							<p style="color: #92400e; margin: 0.5rem 0 0 0; font-size: 0.85rem;">
								üí° Role auto-detected from IDs if not specified
							</p>
						</div>
					</details>
					
					<form id="dashboardBulkUploadForm" enctype="multipart/form-data">
						<label style="cursor: pointer;">
							<strong>Select CSV File</strong>
							<input type="file" id="dashboardCsvFile" name="csv_file" accept=".csv" required style="cursor: pointer;">
					</label>
						<button type="submit" class="btn" style="width: 100%;">
							<span id="dashboardUploadBtnText">üì§ Upload & Create Users</span>
							<span id="dashboardUploadBtnLoading" style="display: none;">‚è≥ Processing...</span>
						</button>
					</form>
					
					<div id="dashboardUploadResults" style="display: none; margin-top: 1rem;"></div>
					
					<div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">
						<p style="margin: 0; font-size: 0.9rem; color: #000000;">
							üì• <a href="/user_upload_template.csv" download style="color: #3b82f6; font-weight: 600;">Download CSV Template</a>
						</p>
					</div>
				</div>
			</section>

			<section class="grid">
				<div class="card">
					<h2>Create Classroom Activity</h2>
					<p class="muted" style="margin-bottom: 0.75rem;">Generate from Local Question Bank</p>
					<form id="createClassroomForm">
						<label>University
							<select id="classroomUniversity" required></select>
						</label>
						<label>Subject
							<select id="classroomSubject" required></select>
						</label>
						<label>Question Bank
							<select id="classroomBank" required></select>
						</label>
						<label>Module
							<select id="classroomModule" required></select>
						</label>
						<label>Number of MCQ Questions<input type="number" id="classroomMcq" min="0" max="50" value="2" required></label>
						<label>Number of Coding Questions<input type="number" id="classroomCoding" min="0" max="50" value="1" required></label>
						<label>Number of Hands-on Questions<input type="number" id="classroomHandsOn" min="0" max="50" value="0" required></label>
						<label>Classroom ID<input type="text" id="classroomId" required></label>
					<button class="btn" type="submit">Generate Activity</button>
				</form>
					<div id="classroomWarning" class="muted" style="margin-top: 0.5rem; display: none; color: #dc2626;"></div>
				</div>
				<div class="card">
					<h2>Create Test</h2>
					<p class="muted" style="margin-bottom: 0.75rem;">Generate from Local Question Bank</p>
					<form id="createTestForm">
						<label>University
							<select id="testUniversity" required></select>
						</label>
						<label>Subject
							<select id="testSubject" required></select>
						</label>
						<label>Question Bank
							<select id="testBank" required></select>
						</label>
						<label>Module
							<select id="testModule" required></select>
						</label>
						<label>Number of MCQ Questions<input type="number" id="testMcq" min="0" max="50" value="2" required></label>
						<label>Number of Coding Questions<input type="number" id="testCoding" min="0" max="50" value="1" required></label>
						<label>Number of Hands-on Questions<input type="number" id="testHandsOn" min="0" max="50" value="0" required></label>
						<label>Test ID<input type="text" id="testId" required></label>
						<label>Test Start Time<input type="datetime-local" id="testStart" required></label>
						<label>Test End Time<input type="datetime-local" id="testEnd" required></label>
						<button class="btn" type="submit">Create Test</button>
					</form>
					<div id="testWarning" class="muted" style="margin-top: 0.5rem; display: none; color: #dc2626;"></div>
				</div>
			</section>

			{# Question Generator moved to its own admin tab #}

			{% if recent_users %}
			<section class="card">
				<h2>Recent Users</h2>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Role</th>
								<th>Classroom ID</th>
								<th>Test ID</th>
								<th>Created</th>
							</tr>
						</thead>
						<tbody>
							{% for user in recent_users %}
							<tr>
								<td>{{ user.username }}</td>
								<td>{{ user.role }}</td>
								<td>{{ user.classroom_id or '-' }}</td>
								<td>{{ user.test_id or '-' }}</td>
								<td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}
		{% endif %}

		{# Admin Classroom Activities View #}
		{% if view == 'admin_classroom_activities' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>üéØ Try Classroom Activities</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">View and attempt all created classroom activities</p>
			</section>

			{% if activities %}
				{% for activity in activities %}
				<section class="card">
					<div class="flex-between">
						<div>
							<h3>{{ activity.subject }}</h3>
							<p class="muted">Classroom ID: {{ activity.classroom_id }}</p>
							<p class="muted">Created: {{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else 'Unknown' }}</p>
						</div>
						<div>
							<a href="/admin/classroom-activities/{{ activity.activity_id }}" class="btn">üéØ Try Activity</a>
						</div>
					</div>
				</section>
				{% endfor %}
			{% else %}
				<section class="card">
					<h3>No Activities Found</h3>
					<p class="muted">No classroom activities have been created yet.</p>
					<a href="/admin/dashboard" class="btn">Create Activity</a>
				</section>
			{% endif %}
		{% endif %}

		{# Admin Attempt Activity View #}
		{% if view == 'admin_attempt_activity' %}
			<div class="flex-between">
				<h2>üéØ {{ activity.subject }} - Admin Preview</h2>
				<div>
					<a href="/admin/classroom-activities" class="btn secondary">‚Üê Back to Activities</a>
				<a href="/admin/dashboard" class="btn secondary">Dashboard</a>
			</div>
		</div>
		
		{% if questions %}
			{# Question Navigation #}
			{% if questions|length > 1 %}
			<section class="card">
				<div class="question-navigation">
					<h4>üìã Question Navigation:</h4>
				<div class="nav-buttons">
					{% for question in questions %}
					{% set nav_question_num = loop.index %}
					<button class="btn secondary nav-btn" data-question="{{ nav_question_num }}" onclick="showQuestion({{ nav_question_num }})">
						Question {{ nav_question_num }}
					</button>
					{% endfor %}
				</div>
				</div>
			</section>
			{% endif %}
			
		{% for question in questions %}
			{% set admin_question_num = loop.index %}
			<section class="card question-card" id="question-{{ admin_question_num }}" {% if admin_question_num > 1 %}style="display: none;"{% endif %}>
				<div class="question-header">
					<h3>Question {{ admin_question_num }}: {{ question.title }} ({{ admin_question_num }}/{{ questions|length }})</h3>
					<div class="question-controls">
						<span class="difficulty-badge difficulty-{{ question.difficulty }}">{{ question.difficulty|title }}</span>
						{% if questions|length > 1 %}
							{% if admin_question_num > 1 %}
							<button class="btn secondary" onclick="showQuestion({{ admin_question_num - 1 }})">‚Üê Previous</button>
							{% endif %}
							{% if admin_question_num < questions|length %}
							<button class="btn" onclick="showQuestion({{ admin_question_num + 1 }})">Next ‚Üí</button>
							{% endif %}
						{% endif %}
					</div>
				</div>
					
				<div class="question-content">
					<p><strong>Description:</strong></p>
					<div style="white-space: pre-wrap; line-height: 1.6;">{{ question.description }}</div>
					
					{# MCQ Questions for Admin #}
					{% if question.question_type == 'mcq' and question.options %}
					<div style="margin-top: 1.5rem;">
						<p><strong>Options (Admin Preview - View Only):</strong></p>
						<div style="margin: 1rem 0;">
							{% for option in question.options %}
							<div style="padding: 0.75rem; margin: 0.5rem 0; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #3b82f6; color: #000000; border: 1px solid #bfdbfe;">
								{{ option }}
								{% if option[0] == question.correct_answer %}
								<span style="color: #10b981; font-weight: 700; margin-left: 1rem;">‚úì Correct Answer</span>
								{% endif %}
							</div>
							{% endfor %}
						</div>
						{% if question.explanation %}
						<div style="margin-top: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
							<p style="color: #000000; font-weight: 600;">Explanation:</p>
							<p style="color: #000000;">{{ question.explanation }}</p>
						</div>
						{% endif %}
					</div>
					{% endif %}
					
					{# Coding Question Details #}
					{% if question.question_type == 'coding' or not question.question_type %}
					{% if question.input_format %}
					<p><strong>Input Format:</strong></p>
					<pre class="format-box">{{ question.input_format }}</pre>
					{% endif %}
					
					{% if question.output_format %}
					<p><strong>Output Format:</strong></p>
					<pre class="format-box">{{ question.output_format }}</pre>
					{% endif %}
					
					{% if question.sample_input %}
					<p><strong>Sample Input:</strong></p>
					<pre class="sample-box">{{ question.sample_input }}</pre>
					{% endif %}
					
					{% if question.sample_output %}
					<p><strong>Sample Output:</strong></p>
					<pre class="sample-box">{{ question.sample_output }}</pre>
					{% endif %}
					{% endif %}
				</div>
				
			{# Only show code editor for coding questions #}
			{% if question.question_type == 'coding' or not question.question_type %}
			<div class="compiler-section">
				<h4>üêç Code Editor (Admin Preview)</h4>
					<div class="compiler-container">
						<div class="code-section">
							<textarea id="admin-code-{{ admin_question_num }}" class="question-code" rows="8" placeholder="# Write your solution here
# Example:
# def solution():
#     return 'Hello World'">{{ question.sample_code or '' }}</textarea>
							<div class="compiler-controls">
								<button class="btn run-admin-question-code" data-question="{{ admin_question_num }}" data-question-text="{{ question.description|e }}">‚ñ∂Ô∏è Run Code</button>
								<button class="btn secondary clear-admin-question-code" data-question="{{ admin_question_num }}">üóëÔ∏è Clear</button>
							</div>
						</div>
						
						<div class="output-section">
							<label>Output:</label>
							<div id="admin-output-{{ admin_question_num }}" class="output-box">
								<p class="muted">Click "Run Code" to see the output here...</p>
							</div>
						</div>
					</div>
			</div>
			{% endif %}
			</section>
			{% endfor %}
			{% else %}
				<section class="card">
					{% if view == 'test_interface' %}
						<h2>Test Content</h2>
						<details open>
							<summary>Generated Content</summary>
							<pre class="scroll">{{ test.generated }}</pre>
						</details>
					{% else %}
					<h2>Activity Content</h2>
					<details open>
						<summary>Generated Content</summary>
						<pre class="scroll">{{ activity.generated }}</pre>
					</details>
					{% endif %}
				</section>
			{% endif %}
		{% endif %}

		{# Admin Users Management #}
		{% if view == 'admin_users' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>User Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
						<a href="/admin/users/export" class="btn">Export All to CSV</a>
					</div>
				</div>
				<p class="muted">Total Users: {{ total_users }}</p>
			</section>

			{% for university, users in universities.items() %}
			<section class="card">
				<div class="flex-between">
					<h3>üè´ {{ university }} ({{ users|length }} users)</h3>
					<div>
						<a href="/admin/users/export/{{ university|urlencode }}" class="btn secondary small">üì• Export {{ university }} CSV</a>
					</div>
				</div>
				
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Password</th>
								<th>Role</th>
								<th>Classroom ID</th>
								<th>Test ID</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for user in users %}
							<tr>
								<td><strong>{{ user.username }}</strong></td>
								<td>
									<span class="password-display" data-password="{{ user.username }}" data-plain="{{ user.password_plain or 'N/A' }}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
									<button class="btn secondary tiny" onclick="toggleUserPassword('{{ user.username }}')">üëÅÔ∏è</button>
								</td>
								<td><span class="role-badge role-{{ user.role }}">{{ user.role|title }}</span></td>
								<td>{{ user.classroom_id or '-' }}</td>
								<td>{{ user.test_id or '-' }}</td>
								<td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
								<td>
									<button class="btn secondary small" onclick="deleteUser('{{ user.username }}')">üóëÔ∏è Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endfor %}
		{% endif %}

		{# Admin Activities Management #}
		{% if view == 'admin_activities' %}
			<section class="card">
				<div class="flex-between">
					<h2>Activities Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">Total Activities: {{ total_activities }}</p>
			</section>

			<section class="card">
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Subject</th>
								<th>Classroom ID</th>
								<th>Questions</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for activity in activities %}
							<tr>
								<td>{{ activity.subject }}</td>
								<td>{{ activity.classroom_id }}</td>
								<td>{{ activity.num_questions }}</td>
								<td>{{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else '-' }}</td>
								<td>
									<button class="btn secondary small" onclick="deleteActivity('{{ activity.activity_id }}')">Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{% if total_pages > 1 %}
				<div class="pagination">
					{% if page > 1 %}
						<a href="?page={{ page - 1 }}" class="btn secondary">Previous</a>
					{% endif %}
					<span class="muted">Page {{ page }} of {{ total_pages }}</span>
					{% if page < total_pages %}
						<a href="?page={{ page + 1 }}" class="btn secondary">Next</a>
					{% endif %}
				</div>
				{% endif %}
			</section>
			</div>
		{% endif %}

		{# Admin Tests Management #}
		{% if view == 'admin_tests' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>Tests Management</h2>
					<div>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
				<p class="muted">Total Tests: {{ total_tests }}</p>
			</section>

			<section class="card">
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Subject</th>
								<th>Test ID</th>
								<th>Questions</th>
								<th>Scheduled</th>
								<th>Created</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for test in tests %}
							<tr>
								<td>{{ test.subject }}</td>
								<td>{{ test.test_id }}</td>
								<td>{{ test.num_questions }}</td>
								<td>
									{% if test.start_time and test.end_time %}
										{{ test.start_time.strftime('%Y-%m-%d %H:%M') }} - {{ test.end_time.strftime('%Y-%m-%d %H:%M') }}
									{% elif test.scheduled_at %}
										{{ test.scheduled_at.strftime('%Y-%m-%d %H:%M') }}
									{% else %}
										-
									{% endif %}
								</td>
								<td>{{ test.created_at.strftime('%Y-%m-%d %H:%M') if test.created_at else '-' }}</td>
								<td>
									<a href="/debug/test/{{ test.test_id }}" class="btn secondary small" target="_blank">üîç Debug</a>
									<button class="btn secondary small" onclick="deleteTest('{{ test.test_id }}')">üóëÔ∏è Delete</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{% if total_pages > 1 %}
				<div class="pagination">
					{% if page > 1 %}
						<a href="?page={{ page - 1 }}" class="btn secondary">Previous</a>
					{% endif %}
					<span class="muted">Page {{ page }} of {{ total_pages }}</span>
					{% if page < total_pages %}
						<a href="?page={{ page + 1 }}" class="btn secondary">Next</a>
					{% endif %}
				</div>
				{% endif %}
			</section>
			
			<script>
			// Delete test function with confirmation
			async function deleteTest(testId) {
				// Confirm deletion
				const confirmed = confirm(
					`‚ö†Ô∏è DELETE TEST?\n\n` +
					`Test ID: ${testId}\n\n` +
					`This will delete the test and all associated submissions.\n` +
					`This action cannot be undone. Continue?`
				);
				
				if (!confirmed) {
					return;
				}
				
				try {
					const response = await fetch(`/admin/tests/delete/${testId}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						}
					});
					
					const result = await response.json();
					
					if (result.ok) {
						alert('‚úÖ Test deleted successfully!');
						// Reload the page to refresh the list
						window.location.reload();
					} else {
						alert(`‚ùå Error: ${result.message}`);
					}
				} catch (error) {
					console.error('Delete error:', error);
					alert(`‚ùå Failed to delete test: ${error.message}`);
				}
			}
			</script>
			</div>
		{% endif %}

		{# Admin Submissions & Logs Viewer #}
		{% if view == 'admin_submissions' %}
			<div class="manage-page">
			<section class="card">
				<div class="flex-between">
					<h2>üìä Submissions & Violation Logs</h2>
					<div>
						<a href="/admin/submissions/export?context={{ filter_context }}&test_id={{ filter_test }}&username={{ filter_user }}&university={{ filter_university }}" class="btn secondary">üì• Export CSV</a>
						<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				</div>
			</section>

			{# Statistics Cards #}
			<section class="grid">
				<div class="card">
					<h3>üìà Total Submissions</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #3b82f6;">{{ stats.total_submissions }}</p>
					<p class="muted">Completed assessments</p>
				</div>
				<div class="card">
					<h3>‚úÖ Tests Completed</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #10b981;">{{ stats.total_test_completions }}</p>
					<p class="muted">All test submissions</p>
				</div>
				<div class="card">
					<h3>üéì Classroom Completions</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">{{ stats.total_classroom_completions }}</p>
					<p class="muted">Submitted classroom activities</p>
				</div>
				<div class="card">
					<h3>‚ö†Ô∏è Total Violations</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #dc2626;">{{ stats.total_violations }}</p>
					<p class="muted">Anti-cheat warnings captured</p>
				</div>
				<div class="card">
					<h3>üë• Unique Users</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #f59e0b;">{{ stats.unique_users }}</p>
					<p class="muted">Users with submissions</p>
				</div>
				<div class="card">
					<h3>üèõÔ∏è Universities</h3>
					<p style="font-size: 2rem; font-weight: 700; color: #06b6d4;">{{ stats.unique_universities }}</p>
					<p class="muted">Campuses represented</p>
				</div>
			</section>

			{# University Statistics #}
			{% if university_stats %}
			<section class="card">
				<h3>üèõÔ∏è Submissions by University</h3>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>University</th>
								<th>Submissions</th>
								<th>Percentage</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for stat in university_stats %}
							<tr>
								<td><strong>{{ stat._id }}</strong></td>
								<td>{{ stat.count }}</td>
								<td>{{ "%.1f"|format((stat.count / stats.total_submissions * 100) if stats.total_submissions > 0 else 0) }}%</td>
								<td>
									<a href="/admin/submissions?university={{ stat._id }}" class="btn secondary small">Filter by University</a>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}

			{# Violation Statistics #}
			{% if violation_stats %}
			<section class="card">
				<h3>üîç Violation Breakdown</h3>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Violation Type</th>
								<th>Count</th>
								<th>Percentage</th>
							</tr>
						</thead>
						<tbody>
							{% for stat in violation_stats %}
							<tr>
								<td><strong>{{ stat._id }}</strong></td>
								<td>{{ stat.count }}</td>
								<td>{{ "%.1f"|format((stat.count / stats.total_violations * 100) if stats.total_violations > 0 else 0) }}%</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}

			{# Top Violators #}
			{% if user_violations %}
			<section class="card">
				<h3>‚ö†Ô∏è Users with Most Violations (Top 10)</h3>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Username</th>
								<th>Violation Count</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for user_stat in user_violations %}
							<tr>
								<td><strong>{{ user_stat._id }}</strong></td>
								<td><span class="role-badge role-test">{{ user_stat.count }} warnings</span></td>
								<td>
									<a href="/admin/submissions?username={{ user_stat._id }}&context=test_complete" class="btn secondary small">View Details</a>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</section>
			{% endif %}

			{# Filters #}
			<section class="card">
				<h3>üîé Filter Submissions</h3>
				<form method="get" action="/admin/submissions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
					<div>
						<label>Context Type</label>
						<select name="context">
							<option value="all" {% if filter_context == 'all' %}selected{% endif %}>All Completed</option>
							<option value="test_complete" {% if filter_context == 'test_complete' %}selected{% endif %}>‚úÖ Test Complete</option>
							<option value="classroom_activity_complete" {% if filter_context == 'classroom_activity_complete' %}selected{% endif %}>üéì Classroom Complete</option>
						</select>
					</div>
					<div>
						<label>Test ID</label>
						<select name="test_id">
							<option value="all" {% if filter_test == 'all' %}selected{% endif %}>All Tests</option>
							{% for test in all_tests %}
								{% if test %}
								<option value="{{ test }}" {% if filter_test == test %}selected{% endif %}>{{ test }}</option>
								{% endif %}
							{% endfor %}
						</select>
					</div>
					<div>
						<label>Username</label>
						<select name="username">
							<option value="all" {% if filter_user == 'all' %}selected{% endif %}>All Users</option>
							{% for user in all_users %}
							<option value="{{ user }}" {% if filter_user == user %}selected{% endif %}>{{ user }}</option>
							{% endfor %}
						</select>
					</div>
					<div>
						<label>University</label>
						<select name="university">
							<option value="all" {% if filter_university == 'all' %}selected{% endif %}>All Universities</option>
							{% for uni in all_universities %}
								{% if uni and uni != 'Unknown' %}
								<option value="{{ uni }}" {% if filter_university == uni %}selected{% endif %}>{{ uni }}</option>
								{% endif %}
							{% endfor %}
						</select>
					</div>
					<div style="display: flex; align-items: flex-end;">
						<button class="btn" type="submit">Apply Filters</button>
						<a href="/admin/submissions" class="btn secondary" style="margin-left: 0.5rem;">Clear</a>
					</div>
				</form>
			</section>

		{# Grouped Submissions by University ‚Üí Subject #}
		<section class="card">
			<div class="flex-between" style="margin-bottom: 1rem;">
				<h3>üìã Submissions (Grouped by University ‚Üí Subject)</h3>
				<p class="muted">Total: {{ total_submissions }}</p>
			</div>
			{% if grouped_submissions %}
				{% for uni, subjects in grouped_submissions.items() %}
					<div class="card" style="margin-bottom: 1rem;">
						<h3 style="margin:0 0 0.5rem 0;">üèõÔ∏è {{ uni }}</h3>
						{% for subj, subs in subjects.items() %}
							<div class="card" style="margin:0.5rem 0;">
								<div class="flex-between">
									<h4 style="margin:0;">Subject: {{ subj }}</h4>
									<a href="/admin/submissions/export?university={{ uni }}&subject={{ subj }}&context={{ filter_context }}" class="btn secondary small">üì• Export CSV</a>
								</div>
								<div class="table-container" style="margin-top:0.75rem;">
									<table>
										<thead>
											<tr>
												<th>Date/Time</th>
												<th>User</th>
												<th>Context</th>
												<th>Violations</th>
												<th>Score</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for sub in subs %}
											<tr>
												<td>{{ sub.created_at_str }}</td>
												<td>{{ sub.username }}</td>
												<td>
													{% if sub.context == 'test_complete' %}
														<span class="role-badge" style="background:#10b981; color:#ffffff;">Test Completed</span>
													{% elif sub.context == 'classroom_activity_complete' %}
														<span class="role-badge" style="background:#8b5cf6; color:#ffffff;">Classroom Completed</span>
													{% else %}
														<span class="role-badge">{{ sub.context_label }}</span>
													{% endif %}
												</td>
												<td>{% if sub.violations_total > 0 %}<span class="role-badge" style="background:#dc2626; color:#ffffff;">{{ sub.violations_total }}</span>{% else %}<span class="muted">0</span>{% endif %}</td>
												<td>{% if sub.score_display and sub.score_display != '-' %}{{ sub.score_display }}{% else %}-{% endif %}</td>
												<td>
													<div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
														<a href="/admin/submissions/{{ sub._id_str }}" class="btn secondary small" target="_blank">View Details</a>
														<button class="btn danger small" onclick="deleteSubmission('{{ sub._id_str }}', '{{ sub.username }}', '{{ sub.context }}')">üóëÔ∏è Delete</button>
													</div>
												</td>
											</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endfor %}
			{% else %}
				<p class="muted">No submissions found.</p>
			{% endif %}
		</section>
			
			<script>
			// Delete submission function with confirmation
			async function deleteSubmission(submissionId, username, context) {
				// Create a friendly context name
				const contextNames = {
					'test_violation': 'Violation',
					'test_complete': 'Test Completion',
					'test': 'Test Submission',
					'classroom': 'Classroom Submission'
				};

		// submitAllTestAnswers is defined in the shared activity/test script below
				const contextName = contextNames[context] || context;
				
				// Confirm deletion
				const confirmed = confirm(
					`‚ö†Ô∏è DELETE SUBMISSION?\n\n` +
					`User: ${username}\n` +
					`Type: ${contextName}\n` +
					`ID: ${submissionId}\n\n` +
					`This action cannot be undone. Continue?`
				);
				
				if (!confirmed) {
					return;
				}
				
				try {
					const response = await fetch(`/admin/submissions/delete/${submissionId}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						}
					});
					
					const result = await response.json();
					
					if (result.ok) {
						alert('‚úÖ Submission deleted successfully!');
						// Reload the page to refresh the list
						window.location.reload();
					} else {
						alert(`‚ùå Error: ${result.message}`);
					}
				} catch (error) {
					console.error('Delete error:', error);
					alert(`‚ùå Failed to delete submission: ${error.message}`);
				}
			}
			</script>
		{% endif %}

		{# Admin Submission Detail #}
		{% if view == 'admin_submission_detail' %}
			<section class="card">
				<div class="flex-between">
					<h2>üìÑ Submission Details</h2>
					<a href="/admin/submissions" class="btn secondary">‚Üê Back to Submissions</a>
				</div>
			</section>

			{% if error %}
			<section class="card" style="border-left: 4px solid #dc2626;">
				<div class="alert">
					<strong>‚ö†Ô∏è Error Loading Submission</strong><br>
					{{ error }}
				</div>
				<p class="muted">Please check the submission ID and try again.</p>
			</section>
			{% elif submission %}
			<section class="card">
				<h3>Basic Information</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Username</p>
						<p><strong>{{ submission.username }}</strong></p>
					</div>
					<div>
						<p class="muted">Context</p>
						<p><strong>{{ submission.context }}</strong></p>
					</div>
					<div>
						<p class="muted">Test ID</p>
						<p><strong>{{ submission.test_id if submission.test_id else 'N/A' }}</strong></p>
					</div>
					<div>
						<p class="muted">Created At</p>
						<p><strong>{{ submission.created_at.strftime('%Y-%m-%d %H:%M:%S') if submission.created_at else 'N/A' }}</strong></p>
					</div>
				</div>
			</section>

			{% if submission.context == 'test_violation' %}
			<section class="card" style="border-left: 4px solid #dc2626;">
				<h3>‚ö†Ô∏è Violation Details</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Violation Type</p>
						<p><strong style="color: #dc2626;">{{ submission.violation_type }}</strong></p>
					</div>
					<div>
						<p class="muted">Warning Number</p>
						<p><strong>{{ submission.warning_number }}/3</strong></p>
					</div>
				</div>
			</section>
			{% endif %}

			{% if submission.context == 'test' %}
			<section class="card">
				<h3>üìù Test Submission Details</h3>
				<div style="margin-bottom: 1rem;">
					<p class="muted">Question Index</p>
					<p><strong>{{ submission.question_index if submission.question_index is not none else 'N/A' }}</strong></p>
				</div>
				
				{% if submission.user_code %}
				<div style="margin-bottom: 1rem;">
					<p class="muted">Student's Code</p>
					<pre class="scroll" style="max-height: 300px;">{{ submission.user_code }}</pre>
				</div>
				{% endif %}
				
				{% if submission.ai_grading %}
				<div>
					<p class="muted">AI Grading Result</p>
					<pre class="scroll" style="max-height: 300px;">{{ submission.ai_grading }}</pre>
				</div>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'classroom' %}
			<section class="card">
				<h3>üéì Classroom Submission Details</h3>
				
				{% if submission.question_text %}
				<div style="margin-bottom: 1rem;">
					<p class="muted">Question</p>
					<p>{{ submission.question_text }}</p>
				</div>
				{% endif %}
				
				{% if submission.user_code %}
				<div style="margin-bottom: 1rem;">
					<p class="muted">Student's Code</p>
					<pre class="scroll" style="max-height: 300px;">{{ submission.user_code }}</pre>
				</div>
				{% endif %}
				
				{% if submission.ai_feedback %}
				<div>
					<p class="muted">AI Feedback</p>
					<pre class="scroll" style="max-height: 400px;">{{ submission.ai_feedback }}</pre>
				</div>
				{% endif %}
			</section>
			{% endif %}

				{% if submission.details %}
				<section class="card">
					<h3>üìé Uploaded Files</h3>
					<ul>
					{% for d in submission.details %}
						{% if d.question_type == 'hands_on' and d.hands_on_file and d.hands_on_file.saved %}
						<li>
							Question {{ d.question_index }}: 
							<a class="btn secondary small" href="/admin/submissions/file?sub_id={{ submission._id }}&idx={{ loop.index0 }}">Download {{ d.hands_on_file.file_name }}</a>
						</li>
						{% endif %}
					{% endfor %}
					</ul>
			</section>
			{% endif %}

			{% if submission.context == 'classroom_mcq' %}
			<section class="card">
				<h3>üéì Classroom MCQ Submission</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Activity ID</p>
						<p><strong>{{ submission.activity_id }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Index</p>
						<p><strong>{{ submission.question_index }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Title</p>
						<p><strong>{{ submission.question_title or 'N/A' }}</strong></p>
					</div>
				</div>
				
				<div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Student's Answer</p>
						<p><strong>{{ submission.selected_answer }}</strong></p>
					</div>
					<div>
						<p class="muted">Correct Answer</p>
						<p><strong style="color: #10b981;">{{ submission.correct_answer }}</strong></p>
					</div>
					<div>
						<p class="muted">Result</p>
						<p><strong {% if submission.is_correct %}style="color: #10b981;"{% else %}style="color: #dc2626;"{% endif %}>
							{% if submission.is_correct %}‚úì Correct{% else %}‚úó Incorrect{% endif %}
						</strong></p>
					</div>
				</div>
				
				{% if submission.explanation %}
				<div style="margin-top: 1.5rem;">
					<p class="muted">Explanation</p>
					<div style="padding: 1rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
						<p style="color: #000000;">{{ submission.explanation }}</p>
					</div>
				</div>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'classroom_coding' %}
			<section class="card">
				<h3>üéì Classroom Coding Submission</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
					<div>
						<p class="muted">Activity ID</p>
						<p><strong>{{ submission.activity_id }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Index</p>
						<p><strong>{{ submission.question_index }}</strong></p>
					</div>
					<div>
						<p class="muted">Question Title</p>
						<p><strong>{{ submission.question_title or 'N/A' }}</strong></p>
					</div>
				</div>
				
				{% if submission.user_code %}
				<div style="margin-top: 1.5rem;">
					<p class="muted">Student's Code</p>
					<pre class="scroll" style="max-height: 400px;">{{ submission.user_code }}</pre>
				</div>
				{% endif %}
				
				{% if submission.ai_feedback %}
				<div style="margin-top: 1.5rem;">
					<p class="muted">AI Feedback</p>
					<pre class="scroll" style="max-height: 400px; white-space: pre-wrap;">{{ submission.ai_feedback }}</pre>
				</div>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'classroom_activity_complete' %}
			<section class="card" style="border-left: 4px solid #8b5cf6;">
				<h3>üéì Classroom Activity - Final Submission</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
					<div>
						<p class="muted">Activity ID</p>
						<p><strong>{{ submission.activity_id }}</strong></p>
					</div>
					<div>
						<p class="muted">Score</p>
						<p><strong style="font-size: 1.5rem; color: #8b5cf6;">{{ submission.score }}</strong></p>
					</div>
					<div>
						<p class="muted">Percentage</p>
						<p><strong style="font-size: 1.5rem; color: #10b981;">{{ submission.percentage }}%</strong></p>
					</div>
					<div>
						<p class="muted">Correct Answers</p>
						<p><strong>{{ submission.correct_count }} / {{ submission.total_questions }}</strong></p>
					</div>
				</div>
				
				<h4>üìä Question-by-Question Breakdown</h4>
				{% if submission.details %}
				<div style="display: grid; gap: 1rem; margin-top: 1rem;">
					{% for detail in submission.details %}
					<div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 4px solid {% if detail.is_correct %}#10b981{% else %}#dc2626{% endif %};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<h5 style="margin: 0; color: #000000;">Question {{ detail.question_index }}: {{ detail.question_title }}</h5>
							<span style="font-weight: 600; color: {% if detail.is_correct %}#10b981{% else %}#dc2626{% endif %};">
								{% if detail.is_correct %}‚úÖ Correct{% else %}‚ùå Incorrect{% endif %}
							</span>
						</div>
						<p style="margin: 0.5rem 0; color: #666;"><strong>Type:</strong> {{ 'Multiple Choice' if detail.question_type == 'mcq' else 'Coding' }}</p>
						
						{% if detail.question_type == 'mcq' %}
						<div style="margin-top: 1rem;">
							<p style="margin: 0.25rem 0; color: #000000;"><strong>Student's Answer:</strong> {{ detail.selected_answer or 'No answer' }}</p>
							<p style="margin: 0.25rem 0; color: #10b981;"><strong>Correct Answer:</strong> {{ detail.correct_answer }}</p>
							{% if detail.explanation %}
							<div style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 4px; border: 1px solid #bfdbfe;">
								<p style="margin: 0; color: #000000;"><strong>Explanation:</strong> {{ detail.explanation }}</p>
							</div>
							{% endif %}
						</div>
						{% elif detail.question_type == 'coding' %}
						<div style="margin-top: 1rem;">
							{% if detail.user_code %}
							<details>
								<summary style="cursor: pointer; color: #3b82f6; font-weight: 600;">View Code</summary>
								<pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 4px; overflow-x: auto; margin-top: 0.5rem;">{{ detail.user_code }}</pre>
							</details>
							{% endif %}
							{% if detail.ai_feedback %}
							<div style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 4px; border: 1px solid #bfdbfe;">
								<p style="margin: 0; color: #000000;"><strong>AI Evaluation:</strong></p>
								<pre style="white-space: pre-wrap; margin: 0.5rem 0 0 0; color: #000000;">{{ detail.ai_feedback }}</pre>
							</div>
							{% endif %}
						</div>
						{% endif %}
					</div>
					{% endfor %}
				</div>
				{% else %}
				<p class="muted">No detailed breakdown available.</p>
				{% endif %}
			</section>
			{% endif %}

			{% if submission.context == 'test_complete' %}
			<section class="card" style="border-left: 4px solid #10b981;">
				<h3>üìä Final Test Result</h3>
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
					<div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe;">
						<p class="muted">Score</p>
						<p style="font-size: 2rem; font-weight: 700; color: #10b981;">{{ submission.percentage|default(0) }}%</p>
					</div>
					<div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe;">
						<p class="muted">Correct</p>
						<p style="font-size: 2rem; font-weight: 700; color: #000000;">{{ submission.correct_count }}/{{ submission.total_questions }}</p>
					</div>
					<div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe;">
						<p class="muted">Warnings</p>
						<p style="font-size: 2rem; font-weight: 700; color: #dc2626;">{{ submission.violation_count|default(0) }}</p>
					</div>
				</div>
			</section>

			<section class="card">
				<h3>üìã Question-by-Question Breakdown</h3>
				{% if submission.details %}
				<div style="display: grid; gap: 1rem; margin-top: 1rem;">
					{% for detail in submission.details %}
					<div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 4px solid {% if detail.is_correct %}#10b981{% else %}#dc2626{% endif %};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<h5 style="margin: 0; color: #000000;">Question {{ detail.question_index }}: {{ detail.question_title }}</h5>
							<span style="font-weight: 600; color: {% if detail.is_correct %}#10b981{% else %}#dc2626{% endif %};">{% if detail.is_correct %}‚úÖ Correct{% else %}‚ùå Incorrect{% endif %}</span>
						</div>
						<p style="margin: 0.5rem 0; color: #666;"><strong>Type:</strong> {{ 'Multiple Choice' if detail.question_type == 'mcq' else (detail.question_type|title) }}</p>
						{% if detail.question_type == 'mcq' %}
							<p style="margin: 0.25rem 0; color: #000000;"><strong>Student's Answer:</strong> {{ detail.selected_answer or 'No answer' }}</p>
							<p style="margin: 0.25rem 0; color: #10b981;"><strong>Correct Answer:</strong> {{ detail.correct_answer }}</p>
							{% if detail.explanation %}
							<div style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 4px; border: 1px solid #bfdbfe;">
								<p style="margin: 0; color: #000000;"><strong>Explanation:</strong> {{ detail.explanation }}</p>
							</div>
							{% endif %}
						{% elif detail.question_type == 'coding' %}
							{% if detail.user_code %}
							<div style="margin-top: 1rem;">
								<p class="muted" style="margin-bottom: 0.5rem;"><strong>Student's Code:</strong></p>
								<pre class="scroll" style="max-height: 400px; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;">{{ detail.user_code }}</pre>
							</div>
							{% else %}
							<p class="muted" style="margin-top: 0.5rem;">No code submitted.</p>
							{% endif %}
							{% if detail.ai_feedback %}
							{% set bg_color = '#d1fae5' if detail.is_correct else '#fee2e2' %}
							{% set border_color = '#10b981' if detail.is_correct else '#dc2626' %}
							<div style="margin-top: 1rem; padding: 1rem; background: {{ bg_color }}; border-radius: 8px; border-left: 4px solid {{ border_color }};">
								<p style="margin: 0 0 0.5rem 0; color: #000000; font-weight: 600;"><strong>AI Validation:</strong></p>
								{% set feedback_lower = detail.ai_feedback.lower() %}
								{% if 'submitted successfully' in feedback_lower and feedback_lower.strip() == 'your code has been submitted successfully.' %}
								<p style="margin: 0; color: #dc2626; font-weight: 600;">‚ö†Ô∏è No AI validation was performed. The code was submitted but could not be evaluated.</p>
								{% else %}
								<pre style="white-space: pre-wrap; margin: 0; color: #000000; font-size: 0.95rem; line-height: 1.6;">{{ detail.ai_feedback }}</pre>
								{% endif %}
								{% if detail.score is defined %}
								<p style="margin: 0.75rem 0 0 0; color: #000000;"><strong>Score:</strong> {{ "%.1f"|format(detail.score * 100) }}%</p>
								{% endif %}
							</div>
							{% else %}
							<div style="margin-top: 1rem; padding: 1rem; background: #fee2e2; border-radius: 8px; border-left: 4px solid #dc2626;">
								<p style="margin: 0; color: #dc2626; font-weight: 600;">‚ö†Ô∏è No AI validation available for this submission.</p>
							</div>
							{% endif %}
						{% elif detail.question_type == 'hands_on' %}
							{% if detail.hands_on_file and detail.hands_on_file.saved %}
							<p><a class="btn secondary small" href="/admin/submissions/file?sub_id={{ submission._id }}&idx={{ loop.index0 }}">Download {{ detail.hands_on_file.file_name }}</a></p>
							{% else %}
							<p class="muted">No file uploaded.</p>
							{% endif %}
						{% endif %}
					</div>
					{% endfor %}
				</div>
				{% else %}
				<p class="muted">No detailed answers available.</p>
				{% endif %}
			</section>

			{% if submission and submission.violation_count %}
			<section class="card" style="border-left: 4px solid #f59e0b;">
				<h3>‚ö†Ô∏è Anti-cheat Notices</h3>
				<p class="muted">Total warnings captured: <strong>{{ submission.violation_count }}</strong></p>
				{% if submission and submission.violations %}
				<div class="table-container" style="margin-top: 0.75rem;">
					<table>
						<thead>
							<tr>
								<th>#</th>
								<th>Violation</th>
								<th>Timestamp</th>
							</tr>
						</thead>
						<tbody>
							{% for v in submission.violations %}
							<tr>
								<td>{{ loop.index }}</td>
								<td>{{ v.type|default('unknown') }}</td>
								<td>{{ v.timestamp|default('N/A') }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% endif %}
			</section>
			{% endif %}

			<section class="card">
				<h3>üîç Raw Data (JSON)</h3>
				<details>
					<summary>Click to view full submission document</summary>
					<pre class="scroll" style="max-height: 500px;">{{ submission | tojson(indent=2) }}</pre>
				</details>
			</section>
		{% endif %}
	{% endif %}
	{% endif %}

		{# Test Submitted Home View #}
		{% if view == 'test_submitted_home' %}
		<section class="container narrow">
			<h2>‚úÖ Test Submitted</h2>
			<p class="muted">Test submitted successfully. Your responses have been recorded and will be reviewed by an administrator.</p>
			<div class="card" style="margin-top: 1.5rem;">
				<h3>Submission Summary</h3>
				<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:1rem; margin-top:1rem;">
					<div>
						<p class="muted">Test ID</p>
						<p><strong>{{ test.test_id if test else 'N/A' }}</strong></p>
					</div>
					<div>
						<p class="muted">Subject</p>
						<p><strong>{{ test.subject if test and test.subject else 'N/A' }}</strong></p>
					</div>
					<div>
						<p class="muted">Module</p>
						<p><strong>{{ test.module if test and test.module else 'N/A' }}</strong></p>
					</div>
				</div>
				<div style="margin-top: 1.5rem; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:1rem;">
					<p style="margin:0; color:#1f2937;">You can close this window or continue exploring the platform. Any anti-cheat notices will be reviewed automatically.</p>
				</div>
				<div style="display:flex; gap:0.75rem; flex-wrap:wrap; margin-top: 1.75rem;">
					<a class="btn" href="/home">Go to Home</a>
					<a class="btn secondary" href="/user/logout">Logout</a>
				</div>
			</div>
		</section>
		{% endif %}

		{# User Home - Test Status View #}
		{# User Selection (for "both" role) #}
		{% if view == 'user_selection' %}
			<section class="container narrow">
				<h2>Welcome, {{ user.username }}!</h2>
				<p>You have access to both classroom activities and tests. Choose what you'd like to do:</p>
				<div class="grid">
					<div class="card">
						<h3>Classroom Activities</h3>
						<p>Work on coding exercises and get AI feedback.</p>
						<a class="btn" href="/classroom">Go to Classroom</a>
					</div>
					<div class="card">
						<h3>Take Test</h3>
						<p>Take your scheduled coding test.</p>
						<a class="btn" href="/test">Go to Test</a>
					</div>
					<div class="card">
						<h3>üêç Python Compiler</h3>
						<p>Write and run Python code directly in your browser.</p>
						<a class="btn" href="/compiler">Open Compiler</a>
					</div>
				</div>
			{% if submission and submission.violation_count %}
			<div style="margin-top: 2rem;">
				<h4>‚ö†Ô∏è Anti-cheat Summary</h4>
				<p class="muted">Total warnings captured: <strong>{{ submission.violation_count }}</strong></p>
				{% if submission and submission.violations %}
				<div class="table-container" style="margin-top: 1rem;">
					<table>
						<thead>
							<tr>
								<th>#</th>
								<th>Violation</th>
								<th>When</th>
							</tr>
						</thead>
						<tbody>
							{% for v in submission.violations %}
							<tr>
								<td>{{ loop.index }}</td>
								<td>{{ v.type|default('unknown') }}</td>
								<td>{{ v.timestamp|default('N/A') }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% endif %}
			</div>
			{% endif %}
		</section>
		{% endif %}

		{# Classroom List #}
		{% if view == 'classroom' %}
			<div class="flex-between">
				<h2>Classroom ID: {{ classroom_id }}</h2>
				<a class="btn secondary" href="/compiler">üêç Python Compiler</a>
			</div>
			{% if activities|length == 0 %}
				<p class="muted">No activities yet.</p>
			{% else %}
				<div class="grid">
					{% for act in activities %}
					<div class="card">
						<h3>{{ act.subject }}</h3>
						<p class="small muted">Created {{ act.created_at }}</p>
						<a class="btn" href="/activity/{{ act.activity_id }}">Open</a>
					</div>
					{% endfor %}
				</div>
			{% endif %}
		{% endif %}

		{# Activity Detail #}
		{% if view == 'activity' or view == 'test_interface' %}
			<div class="flex-between">
				{% if view == 'test_interface' %}
					<h2>{{ test.subject }} - Test</h2>
					<div style="display:flex; align-items:center; gap:0.75rem;">
						<div id="test-timer" data-end-ms="{{ end_time_ms|default('') }}" style="font-weight:700; color:#dc2626;"></div>
						<a class="btn secondary" href="/test">‚Üê Back to Test Info</a>
					</div>
					<!-- Hidden data for timer auto-submit -->
					<span data-test-id="{{ test.test_id }}" style="display:none;"></span>
					<span data-questions-json="{{ questions|tojson|forceescape }}" style="display:none;"></span>
				{% else %}
				<h2>{{ activity.subject }} Activity</h2>
				<a class="btn secondary" href="/classroom">‚Üê Back to Activities</a>
				{% endif %}
			</div>
			
			{% if questions %}
				{% for question in questions %}
				{% set question_num = loop.index %}
				<section class="card question-card{% if view == 'test_interface' %} test-question{% endif %}" data-index="{{ question_num }}" data-type="{{ question.question_type }}" {% if view == 'test_interface' and question_num > 1 %}style="display:none;"{% endif %}>
					<div class="question-header">
						<h3>Question {{ question_num }}: {{ question.title }}</h3>
						<!-- DEBUG: question_num = {{ question_num }}, loop.index = {{ loop.index }} -->
						<div style="display: flex; gap: 0.5rem; align-items: center;">
							<span class="difficulty-badge difficulty-{{ question.difficulty }}">
								{% if question.difficulty == 'medium_plus' %}
									Medium+ (Coding)
								{% else %}
									{{ question.difficulty|title }}
								{% endif %}
							</span>
							{% if question.question_type == 'mcq' %}
							<span class="role-badge role-classroom">üìù MCQ</span>
							{% elif question.question_type == 'coding' %}
							<span class="role-badge role-test">üíª Coding</span>
							{% endif %}
						</div>
					</div>
					
					<div class="question-content">
						<p><strong>Description:</strong></p>
						<div style="white-space: pre-wrap; line-height: 1.6;">{{ question.description }}</div>
						
						{# MCQ Questions #}
						{% if question.question_type == 'mcq' and question.options %}
						<div style="margin-top: 1.5rem;" id="mcq-question-{{ question_num }}">
							<p><strong>Select the correct answer:</strong></p>
							<!-- DEBUG: Rendering MCQ for question_num={{ question_num }}, Total options={{ question.options|length }} -->
							<div style="margin: 1rem 0;" id="mcq-options-{{ question_num }}">
								{% for option in question.options %}
							<div class="mcq-option-classroom" data-option-index="{{ loop.index0 }}" data-option-text="{{ option }}" data-question-idx="{{ question_num }}" onclick="selectClassroomMCQ(this, {{ question_num }});" style="padding: 0.75rem; margin: 0.5rem 0; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #3b82f6; cursor: pointer; transition: all 0.2s; color: #000000; border: 1px solid #bfdbfe;">
									{{ option }}
								</div>
								{% endfor %}
							</div>
							
							<div style="margin-top: 1rem;">
								<button class="btn secondary" onclick="clearClassroomMCQ({{ question_num }});">
									Clear Selection
								</button>
								<span id="mcq-status-{{ question_num }}" class="muted" style="margin-left: 1rem;"></span>
							</div>
							
							{% if question.hints %}
							<details style="margin-top: 1rem;">
								<summary style="cursor: pointer; color: #2563eb; font-weight: 600;">üí° Show Hints</summary>
								<div style="margin-top: 0.5rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe; color: #000000;">
									{% for hint in question.hints %}
									<p>‚Ä¢ {{ hint }}</p>
									{% endfor %}
								</div>
							</details>
							{% endif %}
						</div>
						{% endif %}
						
						{# Coding Questions #}
						{% if question.question_type == 'coding' or not question.question_type %}
						{% if question.input_format %}
						<p><strong>Input Format:</strong></p>
						<pre class="format-box">{{ question.input_format }}</pre>
						{% endif %}
						
						{% if question.output_format %}
						<p><strong>Output Format:</strong></p>
						<pre class="format-box">{{ question.output_format }}</pre>
						{% endif %}
						
						{% if question.sample_input %}
						<p><strong>Sample Input:</strong></p>
						<pre class="sample-box">{{ question.sample_input }}</pre>
						{% endif %}
						
						{% if question.sample_output %}
						<p><strong>Sample Output:</strong></p>
						<pre class="sample-box">{{ question.sample_output }}</pre>
						{% endif %}
						
						{% if question.constraints %}
						<p><strong>Constraints:</strong></p>
						<p style="color: #f59e0b;">{{ question.constraints }}</p>
						{% endif %}
						{% endif %}
					</div>
					
					{# Only show code editor for coding questions #}
					{% if question.question_type == 'coding' or not question.question_type %}
					<div class="compiler-section" id="coding-question-{{ question_num }}">
						<h4>üêç Code Editor</h4>
						<div class="compiler-container">
							<div class="code-section">
								<textarea id="code-{{ question_num }}" class="question-code" rows="8" placeholder="# Write your solution here
# Example:
# def solution():
#     return 'Hello World'">{{ question.sample_code or '' }}</textarea>
								<div class="compiler-controls">
									{% if view != 'test_interface' %}
									<button class="btn run-question-code" data-question="{{ question_num }}" data-question-text="{{ question.description|e }}">‚ñ∂Ô∏è Run Code</button>
									{% endif %}
									<button class="btn secondary clear-question-code" data-question="{{ question_num }}">üóëÔ∏è Clear</button>
								</div>
							</div>
							
							{% if view != 'test_interface' %}
							<div class="output-section">
								<label>Output:</label>
								<div id="output-{{ question_num }}" class="output-box">
									<p class="muted">Click "Run Code" to see the output here...</p>
								</div>
							</div>
							{% endif %}
						</div>
						
						<div style="margin-top: 1rem;">
							<span id="coding-status-{{ question_num }}" class="muted"></span>
						</div>
					</div>
					{% endif %}

					{# Hands-on Questions #}
					{% if question.question_type == 'hands_on' %}
					<div class="handson-section" id="handson-question-{{ question_num }}" style="margin-top: 1rem;">
						<p><strong>Hands-on Upload:</strong></p>
						<input type="file" id="handson-file-{{ question_num }}" />
						<p class="muted" style="margin-top: 0.5rem;">Upload any file type as your solution.</p>
					</div>
					{% endif %}
				</section>
				{% endfor %}
			{% else %}
				<section class="card">
					<h2>Activity Content</h2>
					<details open>
						<summary>Generated Content</summary>
						<pre class="scroll">{{ activity.generated }}</pre>
					</details>
				</section>
		{% endif %}
		
		{# Classroom Activity Submission Buttons #}
		{% if questions and view == 'activity' %}
		<section class="card" style="border-left: 4px solid #10b981;">
			<h3>üìù Submit Your Answers</h3>
			<p class="muted">Review all your answers above and click Submit when ready. You can still change your answers before submitting.</p>
			<div style="margin-top: 1.5rem;">
				<button class="btn" type="button" onclick="submitAllClassroomAnswers('{{ activity.activity_id }}', {{ questions | tojson | forceescape }})" style="font-size: 1.1rem; padding: 1rem 2rem;">
					‚úÖ Submit All Answers
				</button>
				<button class="btn secondary" onclick="window.location.href='/classroom'" style="margin-left: 1rem;">
					Cancel
				</button>
			</div>
			<div id="final-result" style="margin-top: 2rem; display: none;"></div>
		</section>
		{% endif %}
		
		{# Test Interface Navigation Buttons #}
		{% if view == 'test_interface' %}
		<section class="card" id="test-nav" style="margin-top:1rem;">
			<div class="flex-between">
				<div>
					<button class="btn secondary" type="button" id="btnPrev">‚Üê Previous</button>
					<button class="btn" type="button" id="btnNext">Next ‚Üí</button>
					<button class="btn" type="button" id="btnSubmit" style="display:none; margin-left: 0.5rem;">‚úÖ Submit Test</button>
				</div>
				<div id="nav-error" class="muted" style="color:#dc2626 !important; font-weight:600;"></div>
			</div>
		</section>
		<section class="card" id="test-success-message" style="display:none; margin-top: 1.5rem; border-left: 4px solid #10b981;">
			<h3>‚úÖ Test Submitted Successfully</h3>
			<p id="test-success-text" style="margin: 1rem 0;">Thank you. Your test responses have been recorded and submitted for evaluation.</p>
			<div id="test-success-violations" style="display:none; margin: 1rem 0; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
				<strong style="color: #92400e;">‚ö†Ô∏è Anti-cheat notices captured</strong>
				<p style="margin: 0.5rem 0 0 0; color: #92400e;">Warnings triggered: <span id="test-success-violation-count">0</span>. An administrator will review these events.</p>
			</div>
			<div style="display:flex; gap:0.75rem; flex-wrap:wrap; margin-top: 1.5rem;">
				<button class="btn" onclick="window.location.href='/test'">Return to Test Page</button>
				<button class="btn secondary" onclick="window.location.href='/user/logout'">Logout</button>
			</div>
		</section>
		{% endif %}
		
		{# Fallback for activities without questions #}
		{% if view == 'activity' and not questions %}
		<section class="card">
			<form method="post" action="/classroom/complete">
				<button class="btn secondary" type="submit">Complete Activity</button>
			</form>
		</section>
		{% endif %}
		{% endif %}

		{# Test View #}
		{% if view == 'test' %}
			{% if error %}
				<section class="container narrow">
					<div class="card" style="border-left: 4px solid #dc2626;">
						<h2>‚ö†Ô∏è Test Error</h2>
						<p style="font-size: 1.1rem; margin: 1.5rem 0;">{{ error }}</p>
						
						{% if already_completed %}
						<div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #fbbf24;">
							<h3 style="color: #92400e; margin: 0 0 0.5rem 0;">üìã Test Details</h3>
							{% if test %}
							<p style="color: #000000; margin: 0.5rem 0;"><strong>Test:</strong> {{ test.subject }}</p>
							{% endif %}
							{% if completion_time %}
							<p style="color: #000000; margin: 0.5rem 0;"><strong>Completed At:</strong> {{ completion_time.strftime('%Y-%m-%d %H:%M:%S') }}</p>
							{% endif %}
							<p style="color: #fbbf24; margin-top: 1rem;">
								‚ö†Ô∏è <strong>Once submitted, tests cannot be retaken.</strong>
							</p>
						</div>
						
						<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid #bfdbfe;">
							<p style="color: #000000; margin: 0;">
								Your responses have been recorded and are being evaluated by your instructor. Results will be shared at a later time.
							</p>
						</div>
						{% endif %}
						
						<div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
							<a class="btn" href="/home">Return Home</a>
							<a class="btn secondary" href="/user/logout">Logout</a>
						</div>
					</div>
				</section>
			{% elif test %}
				<div class="flex-between">
					<h2>{{ test.subject }}</h2>
					<a class="btn secondary" href="/compiler">üêç Python Compiler</a>
				</div>
				<div class="card">
					<p class="muted">Test ID: {{ test.test_id }}</p>
					<p class="muted">Questions: {{ test.num_questions }}</p>
					
					{# Display time information based on test format #}
					{% if start_time and end_time %}
						<p class="muted">Test Window: {{ start_time.strftime('%Y-%m-%d %H:%M') }} - {{ end_time.strftime('%Y-%m-%d %H:%M') }} (Local Time)</p>
					{% elif scheduled_at %}
						<p class="muted">Scheduled for: {{ scheduled_at.strftime('%Y-%m-%d %H:%M') }} (Local Time)</p>
					{% else %}
						<p class="muted">Not scheduled</p>
					{% endif %}
					
					<p class="muted">Current time: {{ current_time.strftime('%Y-%m-%d %H:%M') if current_time else 'Unknown' }} (Local Time)</p>
					
					{# Test status display #}
					{% if test_status == 'open' %}
						<div class="alert success">
							<strong>‚úÖ Test is now open!</strong><br>
							You can now begin the test.
							{% if start_time and end_time %}
							<div id="test-timer" class="mt">
								<p>Time remaining: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% endif %}
						</div>
						<a href="/test/start" class="btn">Attempt Test</a>
					{% elif test_status == 'not_started' %}
						<div class="alert">
							<strong>‚è∞ Test not yet open</strong><br>
							Please wait until the scheduled start time to begin the test.
							{% if start_time %}
							<div id="countdown" class="mt">
								<p>Time until test opens: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% elif scheduled_at %}
							<div id="countdown" class="mt">
								<p>Time until test opens: <span id="time-remaining">Calculating...</span></p>
							</div>
							{% endif %}
						</div>
						<button class="btn disabled" id="attempt-btn" disabled onclick="showNotOpenMessage()">
							Attempt Test
						</button>
					{% elif test_status == 'expired' %}
						<div class="alert" style="background: #7f1d1d; border-color: #dc2626; color: #fca5a5;">
							<strong>‚ùå Test has expired</strong><br>
							The test window has closed. You can no longer attempt this test.
						</div>
						<button class="btn disabled" id="attempt-btn" disabled onclick="showExpiredMessage()">
							Attempt Test
						</button>
					{% else %}
						<div class="alert">
							<strong>‚ö†Ô∏è No test scheduled</strong><br>
							No test has been scheduled for you.
						</div>
					{% endif %}
			{% endif %}
		{% endif %}


		{# Admin: Question Generator #}
		{% if view == 'admin_question_generator' %}
			<section class="card">
				<div class="flex-between">
					<h2>üß© Question Generator</h2>
					<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
					</div>
				<p class="muted">Create subjects with modules and questions. All data stored in MongoDB.</p>
			</section>

			<section class="card">
				<form id="localQGForm">
					<label>University
						<input type="text" id="qgUniversity" placeholder="e.g., MIT" required>
					</label>
					<label>Subject Name
						<input type="text" id="qgSubject" placeholder="e.g., Data Structures" required>
					</label>
					<div id="qgModulesContainer" style="margin-top: 1rem;"></div>
					<div style="margin-top: 1rem;">
						<button class="btn" id="qgAddModuleBtn" type="button">‚ûï Add Module</button>
						<button class="btn secondary" id="qgClearAllBtn" type="button">üóëÔ∏è Clear Form</button>
						</div>
						<div style="margin-top: 1rem;">
						<button class="btn" id="qgSubmitBankBtn" type="button">üíæ Save to Question Bank</button>
						</div>
				</form>
			</section>
					{% endif %}
					
		{# Admin: Questionnaire Management #}
		{% if view == 'admin_questionnaire_management' %}
			<section class="card">
				<div class="flex-between">
					<h2>üóÇÔ∏è Questionnaire Management</h2>
					<a href="/admin/dashboard" class="btn secondary">Back to Dashboard</a>
				</div>
				<p class="muted">View, edit, and manage all question banks stored in MongoDB.</p>
			</section>
			
			<section class="card">
				<div id="qmGroups"></div>
				<div id="qmDetailContainer" style="margin-top: 1.5rem; display:none;"></div>
			</section>
			{% endif %}
		

		{# JavaScript for test preview #}
		{% if view == 'test' %}
		<script>
		// Countdown timer for test opening/closing
		{% if start_time and end_time %}
		(function(){
			// Times are already in local timezone from server
			const startTime = new Date('{{ start_time.strftime('%Y-%m-%dT%H:%M:%S') }}');
			const endTime = new Date('{{ end_time.strftime('%Y-%m-%dT%H:%M:%S') }}');
			const countdownElement = document.getElementById('time-remaining');
			
			function updateCountdown() {
				const now = new Date();
				
				if (now < startTime) {
					// Test not started yet
					const timeLeft = startTime - now;
					const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
					const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
					const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
					
					let timeString = '';
					if (days > 0) timeString += days + 'd ';
					if (hours > 0) timeString += hours + 'h ';
					if (minutes > 0) timeString += minutes + 'm ';
					timeString += seconds + 's';
					
					countdownElement.textContent = timeString;
				} else if (now >= startTime && now <= endTime) {
					// Test is open - show time remaining
					const timeLeft = endTime - now;
					const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
					const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
					const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
					
					let timeString = '';
					if (days > 0) timeString += days + 'd ';
					if (hours > 0) timeString += hours + 'h ';
					if (minutes > 0) timeString += minutes + 'm ';
					timeString += seconds + 's';
					
					countdownElement.textContent = timeString;
					
					if (timeLeft <= 0) {
						location.reload(); // Reload when test expires
						return;
					}
				} else {
					// Test has expired
					countdownElement.textContent = 'Test has expired';
				}
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		})();
		{% elif scheduled_at %}
		(function(){
			// Time is already in local timezone from server
			const scheduledTime = new Date('{{ scheduled_at.strftime('%Y-%m-%dT%H:%M:%S') }}');
			const countdownElement = document.getElementById('time-remaining');
			
			function updateCountdown() {
				const now = new Date();
				const timeLeft = scheduledTime - now;
				
				if (timeLeft <= 0) {
					countdownElement.textContent = 'Test is now open!';
					location.reload(); // Reload to show the test
					return;
				}
				
				const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
				const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
				const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
				const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
				
				let timeString = '';
				if (days > 0) timeString += days + 'd ';
				if (hours > 0) timeString += hours + 'h ';
				if (minutes > 0) timeString += minutes + 'm ';
				timeString += seconds + 's';
				
				countdownElement.textContent = timeString;
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		})();
		{% endif %}
		
		// Show message when attempt button is clicked before test opens
		function showNotOpenMessage() {
			alert('Test is not yet open. Please wait until the scheduled time to begin the test.');
		}
		
		// Show message when attempt button is clicked after test expires
		function showExpiredMessage() {
			alert('Test has expired. The test window has closed and you can no longer attempt this test.');
		}
		</script>
		{% endif %}

		{# Test Result #}
		{% if view == 'test_result' %}
			<section class="container narrow">
				<div class="card" style="text-align: center;">
					<div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
					<h2>Test Submitted Successfully!</h2>
					<p class="muted" style="font-size: 1.1rem; margin: 1.5rem 0;">
						Thank you for completing the test.
					</p>
					
					{% if test %}
					<div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid #bfdbfe;">
						<p style="color: #000000;"><strong>Test:</strong> {{ test.subject }}</p>
						{% if total_questions %}
						<p style="color: #000000;"><strong>Questions Answered:</strong> {{ total_questions }}</p>
						{% endif %}
					</div>
					{% endif %}
					
					<div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid #bfdbfe;">
						<p style="color: #000000;">
							<strong>üìä Results</strong><br>
							Your responses have been recorded and will be evaluated by your instructor.<br>
							Results will be shared by your instructor at a later time.
						</p>
					</div>
					
					<p class="muted" style="margin: 1.5rem 0;">
						You may now safely close this window or logout.
					</p>
					
					<div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
						<a class="btn" href="/home">Return Home</a>
						<a class="btn secondary" href="/user/logout">Logout</a>
					</div>
				</div>
			</section>
		{% endif %}

		{# Python Compiler #}
		{% if view == 'compiler' %}
			<section class="container">
				<div class="card">
					<h2>üêç Python Compiler</h2>
					<p class="muted">Write and run Python code directly in your browser</p>
					
					<div class="compiler-container">
						<div class="code-section">
							<label for="python-code">Your Python Code:</label>
							<textarea id="python-code" rows="15" placeholder="# Write your Python code here
print('Hello, World!')
x = 5
y = 10
print(f'Sum: {x + y}')"></textarea>
							<div class="compiler-controls">
								<button id="run-code" class="btn">‚ñ∂Ô∏è Run Code</button>
								<button id="clear-code" class="btn secondary">üóëÔ∏è Clear</button>
							</div>
						</div>
						
						<div class="output-section">
							<label>Output:</label>
							<div id="compiler-output" class="output-box">
								<p class="muted">Click "Run Code" to see the output here...</p>
							</div>
						</div>
					</div>
					
					<div class="compiler-info">
						<h3>Features:</h3>
						<ul>
							<li>‚úÖ Safe code execution with timeout protection</li>
							<li>‚úÖ Standard Python libraries available</li>
							<li>‚úÖ Real-time output display</li>
							<li>‚úÖ Error handling and debugging</li>
						</ul>
					</div>
				</div>
			</section>
		{% endif %}
	</main>

	<footer class="container">
		<small>&copy; <span id="year"></span> Coding Playground</small>
	</footer>
	<script>
	// Global helpers available across all views
	if (typeof window.toggleUserPassword !== 'function') {
		window.toggleUserPassword = function(username) {
			const passwordSpan = document.querySelector(`span[data-password="${username}"]`);
			if (!passwordSpan) return;
			const button = passwordSpan.nextElementSibling;
			const plainPassword = passwordSpan.getAttribute('data-plain');
			if (passwordSpan.textContent.trim() === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
				passwordSpan.textContent = plainPassword || 'N/A';
				if (button) {
					button.textContent = 'üôà';
					button.title = 'Click to hide password';
				}
			} else {
				passwordSpan.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
				if (button) {
					button.textContent = 'üëÅÔ∏è';
					button.title = 'Click to show password';
				}
			}
		};
	}
	</script>
	
	<script>
	// GLOBAL: MCQ handlers must be available for both activity and test_interface views
	// These functions are called from inline onclick attributes in the HTML
	window.classroomAnswers = window.classroomAnswers || {};
	window.classroomCode = window.classroomCode || {};
	
	// MCQ Selection Handler - ALWAYS AVAILABLE
	window.selectClassroomMCQ = function(element, questionIdx) {
		if (!element || !questionIdx) return;
		
		const optionIdxStr = element.getAttribute('data-option-index');
		const optionText = element.getAttribute('data-option-text') || element.textContent.trim();
		const optionDataIdx = element.getAttribute('data-question-idx');
		const optionIdx = optionIdxStr !== null ? parseInt(optionIdxStr, 10) : NaN;
		
		if (optionDataIdx != questionIdx) return;
		
		const selector = `.mcq-option-classroom[data-question-idx="${questionIdx}"]`;
		const allOptions = document.querySelectorAll(selector);
		
		if (allOptions.length === 0) return;
		
		// Clear all selections in this question
		allOptions.forEach(opt => {
			opt.style.background = '#f0f9ff';
			opt.style.borderLeft = '3px solid #3b82f6';
			opt.style.fontWeight = 'normal';
			opt.style.border = '1px solid #bfdbfe';
		});
		
		// Highlight the selected option
		element.style.background = '#dbeafe';
		element.style.borderLeft = '3px solid #10b981';
		element.style.fontWeight = '600';
		element.style.border = '2px solid #10b981';
		
		// Store answer (prefer numeric index for validation)
		window.classroomAnswers[questionIdx] = Number.isFinite(optionIdx) ? optionIdx : optionText;
		
		// Update visual status indicator
		const statusEl = document.getElementById(`mcq-status-${questionIdx}`);
		if (statusEl) {
			statusEl.textContent = `‚úì Selected: ${optionText}`;
			statusEl.style.color = '#10b981';
			statusEl.style.fontWeight = '600';
		}
	};
	
	// Clear MCQ selection
	window.clearClassroomMCQ = function(questionIdx) {
		if (!questionIdx) return;
		
		const selector = `.mcq-option-classroom[data-question-idx="${questionIdx}"]`;
		const allOptions = document.querySelectorAll(selector);
		
		if (allOptions.length === 0) return;
		
		// Reset all option styles to default
		allOptions.forEach(opt => {
			opt.style.background = '#f0f9ff';
			opt.style.borderLeft = '3px solid #3b82f6';
			opt.style.fontWeight = 'normal';
			opt.style.border = '1px solid #bfdbfe';
		});
		
		// Remove from stored answers
			delete window.classroomAnswers[questionIdx];
		
		// Clear visual status indicator
		const statusEl = document.getElementById(`mcq-status-${questionIdx}`);
		if (statusEl) {
			statusEl.textContent = '';
		}
	};
	
	window.submitAllClassroomAnswers = async function(activityId, questions) {
		// Collect all answers
		const answers = [];
		let missingAnswers = [];
		
		let hasHandsOn = false;
		// Collect MCQ, coding, hands_on answers
		questions.forEach((question, index) => {
			const questionIdx = index + 1;
			
			if (question.question_type === 'mcq') {
				const selectedAnswer = window.classroomAnswers[questionIdx];
				const hasSelection = !(selectedAnswer === undefined || selectedAnswer === null || (typeof selectedAnswer === 'string' && selectedAnswer.trim() === ''));
				if (!hasSelection) {
					missingAnswers.push(`Question ${questionIdx} (MCQ)`);
				}
				answers.push({
					question_index: questionIdx,
					question_type: 'mcq',
					question_data: question,
					selected_answer: hasSelection ? selectedAnswer : null
				});
			} else if (question.question_type === 'coding') {
				const codeTextarea = document.getElementById(`code-${questionIdx}`);
				const code = codeTextarea ? codeTextarea.value.trim() : '';
				if (!code) {
					missingAnswers.push(`Question ${questionIdx} (Coding)`);
				}
				answers.push({
					question_index: questionIdx,
					question_type: 'coding',
					question_data: question,
					user_code: code || null
				});
			} else if (question.question_type === 'hands_on') {
				hasHandsOn = true;
				const fileInput = document.getElementById(`handson-file-${questionIdx}`);
				const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
				if (!file) {
					missingAnswers.push(`Question ${questionIdx} (Hands-on)`);
				}
				answers.push({
					question_index: questionIdx,
					question_type: 'hands_on',
					question_data: question,
					file_field: `file_q${questionIdx}`
				});
			}
		});
		
		// Warn if any answers are missing
		if (missingAnswers.length > 0) {
			if (!confirm(`‚ö†Ô∏è The following questions have no answers:\n\n${missingAnswers.join('\n')}\n\nDo you want to submit anyway?`)) {
				return;
			}
		}
		
		// Final confirmation
		if (!confirm(`üìù Submit all ${answers.length} answers?\n\nYou cannot change your answers after submitting.`)) {
			return;
		}
		
		try {
			// Show loading state
			const resultDiv = document.getElementById('final-result');
			resultDiv.style.display = 'block';
			resultDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><p style="color: #3b82f6; font-size: 1.2rem;">‚è≥ Evaluating your answers...</p><p class="muted">This may take a moment...</p></div>';
			
			// Disable all inputs
			document.querySelectorAll('.mcq-option-classroom, textarea, button, input[type=file]').forEach(el => {
				el.disabled = true;
				el.style.opacity = '0.6';
				el.style.cursor = 'not-allowed';
			});
			
			// Send to backend (FormData if hands-on present)
			let response;
			if (hasHandsOn) {
				const fd = new FormData();
				fd.append('activity_id', activityId);
				fd.append('answers', JSON.stringify(answers));
				answers.forEach(ans => {
					if (ans.question_type === 'hands_on'){
						const qi = ans.question_index;
						const fileEl = document.getElementById(`handson-file-${qi}`);
						if (fileEl && fileEl.files && fileEl.files[0]){
							fd.append(ans.file_field, fileEl.files[0]);
						}
					}
				});
				response = await fetch('/classroom/submit_all', { method: 'POST', body: fd });
			} else {
				response = await fetch('/classroom/submit_all', {
				method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ activity_id: activityId, answers })
				});
			}
			
			const result = await response.json();
			
			if (result.ok) {
				// Display final score
				displayFinalResult(result);
			} else {
				resultDiv.innerHTML = `<div style="padding: 2rem; background: #fee2e2; border-radius: 12px; border: 2px solid #dc2626;"><p style="color: #dc2626; font-size: 1.2rem;">‚ùå Error: ${result.error}</p></div>`;
			}
		} catch (error) {
			console.error('Submission error:', error);
			const resultDiv = document.getElementById('final-result');
			resultDiv.innerHTML = '<div style="padding: 2rem; background: #fee2e2; border-radius: 12px; border: 2px solid #dc2626;"><p style="color: #dc2626;">‚ùå Failed to submit answers. Please try again.</p></div>';
		}
	};

	// Display final results
	function displayFinalResult(result) {
		const resultDiv = document.getElementById('final-result');
		if (!resultDiv) return;
		const isTestView = (window.APP_CONTEXT && window.APP_CONTEXT.view === 'test_interface');
		if (isTestView) {
			const violationCount = Number((result && (result.violation_count ?? result.warning_count ?? 0)) || 0);
			let html = '<div style="padding: 2rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 12px; color: #ffffff; text-align: center;">';
			html += '<h2 style="margin: 0 0 1rem 0; font-size: 2rem;">‚úÖ Test Submitted</h2>';
			html += '<p style="margin: 0 0 1rem 0; font-size: 1.1rem;">Your responses have been recorded. An administrator will review them shortly.</p>';
			if (violationCount > 0) {
				html += `<div style="margin: 1.5rem auto 0 auto; max-width: 420px; background: rgba(254, 243, 199, 0.25); border: 1px solid rgba(234, 179, 8, 0.5); border-radius: 10px; padding: 1rem; color: #fef3c7;">`;
				html += `<strong style="display:block; margin-bottom:0.35rem;">‚ö†Ô∏è Anti-cheat notices recorded</strong>`;
				html += `<span>Warnings captured: ${violationCount}</span>`;
				html += '</div>';
			}
			html += '<div style="margin-top: 1.75rem; display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap;">';
			html += '<button class="btn" onclick="window.location.href=\'/home\'">Return to Home</button>';
			html += '<button class="btn secondary" onclick="window.location.href=\'/user/logout\'">Logout</button>';
			html += '</div>';
			html += '</div>';
			resultDiv.style.display = 'block';
			resultDiv.innerHTML = html;
			return;
		}
		let html = '<div style="padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; text-align: center;">';
		html += '<h2 style="margin: 0 0 1rem 0; font-size: 2rem;">üéâ Submission Complete!</h2>';
		html += `<div style="font-size: 3rem; font-weight: 700; margin: 1rem 0;">${result.correct_count}/${result.total_questions}</div>`;
		html += `<div style="font-size: 1.5rem; margin: 0.5rem 0;">${result.percentage}%</div>`;
		html += `<p style="margin: 1rem 0 0 0; opacity: 0.9;">You answered ${result.correct_count} out of ${result.total_questions} questions correctly.</p>`;
		html += '</div>';
		if (result.details && result.details.length > 0) {
			html += '<div style="margin-top: 2rem;">';
			html += '<h3>üìä Detailed Breakdown</h3>';
		result.details.forEach((detail) => {
				html += '<div style="padding: 1rem; margin: 1rem 0; background: #f9fafb; border-radius: 8px; border-left: 4px solid ';
				html += detail.is_correct ? '#10b981' : '#dc2626';
				html += ';">';
				html += `<h4 style="margin: 0 0 0.5rem 0; color: #000000;">Question ${detail.question_index}</h4>`;
			html += `<p style="margin: 0; color: #666;">Type: ${detail.question_type === 'mcq' ? 'Multiple Choice' : detail.question_type === 'coding' ? 'Coding' : 'Hands-on'}</p>`;
				html += `<p style="margin: 0.5rem 0 0 0; font-weight: 600; color: ${detail.is_correct ? '#10b981' : '#dc2626'};">`;
				html += detail.is_correct ? '‚úÖ Correct' : '‚ùå Incorrect';
				html += '</p>';
				html += '</div>';
			});
			html += '</div>';
		}
		html += '<div style="margin-top: 2rem; text-align: center;">';
		html += '<button class="btn" onclick="window.location.href=\'/classroom\'">Return to Classroom</button>';
		html += '</div>';
		resultDiv.innerHTML = html;
	}
	
	document.addEventListener('DOMContentLoaded', function() {
		// Handle question-specific code execution
		document.querySelectorAll('.run-question-code').forEach(button => {
			button.addEventListener('click', async function() {
				const questionNum = this.dataset.question;
				const questionText = this.dataset.questionText;
				const codeTextarea = document.getElementById(`code-${questionNum}`);
				const outputDiv = document.getElementById(`output-${questionNum}`);
				
				const code = codeTextarea.value.trim();
				if (!code) {
					outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
					return;
				}
				
				// Show loading state
				this.disabled = true;
				this.textContent = '‚è≥ Running...';
				outputDiv.innerHTML = '<p class="muted">Executing code and validating...</p>';
				
				try {
					const formData = new FormData();
					formData.append('code', code);
					formData.append('question_text', questionText);
					
					const response = await fetch('/question/execute', {
						method: 'POST',
						body: formData
					});
					
					const result = await response.json();
					
					// Display results
					if (result.success) {
						outputDiv.className = 'output-box output-success';
						let output = '';
						if (result.output) {
							output += '=== CODE OUTPUT ===\n';
							output += result.output;
						}
						if (result.error) {
							output += '\n\n=== ERRORS ===\n';
							output += result.error;
						}
						if (result.validation) {
							output += '\n\n=== AI VALIDATION ===\n';
							output += result.validation;
						}
						outputDiv.textContent = output || 'Code executed successfully (no output)';
					} else {
						outputDiv.className = 'output-box output-error';
						outputDiv.textContent = `Error: ${result.error}`;
					}
				} catch (error) {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Network error: ${error.message}`;
				} finally {
					// Reset button state
					this.disabled = false;
					this.textContent = '‚ñ∂Ô∏è Run Code';
				}
			});
		});
		
		// Handle clear code buttons
		document.querySelectorAll('.clear-question-code').forEach(button => {
			button.addEventListener('click', function() {
				const questionNum = this.dataset.question;
				const codeTextarea = document.getElementById(`code-${questionNum}`);
				const outputDiv = document.getElementById(`output-${questionNum}`);
				
				codeTextarea.value = '';
				outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
				outputDiv.className = 'output-box';
			});
		});
		
		// Keyboard shortcuts for code editors
		document.querySelectorAll('.question-code').forEach(textarea => {
			textarea.addEventListener('keydown', function(e) {
				if (e.ctrlKey && e.key === 'Enter') {
					e.preventDefault();
					const questionNum = this.id.split('-')[1];
					const runButton = document.querySelector(`[data-question="${questionNum}"].run-question-code`);
					if (runButton) {
						runButton.click();
					}
				}
			});
		});
	});

	// Lightweight anti-cheat hooks for test interface
	(function(){
		const currentView = document.body.dataset.view || '';
		if (currentView !== 'test_interface') return;
		async function reportViolation(type){
			try {
				await fetch('/test/violation', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ type })
				});
			} catch (e) {}
		}
		// Block right-click
		document.addEventListener('contextmenu', function(e){ e.preventDefault(); reportViolation('right_click'); });
		// Block copy/paste/cut shortcuts
		document.addEventListener('keydown', function(e){
			const k = (e.key || '').toLowerCase();
			if (e.ctrlKey && (k === 'c' || k === 'v' || k === 'x' || k === 'tab')){
				e.preventDefault();
				reportViolation('ctrl+' + k);
			}
		});
		// Also block clipboard events
		document.addEventListener('copy', function(e){ e.preventDefault(); reportViolation('copy'); });
		document.addEventListener('paste', function(e){ e.preventDefault(); reportViolation('paste'); });
		document.addEventListener('cut', function(e){ e.preventDefault(); reportViolation('cut'); });
		// Detect tab/window switch
		document.addEventListener('visibilitychange', function(){ if (document.hidden) reportViolation('tab_switch'); });
		window.addEventListener('blur', function(){ reportViolation('window_blur'); });
	})();
	</script>

	{% if view == 'admin_users' %}
	<script>
	async function deleteUser(username) {
		if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/users/delete/${username}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting user');
			}
		} catch (error) {
			alert('Error deleting user: ' + error.message);
		}
	}
	
	</script>
	{% endif %}

	{% if view == 'admin_attempt_activity' %}
	<script>
	// Question navigation function
	function showQuestion(questionNum) {
		// Hide all questions
		document.querySelectorAll('.question-card').forEach(card => {
			card.style.display = 'none';
		});
		
		// Show selected question
		const selectedCard = document.getElementById(`question-${questionNum}`);
		if (selectedCard) {
			selectedCard.style.display = 'block';
		}
		
		// Update navigation buttons
		document.querySelectorAll('.nav-btn').forEach(btn => {
			btn.classList.remove('active');
		});
		const activeBtn = document.querySelector(`[data-question="${questionNum}"]`);
		if (activeBtn) {
			activeBtn.classList.add('active');
		}
	}
	
	// JavaScript for admin activity code execution
	document.addEventListener('DOMContentLoaded', function() {
		document.querySelectorAll('.run-admin-question-code').forEach(button => {
			button.addEventListener('click', async function() {
				const questionNum = this.dataset.question;
				const questionText = this.dataset.questionText;
				const codeTextarea = document.getElementById(`admin-code-${questionNum}`);
				const outputDiv = document.getElementById(`admin-output-${questionNum}`);
				
				const code = codeTextarea.value.trim();
				if (!code) {
					outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
					return;
				}
				
				this.disabled = true;
				this.textContent = '‚è≥ Running...';
				outputDiv.innerHTML = '<p class="muted">Executing code and validating...</p>';
				
				try {
					const formData = new FormData();
					formData.append('code', code);
					formData.append('question_text', questionText);
					
					const response = await fetch('/admin/question/execute', {
						method: 'POST',
						body: formData
					});
					
					const result = await response.json();
					
					if (result.success) {
						outputDiv.className = 'output-box output-success';
						let output = '';
						if (result.output) {
							output += '=== CODE OUTPUT ===\n';
							output += result.output;
						}
						if (result.error) {
							output += '\n\n=== ERRORS ===\n';
							output += result.error;
						}
						if (result.validation) {
							output += '\n\n=== AI VALIDATION ===\n';
							output += result.validation;
						}
						outputDiv.textContent = output || 'Code executed successfully (no output)';
					} else {
						outputDiv.className = 'output-box output-error';
						outputDiv.textContent = `Error: ${result.error}`;
					}
				} catch (error) {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Network error: ${error.message}`;
				} finally {
					this.disabled = false;
					this.textContent = '‚ñ∂Ô∏è Run Code';
				}
			});
		});
		
		document.querySelectorAll('.clear-admin-question-code').forEach(button => {
			button.addEventListener('click', function() {
				const questionNum = this.dataset.question;
				const codeTextarea = document.getElementById(`admin-code-${questionNum}`);
				const outputDiv = document.getElementById(`admin-output-${questionNum}`);
				
				codeTextarea.value = '';
				outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
				outputDiv.className = 'output-box';
			});
		});
		
		document.querySelectorAll('#admin-code-\\d+').forEach(textarea => {
			textarea.addEventListener('keydown', function(e) {
				if (e.ctrlKey && e.key === 'Enter') {
					e.preventDefault();
					const questionNum = this.id.split('-')[2];
					const runButton = document.querySelector(`[data-question="${questionNum}"].run-admin-question-code`);
					if (runButton) {
						runButton.click();
					}
				}
			});
		});
	});
	</script>
	{% endif %}

	{% if view == 'admin_activities' %}
	<script>
	async function deleteActivity(activityId) {
		if (!confirm(`Are you sure you want to delete this activity?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/admin/activities/delete/${activityId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const data = await response.json();
			
			if (data.ok) {
				alert(data.message);
				location.reload();
			} else {
				alert(data.message || 'Error deleting activity');
			}
		} catch (error) {
			alert('Error deleting activity: ' + error.message);
		}
	}
	</script>
	{% endif %}

	<script>
		// Coding Playground - Client-side JavaScript

		document.addEventListener('DOMContentLoaded', function() {
		const bulkForm = document.getElementById('dashboardBulkUploadForm');
		if (bulkForm) {
			bulkForm.addEventListener('submit', async function(e) {
				e.preventDefault();
				const fileInput = document.getElementById('dashboardCsvFile');
				const file = fileInput?.files?.[0];
				if (!file) {
					showAlert('Please select a CSV file', 'danger');
					return;
				}
				document.getElementById('dashboardUploadBtnText')?.style?.setProperty('display','none');
				document.getElementById('dashboardUploadBtnLoading')?.style?.setProperty('display','inline');
				const resultsDiv = document.getElementById('dashboardUploadResults');
				if (resultsDiv) resultsDiv.style.display = 'none';
				const formData = new FormData();
				formData.append('csv_file', file);
				try {
					const response = await fetch('/admin/bulk_create_users', { method: 'POST', body: formData });
					const data = await response.json();
					document.getElementById('dashboardUploadBtnText')?.style?.setProperty('display','inline');
					document.getElementById('dashboardUploadBtnLoading')?.style?.setProperty('display','none');
					if (resultsDiv) {
						resultsDiv.innerHTML = data.ok
							? `<div style="background:#d1fae5;padding:1rem;border-radius:8px;border:2px solid #10b981;">‚úÖ Created ${data.created} user(s). Errors: ${data.errors}</div>`
							: `<div style="background:#fecaca;padding:1rem;border-radius:8px;border:2px solid #dc2626;">‚ùå ${data.error || 'Upload failed'}</div>`;
						resultsDiv.style.display = 'block';
					}
					fileInput.value = '';
					if (data.created > 0) {
						setTimeout(() => location.reload(), 3000);
					}
				} catch (error) {
					document.getElementById('dashboardUploadBtnText')?.style?.setProperty('display','inline');
					document.getElementById('dashboardUploadBtnLoading')?.style?.setProperty('display','none');
					showAlert('Upload failed: ' + error.message, 'danger');
				}
			});
		}
		const codeTextarea = document.getElementById('python-code');
			const runButton = document.getElementById('run-code');
			const clearButton = document.getElementById('clear-code');
			const outputDiv = document.getElementById('compiler-output');
			if (!codeTextarea || !runButton || !clearButton || !outputDiv) {
				return;
			}
			async function runCode() {
				const code = codeTextarea.value.trim();
				if (!code) {
					outputDiv.innerHTML = '<p class="muted">Please enter some Python code to run.</p>';
					return;
				}
				runButton.disabled = true;
				runButton.textContent = '‚è≥ Running...';
				outputDiv.innerHTML = '<p class="muted">Executing code...</p>';
				try {
					const formData = new FormData();
					formData.append('code', code);
					const response = await fetch('/compiler/execute', {
						method: 'POST',
						body: formData
					});
					const result = await response.json();
					if (result.success) {
						outputDiv.className = 'output-box output-success';
						let output = '';
						if (result.output) output += result.output;
						if (result.error) output += '\n--- Errors ---\n' + result.error;
						outputDiv.textContent = output || 'Code executed successfully (no output)';
					} else {
						outputDiv.className = 'output-box output-error';
						outputDiv.textContent = `Error: ${result.error}`;
					}
				} catch (error) {
					outputDiv.className = 'output-box output-error';
					outputDiv.textContent = `Network error: ${error.message}`;
				} finally {
					runButton.disabled = false;
					runButton.textContent = '‚ñ∂Ô∏è Run Code';
				}
			}
			function clearCode() {
				codeTextarea.value = '';
				outputDiv.innerHTML = '<p class="muted">Click "Run Code" to see the output here...</p>';
				outputDiv.className = 'output-box';
			}
			runButton.addEventListener('click', runCode);
			clearButton.addEventListener('click', clearCode);
			codeTextarea.addEventListener('keydown', function(e) {
				if (e.ctrlKey && e.key === 'Enter') {
					e.preventDefault();
					runCode();
				}
			});
		});

		// Set current year
		document.getElementById('year') && (document.getElementById('year').textContent = new Date().getFullYear());

		// Utility functions
		function showAlert(message, type = 'info') {
			const alertDiv = document.createElement('div');
			alertDiv.className = `alert ${type}`;
			alertDiv.textContent = message;
			
			// Insert at the top of the page
			const container = document.querySelector('.container');
			if (container) {
				container.insertBefore(alertDiv, container.firstChild);
				
				// Auto-remove after 5 seconds
				setTimeout(() => {
					alertDiv.remove();
				}, 5000);
			}
		}

		function togglePassword(inputId) {
			const input = document.getElementById(inputId);
			const toggle = document.querySelector(`[onclick="togglePassword('${inputId}')"]`);
			
			if (input.type === 'password') {
				input.type = 'text';
				toggle.textContent = 'Hide';
			} else {
				input.type = 'password';
				toggle.textContent = 'Show';
			}
		}

		// Form validation
		function validateForm(formId) {
			const form = document.getElementById(formId);
			if (!form) return false;
			
			const requiredFields = form.querySelectorAll('[required]');
			let isValid = true;
			
			requiredFields.forEach(field => {
				if (!field.value.trim()) {
					field.style.borderColor = '#dc2626';
					isValid = false;
				} else {
					field.style.borderColor = '#334155';
				}
			});
			
			return isValid;
		}

		// AJAX helper
		async function makeRequest(url, options = {}) {
			try {
				const response = await fetch(url, {
					headers: {
						'Content-Type': 'application/json',
						...options.headers
					},
					...options
				});
				
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				
				return await response.json();
			} catch (error) {
				console.error('Request failed:', error);
				showAlert(`Network error: ${error.message}`, 'danger');
				throw error;
			}
		}

		// Delete confirmation
		function confirmDelete(itemType, itemName) {
			return confirm(`Are you sure you want to delete this ${itemType}?\n\n${itemName}\n\nThis action cannot be undone.`);
		}

		// Countdown timer
		function startCountdown(targetTime, elementId) {
			const element = document.getElementById(elementId);
			if (!element) return;
			
			function updateCountdown() {
				const now = new Date().getTime();
				const target = new Date(targetTime).getTime();
				const distance = target - now;
				
				if (distance < 0) {
					element.innerHTML = "Time's up!";
					return;
				}
				
				const days = Math.floor(distance / (1000 * 60 * 60 * 24));
				const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
				const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
				const seconds = Math.floor((distance % (1000 * 60)) / 1000);
				
				let countdownText = "";
				if (days > 0) countdownText += days + "d ";
				if (hours > 0) countdownText += hours + "h ";
				if (minutes > 0) countdownText += minutes + "m ";
				countdownText += seconds + "s";
				
				element.innerHTML = countdownText;
			}
			
			updateCountdown();
			setInterval(updateCountdown, 1000);
		}

		// Code execution
		async function executeCode(code, outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (!outputElement) return;
			
			outputElement.textContent = "Running code...";
			outputElement.className = "output-area";
			
			try {
				const response = await makeRequest('/compiler/execute', {
					method: 'POST',
					body: JSON.stringify({ code: code })
				});
				
				if (response.success) {
					outputElement.textContent = response.output || "No output";
					outputElement.className = "output-area";
				} else {
					outputElement.textContent = `Error: ${response.error}`;
					outputElement.className = "output-area alert";
				}
			} catch (error) {
				outputElement.textContent = `Execution failed: ${error.message}`;
				outputElement.className = "output-area alert";
			}
		}

		// Question code execution
		async function executeQuestionCode(questionId, code, outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (!outputElement) return;
			
			outputElement.textContent = "Running code...";
			outputElement.className = "output-area";
			
			try {
				const response = await makeRequest('/question/execute', {
					method: 'POST',
					body: JSON.stringify({ 
						question_id: questionId,
						code: code 
					})
				});
				
				if (response.success) {
					outputElement.textContent = response.output || "No output";
					outputElement.className = "output-area";
					
					if (response.validation) {
						const validationDiv = document.createElement('div');
						validationDiv.className = 'alert info';
						validationDiv.innerHTML = `<strong>AI Validation:</strong><br>${response.validation}`;
						outputElement.parentNode.appendChild(validationDiv);
					}
				} else {
					outputElement.textContent = `Error: ${response.error}`;
					outputElement.className = "output-area alert";
				}
			} catch (error) {
				outputElement.textContent = `Execution failed: ${error.message}`;
				outputElement.className = "output-area alert";
			}
		}

		// Admin question code execution
		async function executeAdminQuestionCode(questionId, code, outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (!outputElement) return;
			
			outputElement.textContent = "Running code...";
			outputElement.className = "output-area";
			
			try {
				const response = await makeRequest('/admin/question/execute', {
					method: 'POST',
					body: JSON.stringify({ 
						question_id: questionId,
						code: code 
					})
				});
				
				if (response.success) {
					outputElement.textContent = response.output || "No output";
					outputElement.className = "output-area";
					
					if (response.validation) {
						const validationDiv = document.createElement('div');
						validationDiv.className = 'alert info';
						validationDiv.innerHTML = `<strong>AI Validation:</strong><br>${response.validation}`;
						outputElement.parentNode.appendChild(validationDiv);
					}
				} else {
					outputElement.textContent = `Error: ${response.error}`;
					outputElement.className = "output-area alert";
				}
			} catch (error) {
				outputElement.textContent = `Execution failed: ${error.message}`;
				outputElement.className = "output-area alert";
			}
		}

		// Clear output
		function clearOutput(outputElementId) {
			const outputElement = document.getElementById(outputElementId);
			if (outputElement) {
				outputElement.textContent = "";
				outputElement.className = "output-area";
			}
		}

		// Test restrictions removed - tests now display properly without restrictions

		// Auto-save form data
		function autoSaveForm(formId) {
			const form = document.getElementById(formId);
			if (!form) return;
			
			const inputs = form.querySelectorAll('input, textarea, select');
			
			inputs.forEach(input => {
			// Skip file inputs (cannot be set programmatically for security reasons)
			if (input.type === 'file') return;
			
				// Load saved data
				const saved = localStorage.getItem(`form_${formId}_${input.name}`);
				if (saved) {
					input.value = saved;
				}
				
				// Save on change
				input.addEventListener('input', () => {
					localStorage.setItem(`form_${formId}_${input.name}`, input.value);
				});
			});
		}

		// Clear auto-saved data
		function clearAutoSave(formId) {
			const form = document.getElementById(formId);
			if (!form) return;
			
			const inputs = form.querySelectorAll('input, textarea, select');
			inputs.forEach(input => {
			// Skip file inputs
			if (input.type === 'file') return;
				localStorage.removeItem(`form_${formId}_${input.name}`);
			});
		}

		// Initialize auto-save for forms
		document.addEventListener('DOMContentLoaded', () => {
			const forms = document.querySelectorAll('form[id]');
			forms.forEach(form => autoSaveForm(form.id));
		});

		// Export functions to global scope for HTML onclick handlers
		window.toggleUserPassword = toggleUserPassword;
		window.togglePassword = togglePassword;
		window.executeCode = executeCode;
		window.executeQuestionCode = executeQuestionCode;
		window.executeAdminQuestionCode = executeAdminQuestionCode;
		window.clearOutput = clearOutput;
		window.confirmDelete = confirmDelete;
		window.startCountdown = startCountdown;
		window.showAlert = showAlert;

			// ===== Question Bank & Activity/Test Generation (No OpenAI) =====
			// All data (question banks, activities, tests, submissions) are stored in MongoDB only
			
			// Export functions to global scope so they're available everywhere
			window.QuestionBankModule = window.QuestionBankModule || {};
			
			(function(){
				function uid(){ return Math.random().toString(36).slice(2,10); }

				function ensureContainers(){
					if (document.getElementById('localAttemptContainer')) return;
					const host = document.createElement('section');
					host.className = 'card';
					host.id = 'localAttemptContainer';
					host.style.display = 'none';
					host.innerHTML = `
						<h2 id="attemptTitle">Attempt</h2>
						<div id="attemptMeta" class="muted" style="margin-bottom: 0.75rem;"></div>
						<div id="attemptQuestions" style="display: grid; gap: 0.75rem;"></div>
						<div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
							<button class="btn" id="attemptSubmitBtn">Submit</button>
							<button class="btn secondary" id="attemptCancelBtn">Cancel</button>
						</div>
						<div id="attemptResult" style="margin-top: 0.75rem;"></div>
					`;
					document.body.insertBefore(host, document.body.lastElementChild);
				}

				async function renderSubjectModuleOptions(){
					const allSelectors = [
						{university: 'classroomUniversity', subject: 'classroomSubject', module: 'classroomModule'},
						{university: 'testUniversity', subject: 'testSubject', module: 'testModule'}
					];
					
					try {
						const response = await fetch('/api/question-bank/subjects');
						const result = await response.json();
						if (!result.ok) {
							console.error('Failed to fetch subjects:', result.error);
							return;
						}
						const grouped = result.grouped || {};
						allSelectors.forEach(({university: uniId, subject: subjId, module: modId})=>{
							const uniSel = document.getElementById(uniId);
							const subjSel = document.getElementById(subjId);
							const modSel = document.getElementById(modId);
							const bankSel = document.getElementById(subjId.replace('Subject','Bank'));
							if (!uniSel || !subjSel || !modSel) return;
							// Fill universities
							uniSel.innerHTML = '';
							const universities = Object.keys(grouped).sort();
							if (universities.length === 0){ uniSel.innerHTML = '<option value="">No universities</option>'; subjSel.innerHTML='<option value="">-</option>'; modSel.innerHTML='<option value="">-</option>'; return; }
							universities.forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; uniSel.appendChild(o); });
							// When university changes, populate subjects
							function updateSubjects(){
								subjSel.innerHTML=''; modSel.innerHTML=''; if (bankSel) bankSel.innerHTML='';
								const u = uniSel.value;
								const raw = grouped[u] || [];
								// Support both string list and object list forms
								const subs = raw.map(x => (typeof x === 'string') ? x : (x && x.subject ? x.subject : '')).filter(Boolean);
								const uniqSubs = Array.from(new Set(subs));
								if (uniqSubs.length === 0){ subjSel.innerHTML='<option value="">No subjects</option>'; modSel.innerHTML='<option value="">-</option>'; if (bankSel) bankSel.innerHTML='<option value="">-</option>'; return; }
								uniqSubs.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; subjSel.appendChild(o); });
								updateBanks();
							}
							function updateBanks(){
								if (!bankSel){ return updateModules(); }
								bankSel.innerHTML=''; modSel.innerHTML='';
								const u = uniSel.value; const s = subjSel.value;
								const raw = grouped[u] || [];
								const items = raw.filter(x=> (x && x.subject===s));
								if (items.length === 0){ bankSel.innerHTML='<option value="">No banks</option>'; modSel.innerHTML='<option value=\"\">-</option>'; return; }
								items.forEach(it=>{ const created = it.created_at? new Date(it.created_at).toLocaleString(): 'Unknown'; const label = `${s} ‚Ä¢ ${created}`; const o=document.createElement('option'); o.value=it.id; o.textContent=label; bankSel.appendChild(o); });
								updateModules();
							}
							async function updateModules(){
								modSel.innerHTML='';
								const u = uniSel.value; const s = subjSel.value; const b = bankSel? bankSel.value:'';
								if (!u || !s){ modSel.innerHTML='<option value="">-</option>'; return; }
								try{
									let url = '';
									if (b){ url = `/api/question-bank/modules?bank_id=${encodeURIComponent(b)}`; }
									else { url = `/api/question-bank/modules?university=${encodeURIComponent(u)}&subject=${encodeURIComponent(s)}`; }
									const modResponse = await fetch(url);
									const modResult = await modResponse.json();
									const modules = modResult.modules || [];
									if (modules.length === 0){ modSel.innerHTML = '<option value="">No modules</option>'; return; }
									modules.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; modSel.appendChild(o); });
								}catch(err){
									console.error('Failed to fetch modules:', err);
									modSel.innerHTML = '<option value="">Error loading modules</option>';
								}
							}
							uniSel.onchange = updateSubjects;
							subjSel.onchange = updateBanks;
							if (bankSel) bankSel.onchange = updateModules;
							// Initialize
							updateSubjects();
						});
					} catch(err) {
						console.error('Failed to fetch subjects:', err);
					}
				}

				function addModuleField(){
					const c = document.getElementById('qgModulesContainer');
					const idx = c.children.length + 1;
					const wrap = document.createElement('div');
					wrap.style.marginTop = '1rem';
					wrap.style.border = '1px solid #e5e7eb';
					wrap.style.borderRadius = '8px';
					wrap.style.padding = '1rem';
					wrap.style.background = '#f9fafb';
					const moduleId = `module_${idx}_${Date.now()}`;
					wrap.innerHTML = `
						<label style="display: block; margin-bottom: 0.5rem;"><strong>Module Name #${idx}</strong>
							<input type="text" class="qgModuleName" placeholder="e.g., Arrays" required style="margin-top: 0.25rem;">
						</label>
						<div style="margin-top: 0.75rem;">
							<div style="display: flex; gap: 0.5rem; border-bottom: 2px solid #e5e7eb; margin-bottom: 0.5rem;">
								<button type="button" class="qgTabBtn active" data-tab="plain" data-module="${moduleId}" style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid #667eea; margin-bottom: -2px;">üìù Plain Text</button>
								<button type="button" class="qgTabBtn" data-tab="json" data-module="${moduleId}" style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">üîß JSON</button>
							</div>
							<div id="${moduleId}_plain" class="qgTabContent" style="display: block;">
								<label style="display: block; margin-bottom: 0.5rem;"><strong>Paste Questions in Plain Text Format</strong>
									<textarea class="qgModulePlainText" rows="12" placeholder='Example formats:
Q: What is your name?
A: YELLOW
B: NORM
C: AYUSHMAN
D: YASH
Correct: C

Q: What is 2+2?
A) 3
B) 4
C) 5
D) 6
Answer: B

Q: Reverse a string
Description: Write code to reverse a string
Answer: function reverseString(s){return s.split("").reverse().join("")}

---
You can paste multiple questions. Separate them with blank lines or Q1, Q2, etc.' style="margin-top: 0.25rem;"></textarea>
								</label>
								<button type="button" class="btn secondary qgConvertBtn" data-module="${moduleId}" style="margin-top: 0.5rem;">üîÑ Convert to JSON</button>
								<div class="qgConvertStatus" data-module="${moduleId}" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
							</div>
							<div id="${moduleId}_json" class="qgTabContent" style="display: none;">
								<label style="display: block; margin-bottom: 0.5rem;"><strong>Questions JSON for this module</strong>
									<textarea class="qgModuleQuestions" rows="12" placeholder='Paste JSON array of questions' required style="margin-top: 0.25rem;"></textarea>
								</label>
							</div>
						</div>
					`;
					c.appendChild(wrap);
					
					// Wire up tab switching
					wrap.querySelectorAll('.qgTabBtn').forEach(btn => {
						btn.addEventListener('click', function(){
							const module = this.dataset.module;
							const tab = this.dataset.tab;
							wrap.querySelectorAll('.qgTabBtn').forEach(b => b.classList.remove('active'));
							wrap.querySelectorAll(`[id^="${module}_"]`).forEach(d => d.style.display = 'none');
							this.classList.add('active');
							document.getElementById(`${module}_${tab}`).style.display = 'block';
						});
					});
					
					// Wire up convert button
					const convertBtn = wrap.querySelector('.qgConvertBtn');
					if (convertBtn) {
						convertBtn.addEventListener('click', function(){
							const module = this.dataset.module;
							const plainText = wrap.querySelector('.qgModulePlainText')?.value || '';
							const jsonTextarea = wrap.querySelector('.qgModuleQuestions');
							const statusDiv = wrap.querySelector('.qgConvertStatus');
							
							try {
								const parsed = parsePlainTextQuestions(plainText);
								if (parsed.length === 0) {
									statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå No questions found. Check the format.</span>';
									return;
								}
								jsonTextarea.value = JSON.stringify(parsed, null, 2);
								statusDiv.innerHTML = `<span style="color: #10b981;">‚úÖ Converted ${parsed.length} question(s) successfully!</span>`;
								// Switch to JSON tab to show result
								wrap.querySelector('.qgTabBtn[data-tab="json"]').click();
							} catch(err) {
								statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${err.message}</span>`;
							}
						});
					}
				}
				
				function parsePlainTextQuestions(text){
					if (!text || !text.trim()) return [];
					// Normalize odd unicode spaces (EM/EN/NBSP) to simple space
					const normalizeSpaces = (s) => s.replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000]/g, ' ');
					const softTrim = (s) => normalizeSpaces(s || '').replace(/[\t ]+/g, ' ').trim();
					
					const questions = [];
					const rawLines = text.split('\n'); // keep blanks for code blocks
					
					let currentQ = null;
					let currentOptions = [];
					let descriptionLines = [];
					let inAnswerCode = false;
					
					const isQuestionStart = (line) => {
						const l = softTrim(line);
						return /^(?:Q(?:uestion)?\s*\d*|\d+)\s*[.:)]\s*/i.test(l);
					};
					const extractQuestionTitle = (line) => {
						const l = softTrim(line);
						const m = l.match(/^(?:Q(?:uestion)?\s*\d*|\d+)\s*[.:)]\s*(.+)$/i);
						return m ? m[1] : l.replace(/^Q\s*[:.-]?\s*/i,'');
					};
					const mapLabelToIndex = (label) => {
						if (!label) return -1;
						const s = String(label).trim();
						if (/^\d+$/.test(s)) return parseInt(s,10) - 1;
						const ch = s[0].toUpperCase();
						if (/[A-Z]/.test(ch)) return ch.charCodeAt(0) - 65;
						return -1;
					};
					const parseInlineOptions = (line) => {
						// Robust scanner: only treat label markers (a) a. a: 1) 1. 1:) as option starts
						// when preceded by start/space/comma/semicolon/pipe/dash (to avoid matching '3)' in 'np.eye(3)')
						const l = softTrim(line);
						const starts = [];
						for (let i = 0; i < l.length - 1; i++) {
							const ch = l[i];
							const next = l[i+1];
							const prev = i === 0 ? '' : l[i-1];
							const afterSep = l[i+2] || '';
							// Treat as an option label only when the separator is immediately followed by space
							if (/^[A-Za-z\d]$/.test(ch) && /[)\.:]/.test(next) && /\s/.test(afterSep)) {
								if (i === 0 || /[\s,;\|\-‚Äì‚Äî¬∑‚Ä¢]/.test(prev)) {
									starts.push({ label: ch, idx: i });
								}
							}
						}
						if (starts.length < 2) return null;
						const out = [];
						for (let i = 0; i < starts.length; i++) {
							const start = starts[i].idx + 2; // skip label and separator
							const end = i + 1 < starts.length ? starts[i+1].idx : l.length;
							let text = l.slice(start, end);
							// Trim common trailing delimiters
							text = softTrim(text.replace(/[\s,;]+$/g, ''));
							const slot = mapLabelToIndex(starts[i].label);
							if (slot >= 0 && text) out[slot] = text;
						}
						return out.filter(Boolean).length ? out : null;
					};
					
					for (let i=0; i<rawLines.length; i++){
						const raw = rawLines[i];
						const line = softTrim(raw);
						
						// New question starts
						if (isQuestionStart(line)){
							// finalize previous
							if (currentQ){
								currentQ.description = softTrim(descriptionLines.join(' ')) || currentQ.title;
								if (currentOptions.length) currentQ.options = currentOptions.slice();
								questions.push(currentQ);
							}
							currentQ = { type: 'mcq', title: extractQuestionTitle(line), description: '', options: [], correctOption: undefined };
							currentOptions = [];
							descriptionLines = [];
							inAnswerCode = false;
							continue;
						}
						
						if (!currentQ) continue; // ignore preamble
						
						// Inline options on a single line
						const inlineOpts = parseInlineOptions(line);
						if (inlineOpts){
							for (let k=0;k<inlineOpts.length;k++){
								if (inlineOpts[k]) currentOptions[k] = inlineOpts[k];
							}
							continue;
						}
						
						// Standard one-per-line option
						const mOpt = line.match(/^([A-Za-z\d])[:\).]\s*(.+)$/i);
						if (mOpt){
							const idx = mapLabelToIndex(mOpt[1]);
							if (idx >= 0) currentOptions[idx] = softTrim(mOpt[2]);
							continue;
						}
						
						// Answer line (either MCQ letter or coding answer start)
						const mAns = raw.match(/^(?:Answer|Correct|Right)\s*[:\. ]\s*(.*)$/i);
						if (mAns){
							const rest = mAns[1] || '';
							// Try letter/number first
							const mLetter = rest.match(/^\s*([A-Za-z\d])\)/) || rest.match(/^\s*([A-Za-z\d])\b/);
							if (mLetter){
								const idx = mapLabelToIndex(mLetter[1]);
								if (idx >= 0) currentQ.correctOption = idx;
								else {
									// maybe textual answer; try to match an option text
									const txt = softTrim(rest.replace(/^\s*([A-Za-z\d])\)?\s*/, ''));
									const found = (currentOptions || []).findIndex(o => softTrim(o).toLowerCase() === txt.toLowerCase());
									if (found >= 0) currentQ.correctOption = found;
								}
								continue;
							}
							// Treat as coding answer (multi-line)
							currentQ.type = 'coding';
							inAnswerCode = true;
							const after = raw.split(/^(?:Answer|Correct|Right)\s*[:\. ]/i)[1] || '';
							currentQ.answer = (currentQ.answer || '') + (after ? after + '\n' : '');
							continue;
						}
						
						// Keep collecting code lines when inAnswerCode
						if (inAnswerCode){
							currentQ.answer = (currentQ.answer || '') + raw + '\n';
							continue;
						}
						
					// Description fall-through
					if (line){
						descriptionLines.push(line);
						// Heuristic: detect hands-on questions
						if (!currentOptions.length && /^case\s+(title|study)|upload|file\s+upload|deliverable|submit.*file|\.zip|\.csv|project\s+file|attach.*file/i.test(line)){
							currentQ.type = 'hands_on';
						}
					// Heuristic: if no options appear at all, assume coding
					else if (!currentOptions.length && /code|function|write|implement|solve|algorithm|program|create/i.test(line)){
						currentQ.type = 'coding';
					}
				}
			}
			
			// finalize trailing question
					if (currentQ){
						currentQ.description = softTrim(descriptionLines.join(' ')) || currentQ.title;
						if (currentOptions.length) currentQ.options = currentOptions.slice();
						questions.push(currentQ);
					}
					
			// Normalize output
			return questions.map(q => {
				// Auto-detect hands-on questions based on keywords in title or description
				const fullText = `${q.title || ''} ${q.description || ''}`.toLowerCase();
				const isHandsOn = /^case\s+(title|study)|upload|file\s+upload|deliverable|submit.*file|\.zip|\.csv|\.pdf|\.docx|project\s+file|attach.*file|expected\s+deliverable/i.test(fullText);
				
				// Determine type: preserve explicit hands_on, or auto-detect, or use existing type, or infer from structure
				let finalType;
				if (q.type === 'hands_on' || q.type === 'handson') {
					finalType = 'hands_on';
				} else if (isHandsOn) {
					finalType = 'hands_on';
				} else if (q.type) {
					finalType = q.type;
				} else if (q.options && q.options.length) {
					finalType = 'mcq';
				} else {
					finalType = 'coding';
				}
				
				const normalized = {
					type: finalType,
					title: q.title || 'Untitled',
					description: q.description || q.title || '',
					options: q.options && q.options.length > 0 ? q.options.map(softTrim).filter(Boolean) : undefined,
					correctOption: Number.isInteger(q.correctOption) ? q.correctOption : undefined,
					answer: q.answer ? q.answer.replace(/\n+$/, '') : undefined,
					answerRegex: q.answerRegex || undefined
				};
					// If MCQ but still no correctOption and answer text exists, match by text
					if (normalized.type === 'mcq' && normalized.options && normalized.correctOption == null && normalized.answer){
						const txt = softTrim(normalized.answer);
						const found = normalized.options.findIndex(o => softTrim(o).toLowerCase() === txt.toLowerCase());
						if (found >= 0) normalized.correctOption = found;
						delete normalized.answer;
					}
					// If coding or hands-on, remove MCQ fields
					if (normalized.type === 'coding' || normalized.type === 'hands_on'){
						delete normalized.options;
						delete normalized.correctOption;
					}
					// If hands-on, remove coding fields
					if (normalized.type === 'hands_on'){
						delete normalized.answer;
						delete normalized.answerRegex;
					}
					return normalized;
				});
				}

				function clearQGForm(){
					document.getElementById('localQGForm').reset();
					document.getElementById('qgModulesContainer').innerHTML='';
				}

				async function onSaveSubject(e){
					e.preventDefault();
					const university = (document.getElementById('qgUniversity')?.value||'').trim();
					const subject = (document.getElementById('qgSubject')?.value||'').trim();
					if (!university){ alert('University is required'); return; }
					if (!subject){ alert('Subject is required'); return; }
					const moduleNames = Array.from(document.querySelectorAll('.qgModuleName')).map(i=>i.value.trim());
					const moduleJsons = Array.from(document.querySelectorAll('.qgModuleQuestions')).map(t=>t.value.trim());
					const modulePlainTexts = Array.from(document.querySelectorAll('.qgModulePlainText')).map(t=>t.value.trim());
					if (moduleNames.length === 0){ alert('Add at least one module'); return; }
					const modules = {};
					for (let i=0;i<moduleNames.length;i++){
						const name = moduleNames[i];
						if (!name){ alert(`Module #${i+1} name is required`); return; }
						let qs;
						// Prefer JSON textarea; if empty, try parsing the plain text textarea directly
						if (moduleJsons[i] && moduleJsons[i].length > 0) {
							try { qs = JSON.parse(moduleJsons[i]); } catch(err){ alert(`Module "${name}" has invalid JSON`); return; }
						} else if (modulePlainTexts[i] && modulePlainTexts[i].length > 0) {
							qs = parsePlainTextQuestions(modulePlainTexts[i]);
						} else {
							qs = [];
						}
					if (!Array.isArray(qs)){ alert(`Module "${name}" questions must be an array`); return; }
					const normalized = qs.map(q=>{
						// Preserve the original type if it's valid, otherwise default to coding
						let qType = q.type || 'coding';
						if (qType === 'hands_on' || qType === 'handson') qType = 'hands_on';
						else if (qType === 'mcq') qType = 'mcq';
						else qType = 'coding';
						
						return {
							id: q.id || uid(),
							type: qType,
							title: q.title || 'Untitled',
							description: q.description || '',
							options: Array.isArray(q.options) ? q.options : undefined,
							correctOption: Number.isInteger(q.correctOption) ? q.correctOption : undefined,
							answer: typeof q.answer === 'string' ? q.answer : undefined,
							answerRegex: typeof q.answerRegex === 'string' ? q.answerRegex : undefined
						};
					});
						modules[name] = normalized;
					}
					
					// Save to MongoDB
					try {
						const response = await fetch('/api/question-bank/save', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({ university, subject, modules })
						});
						const result = await response.json();
						if (result.ok) {
						alert('‚úÖ Saved to Question Bank (MongoDB)');
						// Keep admin on the same page; refresh subject/module selects
						try { renderSubjectModuleOptions(); } catch(_) {}
						// Optionally clear the form so admin can add another subject quickly
						try { clearQGForm(); addModuleField(); } catch(_) {}
						} else {
							alert(`‚ùå Error: ${result.error}`);
						}
					} catch(err) {
						alert(`‚ùå Failed to save: ${err.message}`);
					}
				}

				function buildAttemptView({mode, subject, moduleName, questions}){
					ensureContainers();
					const host = document.getElementById('localAttemptContainer');
					const list = document.getElementById('attemptQuestions');
					list.innerHTML = '';
					document.getElementById('attemptTitle').textContent = mode === 'classroom' ? 'Classroom Activity' : 'Test';
					document.getElementById('attemptMeta').textContent = `${subject} ‚Ä¢ ${moduleName} ‚Ä¢ ${questions.length} questions`;
					document.getElementById('attemptResult').innerHTML='';
					host.style.display = '';
					window.scrollTo({ top: host.offsetTop - 24, behavior: 'smooth' });

					questions.forEach((q, idx)=>{
						const card = document.createElement('div');
						card.className = 'card';
						card.innerHTML = `
							<h3 style="margin: 0 0 0.5rem 0;">Q${idx+1}. ${q.title}</h3>
							<p class="muted" style="margin: 0 0 0.5rem 0;">${q.description||''}</p>
							<div data-question-id="${q.id}">
								${q.type==='mcq' && Array.isArray(q.options) ? q.options.map((opt,i)=>`<label style='display:block; margin: 0.25rem 0;'><input type='radio' name='q_${q.id}' value='${i}'> ${opt}</label>`).join('') : `<textarea rows='6' style='width:100%;' name='q_${q.id}' placeholder='Write your answer here...'></textarea>`}
							</div>
						`;
						list.appendChild(card);
					});

					const cancelBtn = document.getElementById('attemptCancelBtn');
					// Note: Attempt submission removed - all submissions go through server-side endpoints
					// which store to MongoDB and validate against stored answers
					if (cancelBtn) cancelBtn.onclick = () => { document.getElementById('localAttemptContainer').style.display='none'; };
				}

				function normalize(s){ return (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase(); }
				
				// Note: Question generation is now handled server-side via MongoDB API endpoints
				// /api/question-bank/generate-activity and /api/question-bank/generate-test

				async function onCreateClassroom(e){
					e.preventDefault();
					const warning = document.getElementById('classroomWarning');
					warning.style.display='none'; warning.textContent='';
						const university = document.getElementById('classroomUniversity')?.value;
						const subject = document.getElementById('classroomSubject')?.value;
						const bankId = document.getElementById('classroomBank')?.value;
					const moduleName = document.getElementById('classroomModule')?.value;
					const numMcq = Math.max(0, parseInt(document.getElementById('classroomMcq')?.value||'0',10));
					const numCoding = Math.max(0, parseInt(document.getElementById('classroomCoding')?.value||'0',10));
					const numHandsOn = Math.max(0, parseInt(document.getElementById('classroomHandsOn')?.value||'0',10));
					const classroomId = (document.getElementById('classroomId')?.value||'').trim();
					
				if (!subject || !moduleName){ warning.style.display=''; warning.textContent='Please choose a subject and module.'; return; }
				if (numMcq === 0 && numCoding === 0 && numHandsOn === 0){ warning.style.display=''; warning.textContent='At least one question type must be selected.'; return; }
				if (!classroomId){ warning.style.display=''; warning.textContent='Classroom ID is required.'; return; }
					
					try {
						const response = await fetch('/api/question-bank/generate-activity', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({ university, subject, bank_id: bankId, module: moduleName, num_mcq: numMcq, num_coding: numCoding, num_hands_on: numHandsOn, classroom_id: classroomId })
						});
						const result = await response.json();
						if (result.ok) {
							alert(`‚úÖ Classroom Activity created!\nActivity ID: ${result.activity_id}\nClassroom ID: ${classroomId}\nQuestions: ${result.total}`);
							document.getElementById('createClassroomForm').reset();
							renderSubjectModuleOptions();
						} else {
							warning.style.display=''; warning.textContent=result.error || 'Failed to create activity';
						}
					} catch(err) {
						warning.style.display=''; warning.textContent=`Error: ${err.message}`;
					}
				}

				async function onCreateTest(e){
					e.preventDefault();
					const warning = document.getElementById('testWarning');
					warning.style.display='none'; warning.textContent='';
						const university = document.getElementById('testUniversity')?.value;
						const subject = document.getElementById('testSubject')?.value;
						const bankId = document.getElementById('testBank')?.value;
					const moduleName = document.getElementById('testModule')?.value;
					const numMcq = Math.max(0, parseInt(document.getElementById('testMcq')?.value||'0',10));
					const numCoding = Math.max(0, parseInt(document.getElementById('testCoding')?.value||'0',10));
					const numHandsOn = Math.max(0, parseInt(document.getElementById('testHandsOn')?.value||'0',10));
					const testId = (document.getElementById('testId')?.value||'').trim();
					const startTime = document.getElementById('testStart')?.value;
					const endTime = document.getElementById('testEnd')?.value;
					
				if (!subject || !moduleName){ warning.style.display=''; warning.textContent='Please choose a subject and module.'; return; }
				if (numMcq === 0 && numCoding === 0 && numHandsOn === 0){ warning.style.display=''; warning.textContent='At least one question type must be selected.'; return; }
				if (!testId){ warning.style.display=''; warning.textContent='Test ID is required.'; return; }
					if (!startTime || !endTime){ warning.style.display=''; warning.textContent='Start and end times are required.'; return; }
					
					try {
						const response = await fetch('/api/question-bank/generate-test', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({ university, subject, bank_id: bankId, module: moduleName, num_mcq: numMcq, num_coding: numCoding, num_hands_on: numHandsOn, test_id: testId, start_time: startTime, end_time: endTime })
						});
						const result = await response.json();
						if (result.ok) {
							alert(`‚úÖ Test created!\nTest ID: ${testId}\nQuestions: ${result.total}`);
							document.getElementById('createTestForm').reset();
							renderSubjectModuleOptions();
						} else {
							warning.style.display=''; warning.textContent=result.error || 'Failed to create test';
						}
					} catch(err) {
						warning.style.display=''; warning.textContent=`Error: ${err.message}`;
					}
				}

				function escapeCSV(s){
					const str = (s==null ? '' : String(s));
					if (/[,"\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
					return str;
				}

				function escapeHTML(s){
					return (s==null?'' : String(s)).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
				}

				function exportActivityCSV(activity){
					const rows = [['university','subject','module','type','title','description','options','correctOption','answer','answerRegex']];
					const university = activity.university || 'Unknown';
					Object.keys(activity.modules||{}).forEach(moduleName=>{
						(activity.modules[moduleName]||[]).forEach(q=>{
							rows.push([
								university,
								activity.subject,
								moduleName,
								q.type || 'unknown',
								q.title || '',
								q.description || '',
								Array.isArray(q.options) ? q.options.join(' | ') : '',
								Number.isInteger(q.correctOption) ? q.correctOption : '',
								q.answer || '',
								q.answerRegex || ''
							]);
						});
					});
					const csv = rows.map(r=>r.map(escapeCSV).join(',')).join('\n');
					const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url; a.download = `${university}_${activity.subject}_questions.csv`;
					document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
				}

				async function renderQMGroups(){
					const el = document.getElementById('qmGroups'); if (!el) return;
					
					try {
						const response = await fetch('/api/question-bank/all');
						const result = await response.json();
						if (!result.ok) {
							el.innerHTML = '<p class="muted">Error loading question banks.</p>';
							return;
						}
						
						const grouped = result.grouped || {};
						el.innerHTML = '';
						const universities = Object.keys(grouped).sort();
						if (!universities.length){ el.innerHTML = '<p class="muted">No question banks found.</p>'; return; }
						
						universities.forEach(u=>{
							const wrap = document.createElement('div');
							wrap.style.margin = '0.75rem 0';
							wrap.innerHTML = `<h3 style='margin:0 0 0.25rem 0;'>${u}</h3>`;
							const container = document.createElement('div'); container.style.display='grid'; container.style.gap='0.75rem';
							const entries = (grouped[u]||[]);
							// Group by subject
							const bySubject = {};
							entries.forEach(a=>{ a.university=u; const s=a.subject||'Unknown'; (bySubject[s]||(bySubject[s]=[])).push(a); });
							Object.keys(bySubject).sort().forEach(subject=>{
								const items = bySubject[subject];
								const a = items[0];
								const box = document.createElement('div');
								box.style.border='1px solid #e5e7eb'; box.style.borderRadius='8px'; box.style.padding='0.75rem';
								const createdAt = a.created_at ? new Date(a.created_at).toLocaleString() : 'Unknown';
								let html = `<div style='display:flex; align-items:center; justify-content:space-between;'>`+
									`<div><strong>${subject}</strong><div class='muted' style='font-size:0.85rem;'>Created: ${createdAt}</div></div>`+
									`<div style='display:flex; gap:0.5rem;'>`+
									`<button class='btn secondary' type='button' data-action='detail'>Details</button>`+
									`<button class='btn secondary' type='button' data-action='edit'>Edit</button>`+
									`<button class='btn secondary' type='button' data-action='export'>Export CSV</button>`+
									`<button class='btn secondary' type='button' data-action='delete'>Delete</button>`+
									`</div>`+
								`</div>`;
								// Modules list
								const moduleNames = Object.keys(a.modules||{});
								html += `<div style='margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem;'>`+
									(moduleNames.length? moduleNames.map(m=>`<span style='background:#f3f4f6; border:1px solid #e5e7eb; padding:0.25rem 0.5rem; border-radius:6px;'>${m}</span>`).join('') : `<span class='muted'>No modules</span>`) +
								`</div>`;
								box.innerHTML = html;
								const btns = box.querySelectorAll('button');
								btns.forEach(b=>{
									b.addEventListener('click', function(){
										const act = this.getAttribute('data-action');
										if (act==='detail') return renderQMDetail(a.id, a);
										if (act==='edit') return prefillQGForEdit(a);
										if (act==='export') return exportActivityCSV(a);
									if (act==='delete') return deleteActivity(a);
									});
								});
								container.appendChild(box);
							});
							wrap.appendChild(container);
							el.appendChild(wrap);
						});
					} catch(err) {
						el.innerHTML = '<p class="muted">Error loading question banks.</p>';
						console.error(err);
					}
				}

				function renderQMDetail(activityId, activityData){
					const container = document.getElementById('qmDetailContainer'); if (!container) return;
					const a = activityData;
					if (!a){ container.style.display='none'; container.innerHTML=''; return; }
					container.style.display='';
					// Extract university from grouped data or use 'Unknown'
					const university = a.university || 'Unknown';
					let html = `<div class='card'><h3 style='margin:0 0 0.5rem 0;'>${university} ‚Ä¢ ${a.subject}</h3>`;
					Object.keys(a.modules||{}).forEach(m=>{
						html += `<h4 style='margin:0.5rem 0;'>Module: ${m}</h4>`;
						(a.modules[m]||[]).forEach((q,idx)=>{
							html += `<div style='border:1px solid #e5e7eb; border-radius:6px; padding:0.5rem; margin:0.25rem 0;'>`+
								`<div><strong>Q${idx+1} (${q.type?.toUpperCase() || 'UNKNOWN'})</strong>: ${escapeHTML(q.title || 'Untitled')}</div>`+
								`<div class='muted' style='font-size:0.9rem;'>${escapeHTML(q.description||'')}</div>`+
								`${q.type==='mcq' && Array.isArray(q.options) ? `<div style='margin-top:0.25rem;'>Options: ${q.options.map((o,i)=> i===q.correctOption?`<strong>${escapeHTML(o)}</strong>`:escapeHTML(o)).join(' | ')}</div>` : ''}`+
								`${q.type!=='mcq' && (q.answer||q.answerRegex) ? `<div style='margin-top:0.25rem;'>Answer: <code>${escapeHTML(q.answer||q.answerRegex)}</code></div>` : ''}`+
								`</div>`;
						});
					});
					html += `</div>`;
					container.innerHTML = html;
				}

				function prefillQGForEdit(activityData){
					const a = activityData;
					if (!a) return;
					window.scrollTo({ top: 0, behavior: 'smooth' });
					const uni = document.getElementById('qgUniversity'); 
					const subj = document.getElementById('qgSubject');
					const university = a.university || 'Unknown';
					if (uni) uni.value = university; 
					if (subj) subj.value = a.subject;
					document.getElementById('qgModulesContainer').innerHTML='';
					Object.keys(a.modules||{}).forEach((m)=>{
						addModuleField();
						const wraps = document.querySelectorAll('#qgModulesContainer > div');
						const current = wraps[wraps.length-1];
						current.querySelector('.qgModuleName').value = m;
						current.querySelector('.qgModuleQuestions').value = JSON.stringify(a.modules[m], null, 2);
					});
					let delBtn = document.getElementById('qgDeleteActivityBtn');
					if (!delBtn){
						delBtn = document.createElement('button'); delBtn.id='qgDeleteActivityBtn'; delBtn.className='btn secondary'; delBtn.type='button'; delBtn.textContent='Delete This Question Bank';
						document.getElementById('qgSubmitBankBtn')?.parentElement?.appendChild(delBtn);
					}
					delBtn.onclick = async function(){ 
						await deleteActivity(a.subject, a); 
					};
				}

				async function deleteActivity(activityData){
					if (!confirm('Delete this question bank?')) return;
					const bankId = activityData.id;
					try {
						const response = await fetch('/api/question-bank/delete', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({ bank_id: bankId })
						});
						const result = await response.json();
						if (result.ok) {
							alert('‚úÖ Question bank deleted successfully');
							renderSubjectModuleOptions();
							renderQMGroups();
							document.getElementById('qmDetailContainer').style.display='none';
						} else {
							alert(`‚ùå Error: ${result.error}`);
						}
					} catch(err) {
						alert(`‚ùå Failed to delete: ${err.message}`);
					}
				}

				// renderLogs removed from this page; view submissions/logs available in dedicated admin pages

				// Export all functions to global scope for use in views
				window.QuestionBankModule = {
					addModuleField,
					clearQGForm,
					onSaveSubject,
					renderSubjectModuleOptions,
					onCreateClassroom,
					onCreateTest,
					renderQMGroups,
					deleteActivity,
					exportActivityCSV
				};

				// Initialize on every page load
				function initQuestionBankUI(){
					// Wire Question Generator form
					const addModuleBtn = document.getElementById('qgAddModuleBtn');
					if (addModuleBtn){ 
						addModuleBtn.addEventListener('click', function(e){ 
							e.preventDefault(); 
							addModuleField(); 
						}); 
					}
					const clearBtn = document.getElementById('qgClearAllBtn');
					if (clearBtn){ clearBtn.addEventListener('click', function(){ clearQGForm(); }); }
					const saveBtn = document.getElementById('qgSubmitBankBtn');
					if (saveBtn){ saveBtn.addEventListener('click', onSaveSubject); }
					const modulesContainer = document.getElementById('qgModulesContainer');
					if (modulesContainer && modulesContainer.children.length === 0) {
						addModuleField();
					}

					// Wire Create Classroom/Test forms
					const classroomForm = document.getElementById('createClassroomForm');
					if (classroomForm){ classroomForm.addEventListener('submit', onCreateClassroom); }
					const testForm = document.getElementById('createTestForm');
					if (testForm){ testForm.addEventListener('submit', onCreateTest); }

					// Only load subject/module options on admin pages where these forms exist
					const needsQBData = document.getElementById('qgModulesContainer') || document.getElementById('createClassroomForm') || document.getElementById('createTestForm') || document.getElementById('qmGroups');
					if (needsQBData) {
						renderSubjectModuleOptions();
					}
					// If on Questionnaire Management page, render groups
					if (document.getElementById('qmGroups')) {
						renderQMGroups();
					}
				}

				// Run on DOMContentLoaded
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initQuestionBankUI);
				} else {
					// DOM already loaded (in case this script runs after page load)
			initQuestionBankUI();
		}
	})();
	</script>
</body>
</html>
